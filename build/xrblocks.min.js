import*as t from"three";import{Pass as e,FullScreenQuad as i}from"three/addons/postprocessing/Pass.js";import{XRControllerModelFactory as s}from"three/addons/webxr/XRControllerModelFactory.js";import{XRHandModelFactory as n}from"three/addons/webxr/XRHandModelFactory.js";import{XREstimatedLight as r}from"three/addons/webxr/XREstimatedLight.js";import{GLTFLoader as o}from"three/addons/loaders/GLTFLoader.js";import{SVGLoader as a}from"three/addons/loaders/SVGLoader.js";import{DRACOLoader as h}from"three/addons/loaders/DRACOLoader.js";import{KTX2Loader as l}from"three/addons/loaders/KTX2Loader.js";import*as c from"three/addons/utils/BufferGeometryUtils.js";class d{constructor(t="You are a helpful assistant."){this.instructions=t}get instruction(){return this.instructions}build(t,e){const i=t.getShortTerm().map((t=>this.formatEntry(t))).join("\n"),s=e.map((t=>`- ${t.name}: ${t.description}`)).join("\n");return`${this.instructions} You have access to the following tools: ${s}\n        Current Conversation history: ${i}. You should reply to the user or call a tool as needed.`}formatEntry(t){switch(t.role){case"user":return`User: ${t.content}`;case"ai":return`AI: ${t.content}`;case"tool":return`Tool Output: ${t.content}`}}}class u{constructor(){this.shortTermMemory=[]}addShortTerm(t){this.shortTermMemory.push(t)}getShortTerm(){return[...this.shortTermMemory]}clear(){this.shortTermMemory.length=0}}class p{static{this.dependencies={}}constructor(t,e=[],i=""){this.ai=t,this.tools=e,this.memory=new u,this.contextBuilder=new d(i)}async start(t){return this.memory.addShortTerm({role:"user",content:t}),this.ai.isAvailable()||await this.ai.init({aiOptions:this.ai.options}),this.run()}async run(){for(;;){const t=this.contextBuilder.build(this.memory,this.tools),e=await this.ai.model.query({type:"text",text:t},this.tools);if(this.memory.addShortTerm({role:"ai",content:JSON.stringify(e)}),!e?.toolCall){if(e?.text)return console.log(`Final Response: ${e.text}`),e.text;{const t="The AI did not provide a valid response.";return console.error(t),t}}{console.log(`Executing tool: ${e.toolCall.name}`);const t=this.findTool(e.toolCall.name);if(t){const i=await t.execute(e.toolCall.args);this.memory.addShortTerm({role:"tool",content:JSON.stringify(i)})}else{const t=`Error: Tool "${e.toolCall.name}" not found.`;console.error(t),this.memory.addShortTerm({role:"tool",content:t})}}}}findTool(t){return this.tools.find((e=>e.name===t))}}class g{constructor(t){this.name=t.name,this.description=t.description,this.parameters=t.parameters||{},this.onTriggered=t.onTriggered}execute(t){if(this.onTriggered)return this.onTriggered(t);throw new Error("The execute method must be implemented by a subclass or onTriggered must be provided.")}toJSON(){const t={name:this.name};return this.description&&(t.description=this.description),this.parameters&&this.parameters.required&&(t.parameters=this.parameters),t}}class m extends g{constructor(t,e){super({name:"generateSkybox",description:"Generate a 360 equirectangular skybox image for the given prompt.",parameters:{type:"OBJECT",properties:{prompt:{type:"STRING",description:'A description of the skybox to generate, e.g. "a sunny beach with palm trees"'}},required:["prompt"]}}),this.ai=t,this.scene=e}async execute(e){try{const i=await this.ai.generate("Generate a 360 equirectangular skybox image for the prompt of:"+e.prompt,"image","Generate a 360 equirectangular skybox image for the prompt","gemini-2.5-flash-image-preview");return i?(console.log("Applying texture..."),this.scene.background=(new t.TextureLoader).load(i),this.scene.background.mapping=t.EquirectangularReflectionMapping,"Skybox generated successfully."):"Sorry, I had trouble creating that skybox."}catch(t){return console.error("error:",t),"Sorry, I encountered an error while creating the skybox."}}}class f extends p{constructor(t,e,i){super(t,[new m(t,i)],"You are a friendly and helpful skybox designer. The response should be short. Your only capability\n         is to generate a 360-degree equirectangular skybox image based on\n         a user's description. You will generate a default skybox if the user\n         does not provide any description. You will use the tool 'generateSkybox'\n         with the summarized description as the 'prompt' argument to create the skybox."),this.sound=e}async startLiveSession(t){this.ai.setLiveCallbacks(t);const e=this.tools.map((t=>t.toJSON())),i={parts:[{text:this.contextBuilder.instruction}]};await this.ai.startLiveSession({tools:e,systemInstruction:i}),this.sound.enableAudio()}async stopLiveSession(){await this.ai.stopLiveSession(),this.sound.disableAudio()}async sendToolResponse(t){console.log("Sending tool response:",t),this.ai.sendToolResponse(t)}}class v extends g{constructor(){super({name:"get_weather",description:"Gets the current weather for a specific location.",parameters:{type:"OBJECT",properties:{location:{type:"STRING",description:"The city and state, e.g. San Francisco, CA"},unit:{type:"STRING",enum:["celsius","fahrenheit"]}},required:["location"]}})}async execute(t){t.latitude&&t.longitude||(t.latitude=37.7749,t.longitude=-122.4194);const e=`https://api.open-meteo.com/v1/forecast?latitude=${t.latitude}&longitude=${t.longitude}&current=weather_code,temperature_2m&temperature_unit=fahrenheit`;try{const t=await fetch(e),i=await t.json();return t.ok?{temperature:i.current.temperature_2m,weathercode:i.current.weather_code}:{error:"Could not retrieve weather for the specified location."}}catch(t){return console.error("Error fetching weather:",t),{error:"There was an error fetching the weather."}}}}class y{constructor(e){this.draggable=!1,this.selectable=!1,this.touchable=!1,this.selected=[],this.hovered=[],this.touched=[],this.activeDragged=[],this.positions=[],this.distances=[],this.uvs=[],this.initialPosition=new t.Vector3,this.parent=e}isHovered(){return this.hovered.includes(!0)}isSelected(){return this.selected.includes(!0)}isDragging(){return this.activeDragged.includes(!0)}update(t,e){const i=t.userData.id;this.initializeVariablesForId(i),e.object!==this.parent&&e.object!==this.parent.mesh||(this.hovered[i]=!0,this.selected[i]=t.userData.selected,e.uv&&this.uvs[i].copy(e.uv),this.positions[i].copy(e.point),this.distances[i]=e.distance,this.selected[i]||(this.activeDragged[i]=!1))}initializeVariablesForId(e){for(;this.selected.length<=e;)this.selected.push(!1),this.hovered.push(!1),this.activeDragged.push(!1),this.positions.push(new t.Vector3),this.distances.push(1),this.uvs.push(new t.Vector2)}reset(){for(const t in this.selected)this.selected[t]=!1,this.hovered[t]=!1}getPrimaryTwoControllerIds(){const t=[];if(this.hovered)for(let e=0;e<this.hovered.length&&t.length<2;++e)this.hovered[e]&&t.push(e);return[t[0]??null,t[1]??null]}}function w(t){return class extends t{constructor(){super(...arguments),this.ux=new y(this),this.isXRScript=!0}init(t){}update(t,e){}initPhysics(t){}physicsStep(){}onXRSessionStarted(t){}onXRSessionEnded(){}onSimulatorStarted(){}onSelectStart(t){}onSelectEnd(t){}onSelect(t){}onSelecting(t){}onKeyDown(t){}onKeyUp(t){}onSqueezeStart(t){}onSqueezeEnd(t){}onSqueezing(t){}onSqueeze(t){}onObjectSelectStart(t){return!1}onObjectSelectEnd(t){return!1}onHoverEnter(t){}onHoverExit(t){}onHovering(t){}onObjectTouchStart(t){}onObjectTouching(t){}onObjectTouchEnd(t){}onObjectGrabStart(t){}onObjectGrabbing(t){}onObjectGrabEnd(t){}dispose(){}}}const x=w(t.Object3D);class S extends x{}const b=w(t.Mesh);class C extends b{constructor(t,e){super(t,e)}}function T(t,e,i){return Math.min(Math.max(t,e),i)}function R(t,e,i){return t+(e-t)*i}function M(...t){console.log("*",...t)}const D=new URLSearchParams(window.location.search);function E(t){return new URLSearchParams(window.location.search).get(t)}function _(t,e=!1){const i=D.get(t)?.toLowerCase();return"true"===i||"1"===i||"false"!==i&&"0"!==i&&e}function P(t,e=0){const i=D.get(t);if(i){const t=parseInt(i,10);if(!isNaN(t))return t}return e}function O(t,e=0){const i=D.get(t);if(i){const t=parseFloat(i);if(!isNaN(t))return t}return e}function A(e){if("string"!=typeof e)throw new Error("colorString must be a string");const i=e.startsWith("#")?e.slice(1):e,s=i.length;let n=1,r=i;if(3!==s&&4!==s||(r=i.split("").map((t=>t+t)).join("")),8===r.length)n=parseInt(r.slice(6,8),16)/255,r=r.slice(0,6);else if(6!==r.length)throw new Error(`Invalid hex color string format: ${e}`);const o=parseInt(r.slice(0,2),16)/255,a=parseInt(r.slice(2,4),16)/255,h=parseInt(r.slice(4,6),16)/255;if(isNaN(o)||isNaN(a)||isNaN(h)||isNaN(n))throw new Error(`Invalid hex values in color string: ${e}`);return new t.Vector4(o,a,h,n)}function I(t){if("string"==typeof t){const e=A(t);return(Math.round(255*e.x)<<16)+(Math.round(255*e.y)<<8)+Math.round(255*e.z)}return"number"==typeof t?t:16777215}function L(t){const e=t.match(/^data:(image\/[a-zA-Z0-9\-+.]+);base64,/);if(e){const i=e[1];return{strippedBase64:t.substring(e[0].length),mimeType:i}}return{strippedBase64:t,mimeType:null}}class V{constructor(){this.apiKey="",this.urlParam="geminiKey",this.keyValid=!1,this.enabled=!1,this.model="gemini-2.0-flash",this.config={},this.live={enabled:!1,model:"gemini-live-2.5-flash-preview",voiceName:"Aoede",screenshotInterval:3e3,audioConfig:{sampleRate:16e3,channelCount:1,echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}}}}class B{constructor(){this.apiKey="",this.urlParam="openaiKey",this.model="gpt-4.1",this.enabled=!1}}class F{constructor(){this.enabled=!1,this.model="gemini",this.gemini=new V,this.openai=new B,this.globalUrlParams={key:"key"}}}class z{constructor(){}}let j,k,U,N,G,H;class W extends z{constructor(t){super(),this.options=t,this.inited=!1,this.isLiveMode=!1,this.liveCallbacks={}}async init(){await async function(){if(!U)try{const t=await import("@google/genai");if(!t||!t.GoogleGenAI)throw new Error("'@google/genai' module loaded but is not valid.");j=t.createPartFromUri,k=t.createUserContent,U=t.GoogleGenAI,N=t.EndSensitivity,G=t.StartSensitivity,H=t.Modality,console.log("'@google/genai' module loaded successfully.")}catch(t){const e=`The '@google/genai' module is required for Gemini but failed to load. Error: ${t}`;throw console.error(e),new Error(e)}}()}isAvailable(){return!!U&&(this.inited||(this.ai=new U({apiKey:this.options.apiKey}),this.inited=!0),!0)}isLiveAvailable(){return this.isAvailable()&&N&&G&&H}async startLiveSession(t={}){if(!this.isLiveAvailable())throw new Error("Live API not available. Make sure @google/genai module is loaded.");if(this.liveSession)return this.liveSession;const e={responseModalities:[H.AUDIO],speechConfig:{voiceConfig:{prebuiltVoiceConfig:{voiceName:"Aoede"}}},outputAudioTranscription:{},inputAudioTranscription:{}};t.tools&&t.tools.length>0&&(e.tools=[{functionDeclarations:t.tools}]),t.systemInstruction&&("string"==typeof t.systemInstruction?e.systemInstruction=k(t.systemInstruction):e.systemInstruction=t.systemInstruction);const i={onopen:()=>{this.isLiveMode=!0,console.log("🔓 Live session opened."),this.liveCallbacks?.onopen&&this.liveCallbacks.onopen()},onmessage:t=>{this.liveCallbacks?.onmessage&&this.liveCallbacks.onmessage(t)},onerror:t=>{console.error("❌ Live session error:",t),this.liveCallbacks?.onerror&&this.liveCallbacks.onerror(t)},onclose:t=>{this.isLiveMode=!1,this.liveSession=void 0,t.reason?console.warn("🔒 Live session closed:",t):console.warn("🔒 Live session closed without reason."),this.liveCallbacks?.onclose&&this.liveCallbacks.onclose(t)}};try{const t={model:"gemini-2.5-flash-preview-native-audio-dialog",callbacks:i,config:e};return console.log("Connecting with params:",t),this.liveSession=await this.ai.live.connect(t),this.liveSession}catch(t){throw console.error("❌ Failed to start live session:",t),t}}async stopLiveSession(){this.liveSession&&(this.liveSession.close(),this.liveSession=void 0,this.isLiveMode=!1)}setLiveCallbacks(t){this.liveCallbacks=t}sendToolResponse(t){this.liveSession&&(console.log("Sending tool response from gemini:",t),this.liveSession.sendToolResponse(t))}sendRealtimeInput(t){if(this.liveSession)try{this.liveSession.sendRealtimeInput(t)}catch(t){throw console.error("❌ Error sending realtime input:",t),t}}getLiveSessionStatus(){return{isActive:this.isLiveMode,hasSession:!!this.liveSession,isAvailable:this.isLiveAvailable()}}async query(t,e=[]){if(!this.inited)return console.warn("Gemini not inited."),null;const i=this.options,s=i.config||{};if(!("type"in t)){return{text:(await this.ai.models.generateContent({model:i.model,contents:t.prompt,config:s})).text||null}}const n=this.ai.models,r={model:this.options.model,contents:[],config:this.options.config||{}};let o=null;switch(t.type){case"text":r.contents=t.text,o=await n.generateContent(r);break;case"base64":t.mimeType||(t.mimeType="image/png"),r.contents={inlineData:{mimeType:t.mimeType,data:t.base64}},o=await n.generateContent(r);break;case"uri":r.contents=k([j(t.uri,t.mimeType),t.text]),o=await n.generateContent(r);break;case"multiPart":r.contents=[{role:"user",parts:t.parts}],o=await n.generateContent(r)}if(!o)return{text:null};const a=o.functionCalls?.[0];return a&&a.name?{toolCall:{name:a.name,args:a.args}}:{text:o.text||null}}async generate(t,e="image",i="Generate an image",s="gemini-2.5-flash-image-preview"){if(!this.isAvailable())return;let n;n=Array.isArray(t)?t.map((t=>{if("string"==typeof t){if(t.startsWith("data:image/")){const[e,i]=t.split(",");return{inlineData:{mimeType:e.split(";")[0].split(":")[1],data:i}}}return{text:t}}return t})):t;const r=await this.ai.models.generateContent({model:s,contents:n,config:{systemInstruction:i}});if(r.candidates&&r.candidates.length>0){const t=r.candidates[0];for(const i of t?.content?.parts||[])if("image"===e&&i.inlineData)return"data:image/png;base64,"+i.inlineData.data}}}let q=null;class X extends z{constructor(t){super(),this.options=t}async init(){await async function(){if(!q)try{const t=await import("openai");q=t.default,console.log("'openai' module loaded successfully.")}catch(t){console.warn("'openai' module not found. Using fallback implementations.","Error details:",t)}}(),this.options.apiKey&&q?(this.openai=new q({apiKey:this.options.apiKey,dangerouslyAllowBrowser:!0}),console.log("OpenAI model initialized")):console.error("OpenAI API key is missing or module failed to load.")}isAvailable(){return!!this.openai}async query(t,e){if(!this.isAvailable())throw new Error("OpenAI model is not initialized.");try{const e=(await this.openai.chat.completions.create({messages:[{role:"user",content:t.prompt}],model:this.options.model})).choices[0].message.content;return e?{text:e}:null}catch(t){throw console.error("Error querying OpenAI:",t),t}}async generate(){throw new Error("Wrapper not implemented")}}const K={gemini:W,openai:X};class $ extends S{constructor(){super(...arguments),this.lock=!1}static{this.dependencies={aiOptions:F}}async loadKeysFromFile(){if(this.keysCache)return this.keysCache;try{const t=await fetch("./keys.json");if(t.ok)return this.keysCache=await t.json(),console.log("🔑 Loaded keys.json"),this.keysCache}catch{}return null}async init({aiOptions:t}){if(this.lock=!1,this.options=t,!t.enabled)return void console.log("AI is disabled in options");const e=t.model,i=K[e];if(i){const s=t[e];s&&s.enabled?await this.initializeModel(i,s):console.log(`${e} is disabled in AI options`)}else console.error(`Unsupported AI model: ${e}`)}async initializeModel(t,e){const i=await this.resolveApiKey(e);if(i&&this.isValidApiKey(i)){e.apiKey=i,this.model=new t(e);try{await this.model.init(),console.log(`${this.options.model} initialized`)}catch(t){console.error(`Failed to initialize ${this.options.model}:`,t),this.model=void 0}}else console.error(`No valid API key found for ${this.options.model}`)}async resolveApiKey(t){const e=this.options.model;if(t.apiKey)return t.apiKey;const i=E("key");if(i)return i;const s=E(t.urlParam);if(s)return s;const n=E("geminiKey64");if(n)return window.atob(n);const r=await this.loadKeysFromFile();if(r){const t=e+"ApiKey";let i=null;if("object"==typeof r[e]?i=r[e]?.apiKey:"string"==typeof r[t]?i=r[t]:"string"==typeof r[e]&&(i=r[e]),i)return console.log(`🔑 Using ${e} key from keys.json`),i}return null}isValidApiKey(t){return t&&"string"==typeof t&&t.length>0}isAvailable(){return this.model&&this.model.isAvailable()&&!this.lock}async query(t,e){if(!this.isAvailable())throw new Error("AI is not available. Check if it's enabled and properly initialized.");return await this.model.query(t,e)}async startLiveSession(t={}){if(!this.model)throw new Error("AI model is not initialized.");if(!("isLiveAvailable"in this.model)||!this.model.isLiveAvailable())throw new Error("Live session is not available for the current model.");this.lock=!0;try{return await this.model.startLiveSession(t)}catch(t){throw this.lock=!1,console.error("❌ Failed to start Live session:",t),t}}async stopLiveSession(){if(this.model)try{await("stopLiveSession"in this.model&&this.model.stopLiveSession())}catch(t){console.error("❌ Error stopping Live session:",t)}finally{this.lock=!1}}async setLiveCallbacks(t){this.model&&"setLiveCallbacks"in this.model&&this.model.setLiveCallbacks(t)}sendToolResponse(t){this.model&&"sendToolResponse"in this.model&&this.model.sendToolResponse(t)}sendRealtimeInput(t){return!(!this.model||!("sendRealtimeInput"in this.model))&&this.model.sendRealtimeInput(t)}getLiveSessionStatus(){return this.model&&"getLiveSessionStatus"in this.model?this.model.getLiveSessionStatus():{isActive:!1,hasSession:!1,isAvailable:!1}}isLiveAvailable(){return this.model&&"isLiveAvailable"in this.model&&this.model.isLiveAvailable()}triggerKeyPopup(){}async generate(t,e="image",i="Generate an image",s="gemini-2.5-flash-image-preview"){return this.model.generate(t,e,i,s)}static createSampleKeysStructure(){return{gemini:{apiKey:"YOUR_GEMINI_API_KEY_HERE"},openai:{apiKey:"YOUR_OPENAI_API_KEY_HERE"}}}async hasApiKey(){if(!this.options)return!1;const t=this.options[this.options.model];if(!t)return!1;const e=await this.resolveApiKey(t);return e&&this.isValidApiKey(e)}}const Q=2,Y=25,J=[[1,2],[2,3],[3,4],[5,6],[6,7],[7,8],[8,9],[10,11],[11,12],[12,13],[13,14],[15,16],[16,17],[17,18],[18,19],[20,21],[21,22],[22,23],[23,24]],Z=[[0,1],[1,2],[3,4],[4,5],[5,6],[7,8],[8,9],[9,10],[11,12],[12,13],[13,14],[15,16],[16,17],[17,18]],tt=.002,et=1,it=2,st=3,nt=4,rt=1280,ot=720,at="https://cdn.jsdelivr.net/gh/xrblocks/assets@34228db7ec7cef66fd65ef3250ef6f4a930fe373/";function ht(t){return Object.freeze(t),Object.getOwnPropertyNames(t).forEach((e=>{const i=t[e];i&&"object"==typeof i&&!Object.isFrozen(i)&&ht(i)})),t}function lt(t,e){if(null==e)return t;const i=t;for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t)){const s=i[t],n=e[t];s&&"object"==typeof s&&n&&"object"==typeof n?lt(s,n):i[t]=n}}class ct{constructor(t){this.enabled=!1,this.willCaptureFrequently=!1,lt(this,t)}}const dt={enabled:!0,videoConstraints:{width:{ideal:1280},height:{ideal:720}}},ut=ht(new ct({...dt,videoConstraints:{...dt.videoConstraints,facingMode:"environment"}})),pt=ht(new ct({...dt,videoConstraints:{...dt.videoConstraints,facingMode:"user"}})),gt=ht(new ct({...ut,willCaptureFrequently:!0})),mt=ht(new ct({...pt,willCaptureFrequently:!0}));function ft(){return!/Mobi|Linux|Android|iPhone/i.test(navigator.userAgent)}const vt={vertexShader:"\nvarying vec3 vNormal;\nvarying vec3 vViewPosition;\nvarying vec2 vUv;\n\nvoid main() {\n  vUv = uv;\n  vNormal = normal;\n\n  // Computes the view position.\n  vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);\n  vViewPosition = -mvPosition.xyz;\n\n  gl_Position = projectionMatrix * mvPosition;\n}\n",fragmentShader:"\n#include <packing>\n\nuniform vec3 uColor;\nuniform sampler2D uDepthTexture;\nuniform vec3 uLightDirection;\nuniform vec2 uResolution;\nuniform float uRawValueToMeters;\n\nvarying vec3 vNormal;\nvarying vec3 vViewPosition;\nvarying vec2 vUv;\n\nconst highp float kMaxDepthInMeters = 8.0;\nconst float kInvalidDepthThreshold = 0.01;\nuniform float uMinDepth;\nuniform float uMaxDepth;\nuniform float uDebug;\nuniform float uOpacity;\nuniform bool uUsingFloatDepth;\n\nfloat saturate(in float x) {\n  return clamp(x, 0.0, 1.0);\n}\n\nvec3 TurboColormap(in float x) {\n  const vec4 kRedVec4 = vec4(0.55305649, 3.00913185, -5.46192616, -11.11819092);\n  const vec4 kGreenVec4 = vec4(0.16207513, 0.17712472, 15.24091500, -36.50657960);\n  const vec4 kBlueVec4 = vec4(-0.05195877, 5.18000081, -30.94853351, 81.96403246);\n  const vec2 kRedVec2 = vec2(27.81927491, -14.87899417);\n  const vec2 kGreenVec2 = vec2(25.95549545, -5.02738237);\n  const vec2 kBlueVec2 = vec2(-86.53476570, 30.23299484);\n\n  // Adjusts color space via 6 degree poly interpolation to avoid pure red.\n  vec4 v4 = vec4( 1.0, x, x * x, x * x * x);\n  vec2 v2 = v4.zw * v4.z;\n  return vec3(\n    dot(v4, kRedVec4)   + dot(v2, kRedVec2),\n    dot(v4, kGreenVec4) + dot(v2, kGreenVec2),\n    dot(v4, kBlueVec4)  + dot(v2, kBlueVec2)\n  );\n}\n\n// Depth is packed into the luminance and alpha components of its texture.\n// The texture is in a normalized format, storing raw values that need to be\n// converted to meters.\nfloat DepthGetMeters(in sampler2D depth_texture, in vec2 depth_uv) {\n  if (uUsingFloatDepth) {\n    return texture2D(depth_texture, depth_uv).r * uRawValueToMeters;\n  }\n  vec2 packedDepthAndVisibility = texture2D(depth_texture, depth_uv).rg;\n  return dot(packedDepthAndVisibility, vec2(255.0, 256.0 * 255.0)) * uRawValueToMeters;\n}\n\nvec3 DepthGetColorVisualization(in float x) {\n  return step(kInvalidDepthThreshold, x) * TurboColormap(x);\n}\n\nvoid main() {\n  vec3 lightDirection = normalize(uLightDirection);\n\n  // Compute UV coordinates relative to resolution\n  // vec2 uv = gl_FragCoord.xy / uResolution;\n  vec2 uv = vUv;\n\n  // Ambient, diffuse, and specular terms\n  vec3 ambient = 0.1 * uColor;\n  float diff = max(dot(vNormal, lightDirection), 0.0);\n  vec3 diffuse = diff * uColor;\n\n  vec3 viewDir = normalize(vViewPosition);\n  vec3 reflectDir = reflect(-lightDirection, vNormal);\n  float spec = pow(max(dot(viewDir, reflectDir), 0.0), 16.0);\n  vec3 specular = vec3(0.5) * spec; // Adjust specular color/strength\n\n  // Combine Phong lighting\n  vec3 finalColor = ambient + diffuse + specular;\n  // finalColor = vec3(vNormal);\n\n  // Output color\n  gl_FragColor = uOpacity * vec4(finalColor, 1.0);\n\n  if (uDebug > 0.5) {\n    return;\n  }\n\n  vec2 depth_uv = uv;\n  depth_uv.y = 1.0 - depth_uv.y;\n\n  float depth = DepthGetMeters(uDepthTexture, depth_uv) * 8.0;\n  float normalized_depth =\n    saturate((depth - uMinDepth) / (uMaxDepth - uMinDepth));\n  gl_FragColor = uOpacity * vec4(TurboColormap(normalized_depth), 1.0);\n}\n"};class yt extends C{static{this.dependencies={camera:t.Camera,renderer:t.WebGLRenderer}}static{this.isDepthMesh=!0}constructor(e,i,s,n){const r=e.depthMesh,o=new t.PlaneGeometry(1,1,159,159);let a,h;r.useDepthTexture||r.showDebugTexture?(h={uDepthTexture:{value:null},uColor:{value:new t.Color(11184810)},uResolution:{value:new t.Vector2(i,s)},uRawValueToMeters:{value:1},uMinDepth:{value:0},uMaxDepth:{value:8},uOpacity:{value:r.opacity},uDebug:{value:r.showDebugTexture?1:0},uLightDirection:{value:new t.Vector3(1,1,1).normalize()},uUsingFloatDepth:{value:e.useFloat32}},a=new t.ShaderMaterial({uniforms:h,vertexShader:vt.vertexShader,fragmentShader:vt.fragmentShader,side:t.FrontSide,transparent:!0})):(a=new t.ShadowMaterial({opacity:r.shadowOpacity}),a.depthWrite=!1),super(o,a),this.depthOptions=e,this.depthTextures=n,this.ignoreReticleRaycast=!1,this.worldPosition=new t.Vector3,this.worldQuaternion=new t.Quaternion,this.updateVertexNormals=!1,this.minDepth=8,this.maxDepth=0,this.minDepthPrev=8,this.maxDepthPrev=0,this.colliders=[],this.projectionMatrixInverse=new t.Matrix4,this.lastColliderUpdateTime=0,this.colliderId=0,this.visible=r.showDebugTexture||r.renderShadow,this.options=r,this.projectionMatrixInverse=new t.Matrix4,this.lastColliderUpdateTime=performance.now(),this.updateVertexNormals=r.updateVertexNormals,this.colliderUpdateFps=r.colliderUpdateFps,this.depthTextureMaterialUniforms=h,r.renderShadow&&(this.receiveShadow=!0,this.castShadow=!1),r.useDownsampledGeometry&&(this.downsampledGeometry=new t.PlaneGeometry(1,1,39,39),this.downsampledMesh=new t.Mesh(this.downsampledGeometry,a),this.downsampledMesh.visible=!1,this.add(this.downsampledMesh))}init({camera:t,renderer:e}){this.camera=t,this.renderer=e}updateDepth(t){const e=this.renderer.xr?.getCamera?.()?.cameras?.[0]||this.camera;if(!e)return;this.projectionMatrixInverse.copy(e.projectionMatrix).invert(),this.minDepth=8,this.maxDepth=0,this.options.updateFullResolutionGeometry&&this.updateFullResolutionGeometry(t),this.downsampledGeometry&&this.updateGeometry(t,this.downsampledGeometry),this.minDepthPrev=this.minDepth,this.maxDepthPrev=this.maxDepth,this.geometry.attributes.position.needsUpdate=!0;const i=this.depthTextures?.get(0);i&&this.depthTextureMaterialUniforms&&(this.depthTextureMaterialUniforms.uDepthTexture.value=i,this.depthTextureMaterialUniforms.uMinDepth.value=this.minDepth,this.depthTextureMaterialUniforms.uMaxDepth.value=this.maxDepth,this.depthTextureMaterialUniforms.uRawValueToMeters.value=this.depthTextures.depthData[0].rawValueToMeters,this.material.needsUpdate=!0),this.options.updateVertexNormals&&this.geometry.computeVertexNormals(),this.updateColliderIfNeeded()}updateFullResolutionGeometry(t){this.updateGeometry(t,this.geometry)}updateGeometry(e,i){const s=e.width,n=e.height,r=this.depthOptions.useFloat32?new Float32Array(e.data):new Uint16Array(e.data),o=new t.Vector3;for(let t=0;t<i.attributes.position.count;++t){const a=i.attributes.uv.array[2*t],h=i.attributes.uv.array[2*t+1],l=Math.round(T(a*s,0,s-1)),c=r[Math.round(T((1-h)*n,0,n-1))*s+l];let d=e.rawValueToMeters*c;this.depthOptions.useFloat32&&(d=c),d>0&&(d<this.minDepth?this.minDepth=d:d>this.maxDepth&&(this.maxDepth=d)),0==d&&this.options.patchHoles&&(d=this.maxDepthPrev),this.options.patchHolesUpper&&h>.9&&(d=this.minDepthPrev),o.set(2*(a-.5),2*(h-.5),-1),o.applyMatrix4(this.projectionMatrixInverse),o.multiplyScalar(-d/o.z),i.attributes.position.array[3*t+0]=o.x,i.attributes.position.array[3*t+1]=o.y,i.attributes.position.array[3*t+2]=o.z}}updateColliderIfNeeded(){const t=performance.now()-this.lastColliderUpdateTime;if(this.RAPIER&&t>1e3/this.colliderUpdateFps){this.getWorldPosition(this.worldPosition),this.getWorldQuaternion(this.worldQuaternion),this.rigidBody.setTranslation(this.worldPosition,!1),this.rigidBody.setRotation(this.worldQuaternion,!1);const t=this.downsampledGeometry?this.downsampledGeometry:this.geometry,e=t.attributes.position.array,i=t.getIndex().array,s=this.RAPIER.ColliderDesc.trimesh(e,i).setDensity(1);if(this.options.useDualCollider)this.colliderId=(this.colliderId+1)%2,this.blendedWorld.removeCollider(this.colliders[this.colliderId],!1),this.colliders[this.colliderId]=this.blendedWorld.createCollider(s,this.rigidBody);else{const t=this.blendedWorld.createCollider(s,this.rigidBody);this.blendedWorld.removeCollider(this.collider,!1),this.collider=t}this.lastColliderUpdateTime=performance.now()}}initRapierPhysics(t,e){this.getWorldPosition(this.worldPosition),this.getWorldQuaternion(this.worldQuaternion);const i=t.RigidBodyDesc.fixed().setTranslation(this.worldPosition.x,this.worldPosition.y,this.worldPosition.z).setRotation(this.worldQuaternion);this.rigidBody=e.createRigidBody(i);const s=this.geometry.attributes.position.array,n=this.geometry.getIndex().array,r=t.ColliderDesc.trimesh(s,n);this.options.useDualCollider?(this.colliders=[],this.colliders.push(e.createCollider(r,this.rigidBody),e.createCollider(r,this.rigidBody)),this.colliderId=0):this.collider=e.createCollider(r,this.rigidBody),this.RAPIER=t,this.blendedWorld=e,this.lastColliderUpdateTime=performance.now()}getDepth(e,i,s){const n=new t.Vector2(i.x,i.y);e.setFromCamera(n,s);const r=e.intersectObject(this);if(r.length>0){return r[0].distance}return-1}raycast(t,e){const i=[];return this.downsampledMesh?this.downsampledMesh.raycast(t,i):super.raycast(t,i),i.forEach((t=>{t.object=this})),this.updateVertexNormals||i.forEach((t=>{t.normal&&t.face&&t.normal.copy(t.face.normal)})),e.push(...i),!0}getColliderFromHandle(t){if(this.collider?.handle==t)return this.collider;for(const e of this.colliders)if(e?.handle==t)return e}}class wt{constructor(){this.enabled=!1,this.updateVertexNormals=!1,this.showDebugTexture=!1,this.useDepthTexture=!1,this.renderShadow=!1,this.shadowOpacity=.25,this.patchHoles=!1,this.patchHolesUpper=!1,this.opacity=1,this.useDualCollider=!1,this.useDownsampledGeometry=!0,this.updateFullResolutionGeometry=!1,this.colliderUpdateFps=5}}class xt{constructor(t){this.debugging=!1,this.enabled=!1,this.depthMesh=new wt,this.depthTexture={enabled:!1,constantKernel:!1,applyGaussianBlur:!1,applyKawaseBlur:!1},this.occlusion={enabled:!1},this.useFloat32=!0,lt(this,t)}}const St=ht(new xt({enabled:!0,depthMesh:{enabled:!0,updateVertexNormals:!1,showDebugTexture:!1,useDepthTexture:!1,renderShadow:!1,shadowOpacity:.25,patchHoles:!0,useDownsampledGeometry:!0,updateFullResolutionGeometry:!1,colliderUpdateFps:5}})),bt=ht(new xt({enabled:!0,depthMesh:{enabled:!0,updateVertexNormals:!0,showDebugTexture:!0,useDepthTexture:!0,renderShadow:!1,shadowOpacity:.25,patchHoles:!0,opacity:.1,useDownsampledGeometry:!0,updateFullResolutionGeometry:!0,colliderUpdateFps:5},depthTexture:{enabled:!0,constantKernel:!0,applyGaussianBlur:!0,applyKawaseBlur:!0}})),Ct=ht(new xt({enabled:!0,depthMesh:{enabled:!0,updateVertexNormals:!1,showDebugTexture:!1,useDepthTexture:!1,renderShadow:!0,shadowOpacity:.25,patchHoles:!0,patchHolesUpper:!0,useDualCollider:!1,useDownsampledGeometry:!0,updateFullResolutionGeometry:!1,colliderUpdateFps:5}}));class Tt{constructor(t){this.options=t,this.uint16Arrays=[],this.uint8Arrays=[],this.textures=[],this.depthData=[]}createDepthTextures(e,i){if(this.textures[i]&&this.textures[i].dispose(),this.options.useFloat32){const s=new Uint16Array(e.width*e.height),n=t.RedFormat,r=t.HalfFloatType;this.uint16Arrays[i]=s,this.textures[i]=new t.DataTexture(s,e.width,e.height,n,r)}else{const s=new Uint8Array(e.width*e.height*2),n=t.RGFormat,r=t.UnsignedByteType;this.uint8Arrays[i]=s,this.textures[i]=new t.DataTexture(s,e.width,e.height,n,r)}}update(e,i){if((this.textures.length<i+1||this.textures[i].image.width!==e.width||this.textures[i].image.height!==e.height)&&this.createDepthTextures(e,i),this.options.useFloat32){const s=new Float32Array(e.data),n=new Uint16Array(s.length);for(let e=0;e<n.length;e++)n[e]=t.DataUtils.toHalfFloat(s[e]);this.uint16Arrays[i].set(n)}else this.uint8Arrays[i].set(new Uint8Array(e.data));this.textures[i].needsUpdate=!0,this.depthData[i]=e}get(t){return this.textures[t]}}const Rt={vertexShader:"\n    uniform float uBlurSize;\n    uniform vec2 uTexelSize;\n    varying vec2 vTexCoord;\n    varying vec4 uv1;\n    varying vec4 uv2;\n    varying vec4 uv3;\n    varying vec4 uv4;\n\n    void vertCopy(vec2 uv) {}\n\n    void vertUpsample(vec2 uv) {\n        vec2 halfPixel = uTexelSize * 0.5;\n        vec2 offset = vec2(uBlurSize);\n        uv1.xy = uv + vec2(-halfPixel.x * 2.0, 0.0) * offset;\n        uv1.zw = uv + vec2(-halfPixel.x, halfPixel.y) * offset;\n        uv2.xy = uv + vec2(0.0, halfPixel.y * 2.0) * offset;\n        uv2.zw = uv + halfPixel * offset;\n        uv3.xy = uv + vec2(halfPixel.x * 2.0, 0.0) * offset;\n        uv3.zw = uv + vec2(halfPixel.x, -halfPixel.y) * offset;\n        uv4.xy = uv + vec2(0.0, -halfPixel.y * 2.0) * offset;\n        uv4.zw = uv - halfPixel * offset;\n    }\n\n    void vertDownsample(vec2 uv) {\n        vec2 halfPixel = uTexelSize * 0.5;\n        vec2 offset = vec2(uBlurSize);\n        uv1.xy = uv - halfPixel * offset;\n        uv1.zw = uv + halfPixel * offset;\n        uv2.xy = uv - vec2(halfPixel.x, -halfPixel.y) * offset;\n        uv2.zw = uv + vec2(halfPixel.x, -halfPixel.y) * offset;\n    }\n\n    void main() {\n        vTexCoord = uv;\n        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        if (MODE == 0) {\n            vertCopy(uv);\n        } else if (MODE == 1) {\n            vertDownsample(uv);\n        } else {\n            vertUpsample(uv);\n        }\n    }\n",fragmentShader:"\n    uniform sampler2D tDiffuse;\n    varying vec2 vTexCoord;\n    varying vec4 uv1;\n    varying vec4 uv2;\n    varying vec4 uv3;\n    varying vec4 uv4;\n\n    vec2 getUV0() {\n        return vTexCoord;\n    }\n\n    vec4 fragCopy() {\n        return texture2D(tDiffuse, getUV0());\n    }\n\n    vec4 fragDownsample() {\n        vec4 sum = texture2D(tDiffuse, getUV0()) * 4.0;\n        sum += texture2D(tDiffuse, uv1.xy);\n        sum += texture2D(tDiffuse, uv1.zw);\n        sum += texture2D(tDiffuse, uv2.xy);\n        sum += texture2D(tDiffuse, uv2.zw);\n        return sum * 0.125;\n    }\n\n    vec4 fragUpsample() {\n        vec4 sum = texture2D(tDiffuse, uv1.xy);\n        sum += texture2D(tDiffuse, uv1.zw) * 2.0;\n        sum += texture2D(tDiffuse, uv2.xy);\n        sum += texture2D(tDiffuse, uv2.zw) * 2.0;\n        sum += texture2D(tDiffuse, uv3.xy);\n        sum += texture2D(tDiffuse, uv3.zw) * 2.0;\n        sum += texture2D(tDiffuse, uv4.xy);\n        sum += texture2D(tDiffuse, uv4.zw) * 2.0;\n        return sum * 0.0833;\n    }\n\n    void main(void) {\n        if (MODE == 0) {\n            gl_FragColor = fragCopy();\n        } else if (MODE == 1) {\n            gl_FragColor = fragDownsample();\n        } else {\n            gl_FragColor = fragUpsample();\n        }\n    }\n"},Mt={vertexShader:"\nvarying vec2 vTexCoord;\n\nvoid main() {\n    vTexCoord = uv;\n    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}\n    ",fragmentShader:"\nprecision mediump float;\n\nuniform sampler2D tDiffuse;\nuniform sampler2D tOcclusionMap;\n\nvarying vec2 vTexCoord;\n\nvoid main(void) {\n  vec4 diffuse = texture2D(tDiffuse, vTexCoord);\n  vec4 occlusion = texture2D(tOcclusionMap, vTexCoord);\n  float occlusionValue = occlusion.r / max(0.0001, occlusion.g);\n  occlusionValue = clamp(occlusionValue, 0.0, 1.0);\n  gl_FragColor = occlusionValue * diffuse;\n\n  gl_FragColor = sRGBTransferOETF( gl_FragColor );\n}\n"},Dt={vertexShader:"\nvarying vec2 vTexCoord;\n\nvoid main() {\n    vTexCoord = uv;\n    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}\n  ",fragmentShader:"\n#include <packing>\n\nprecision mediump float;\n\nuniform sampler2D uDepthTexture;\nuniform mat4 uUvTransform;\nuniform float uRawValueToMeters;\nuniform float uAlpha;\nuniform float uViewId;\nuniform bool uFloatDepth;\n\nuniform sampler2D tDiffuse;\nuniform sampler2D tDepth;\nuniform float cameraNear;\nuniform float cameraFar;\n\nvarying vec2 vTexCoord;\n\nfloat DepthGetMeters(in sampler2D depth_texture, in vec2 depth_uv) {\n  // Depth is packed into the luminance and alpha components of its texture.\n  // The texture is in a normalized format, storing raw values that need to be\n  // converted to meters.\n  vec2 packedDepthAndVisibility = texture2D(depth_texture, depth_uv).rg;\n  if (uFloatDepth) {\n    return packedDepthAndVisibility.r * uRawValueToMeters;\n  }\n  return dot(packedDepthAndVisibility, vec2(255.0, 256.0 * 255.0)) * uRawValueToMeters;\n}\n\nfloat readOrthographicDepth( sampler2D depthSampler, vec2 coord ) {\n  float fragCoordZ = texture2D( depthSampler, coord ).x;\n  // See https://github.com/mrdoob/three.js/issues/23072.\n  #ifdef USE_LOGDEPTHBUF\n    float viewZ = 1.0 - exp2(fragCoordZ * log(cameraFar + 1.0) / log(2.0));\n  #else\n    float viewZ = perspectiveDepthToViewZ(fragCoordZ, cameraNear, cameraFar);\n  #endif\n  return viewZToOrthographicDepth( viewZ, cameraNear, cameraFar );\n}\n\nvoid main(void) {\n  vec4 texCoord = vec4(vTexCoord, 0, 1);\n  vec2 uv = texCoord.xy;\n  uv.y = 1.0 - uv.y;\n\n  vec4 diffuse = texture2D( tDiffuse, texCoord.xy );\n  highp float real_depth = DepthGetMeters(uDepthTexture, uv);\n  highp float virtual_depth =\n    (readOrthographicDepth(tDepth, texCoord.xy ) *\n    (cameraFar - cameraNear) + cameraNear);\n  gl_FragColor = vec4(step(virtual_depth, real_depth), step(0.001, diffuse.a), 0.0, 0.0);\n}\n"};class Et extends t.MeshBasicMaterial{constructor(t,e){super(),this.uniforms={uDepthTexture:{value:null},uRawValueToMeters:{value:8/65536},cameraFar:{value:t.far},cameraNear:{value:t.near},uFloatDepth:{value:e}},this.onBeforeCompile=t=>{Object.assign(t.uniforms,this.uniforms),this.uniforms=t.uniforms,t.vertexShader=t.vertexShader.replace("#include <common>",["varying vec2 vTexCoord;","varying float vVirtualDepth;","#include <common>"].join("\n")).replace("#include <fog_vertex>",["#include <fog_vertex>","vec4 view_position = modelViewMatrix * vec4( position, 1.0 );","vVirtualDepth = -view_position.z;","gl_Position = gl_Position / gl_Position.w;","vTexCoord = 0.5 + 0.5 * gl_Position.xy;"].join("\n")),t.fragmentShader=t.fragmentShader.replace("uniform vec3 diffuse;",["uniform vec3 diffuse;","uniform sampler2D uDepthTexture;","uniform float uRawValueToMeters;","uniform float cameraNear;","uniform float cameraFar;","uniform bool uFloatDepth;","varying vec2 vTexCoord;","varying float vVirtualDepth;"].join("\n")).replace("#include <clipping_planes_pars_fragment>",["#include <clipping_planes_pars_fragment>","\n  float DepthGetMeters(in sampler2D depth_texture, in vec2 depth_uv) {\n    // Depth is packed into the luminance and alpha components of its texture.\n    // The texture is in a normalized format, storing raw values that need to be\n    // converted to meters.\n    vec2 packedDepthAndVisibility = texture2D(depth_texture, depth_uv).rg;\n    if (uFloatDepth) {\n      return packedDepthAndVisibility.r * uRawValueToMeters;\n    }\n    return dot(packedDepthAndVisibility, vec2(255.0, 256.0 * 255.0)) * uRawValueToMeters;\n  }\n"].join("\n")).replace("#include <dithering_fragment>",["#include <dithering_fragment>","vec4 texCoord = vec4(vTexCoord, 0, 1);","vec2 uv = vec2(texCoord.x, 1.0 - texCoord.y);","highp float real_depth = DepthGetMeters(uDepthTexture, uv);","gl_FragColor = vec4(step(vVirtualDepth, real_depth), 1.0, 0.0, 1.0);"].join("\n"))}}}var _t;!function(t){t[t.COPY=0]="COPY",t[t.DOWN=1]="DOWN",t[t.UP=2]="UP"}(_t||(_t={}));class Pt extends e{constructor(e,s,n=!0,r=!1,o=3){super(),this.scene=e,this.camera=s,this.renderToScreen=r,this.occludableItemsLayer=o,this.depthTextures=[],this.occlusionMeshMaterial=new Et(s,n),this.occlusionMapUniforms={uDepthTexture:{value:null},uUvTransform:{value:new t.Matrix4},uRawValueToMeters:{value:8/65536},uAlpha:{value:.75},tDiffuse:{value:null},tDepth:{value:null},uFloatDepth:{value:n},cameraFar:{value:s.far},cameraNear:{value:s.near}},this.occlusionMapQuad=new i(new t.ShaderMaterial({name:"OcclusionMapShader",uniforms:this.occlusionMapUniforms,vertexShader:Dt.vertexShader,fragmentShader:Dt.fragmentShader})),this.occlusionMapTexture=new t.WebGLRenderTarget,this.kawaseBlurTargets=[new t.WebGLRenderTarget,new t.WebGLRenderTarget,new t.WebGLRenderTarget],this.kawaseBlurQuads=[this.setupKawaseBlur(_t.DOWN,this.occlusionMapTexture.texture),this.setupKawaseBlur(_t.DOWN,this.kawaseBlurTargets[0].texture),this.setupKawaseBlur(_t.DOWN,this.kawaseBlurTargets[1].texture),this.setupKawaseBlur(_t.UP,this.kawaseBlurTargets[2].texture),this.setupKawaseBlur(_t.UP,this.kawaseBlurTargets[1].texture),this.setupKawaseBlur(_t.UP,this.kawaseBlurTargets[0].texture)],this.occlusionUniforms={tDiffuse:{value:null},tOcclusionMap:{value:this.occlusionMapTexture.texture}},this.occlusionQuad=new i(new t.ShaderMaterial({name:"OcclusionShader",uniforms:this.occlusionUniforms,vertexShader:Mt.vertexShader,fragmentShader:Mt.fragmentShader})),this.occludableItemsLayer=o}setupKawaseBlur(e,s){const n={uBlurSize:{value:7},uTexelSize:{value:new t.Vector2},tDiffuse:{value:s}},r=new t.ShaderMaterial({name:"Kawase",uniforms:n,vertexShader:Rt.vertexShader,fragmentShader:Rt.fragmentShader,defines:{MODE:e}});return new i(r)}setDepthTexture(t,e,i){i>1||(this.depthTextures[i]=t,this.occlusionMapUniforms.uRawValueToMeters.value=e,this.occlusionMeshMaterial.uniforms.uRawValueToMeters.value=e,t.needsUpdate=!0)}render(e,i,s,n=0){const r=e.getRenderTarget(),o=new t.Vector2;null==s?this.renderOcclusionMapFromScene(e,o,n):this.renderOcclusionMapFromReadBuffer(e,s,o,n),this.blurOcclusionMap(e,o),this.applyOcclusionMapToRenderedImage(e,s,i),e.setRenderTarget(r)}renderOcclusionMapFromScene(t,e,i){this.occlusionMeshMaterial.uniforms.uDepthTexture.value=this.depthTextures[i],this.scene.overrideMaterial=this.occlusionMeshMaterial,t.getDrawingBufferSize(e),this.occlusionMapTexture.setSize(e.x,e.y);const s=this.occlusionMapTexture;t.setRenderTarget(s);const n=t.xr.getCamera().cameras[i]||this.camera,r=Array.from(Array(32).keys()).filter((t=>n.layers.isEnabled(t)));n.layers.set(this.occludableItemsLayer),t.render(this.scene,n),n.layers.disableAll(),r.forEach((t=>{n.layers.enable(t)})),this.scene.overrideMaterial=null}renderOcclusionMapFromReadBuffer(t,e,i,s){this.occlusionMapUniforms.tDiffuse.value=e.texture,this.occlusionMapUniforms.tDepth.value=e.depthTexture,this.occlusionMapUniforms.uDepthTexture.value=this.depthTextures[s],t.getDrawingBufferSize(i),this.occlusionMapTexture.setSize(i.x,i.y),t.setRenderTarget(this.occlusionMapTexture),this.occlusionMapQuad.render(t)}blurOcclusionMap(t,e){for(let t=0;t<3;t++)this.kawaseBlurTargets[t].setSize(e.x/2**t,e.y/2**t);for(let t=0;t<3;t++)this.kawaseBlurQuads[t].material.uniforms.uTexelSize.value.set(1/(e.x/2**t),1/(e.y/2**t)),this.kawaseBlurQuads[this.kawaseBlurQuads.length-1-t].material.uniforms.uTexelSize.value.set(1/(e.x/2**(t-1)),1/(e.y/2**(t-1)));t.setRenderTarget(this.kawaseBlurTargets[0]),this.kawaseBlurQuads[0].render(t),t.setRenderTarget(this.kawaseBlurTargets[1]),this.kawaseBlurQuads[1].render(t),t.setRenderTarget(this.kawaseBlurTargets[2]),this.kawaseBlurQuads[2].render(t),t.setRenderTarget(this.kawaseBlurTargets[1]),this.kawaseBlurQuads[3].render(t),t.setRenderTarget(this.kawaseBlurTargets[0]),this.kawaseBlurQuads[4].render(t),t.setRenderTarget(this.occlusionMapTexture),this.kawaseBlurQuads[5].render(t)}applyOcclusionMapToRenderedImage(t,e,i){e&&(this.renderToScreen||i)&&(this.occlusionUniforms.tDiffuse.value=e.texture,t.setRenderTarget(i&&!this.renderToScreen?i:null),this.occlusionQuad.render(t))}dispose(){this.occlusionMeshMaterial.dispose(),this.occlusionMapTexture.dispose();for(let t=0;t<this.kawaseBlurQuads.length;t++)this.kawaseBlurQuads[t].dispose()}updateOcclusionMapUniforms(t,e){const i=e.xr.getCamera().cameras[0]||this.camera;t.tOcclusionMap.value=this.occlusionMapTexture.texture,t.uOcclusionClipFromWorld.value.copy(i.projectionMatrix).multiply(i.matrixWorldInverse)}}const Ot=new t.Vector3;class At{constructor(){if(this.projectionMatrixInverse=new t.Matrix4,this.view=[],this.depthData=[],this.depthArray=[],this.options=new xt,this.width=160,this.height=160,this.rawValueToMeters=.0010000000474974513,this.occludableShaders=new Set,this.depthClientsInitialized=!1,this.depthClients=new Set,At.instance)return At.instance;At.instance=this}init(e,i,s,n,r){this.camera=e,this.options=i,this.renderer=s,this.scene=r,this.options.depthTexture.enabled&&(this.depthTextures=new Tt(i),n.register(this.depthTextures)),this.options.depthMesh.enabled&&(this.depthMesh=new yt(i,this.width,this.height,this.depthTextures),n.register(this.depthMesh),this.options.depthMesh.renderShadow&&(this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=t.PCFShadowMap),e.add(this.depthMesh),r.add(e)),this.options.occlusion.enabled&&(this.occlusionPass=new Pt(r,e))}getDepth(t,e){if(!this.depthArray[0])return 0;const i=Math.round(T(t*this.width,0,this.width-1)),s=Math.round(T((1-e)*this.height,0,this.height-1)),n=this.depthArray[0][s*this.width+i];return this.rawValueToMeters*n}getProjectedDepthViewPositionFromWorldPosition(e,i=new t.Vector3){const s=this.renderer.xr?.getCamera?.()?.cameras?.[0]||this.camera;Ot.copy(e).applyMatrix4(s.matrixWorldInverse).applyMatrix4(s.projectionMatrix);const n=.5*(Ot.x+1),r=.5*(Ot.y+1),o=this.getDepth(n,r);return i.set(2*(n-.5),2*(r-.5),-1),i.applyMatrix4(s.projectionMatrixInverse),i.multiplyScalar((i.z-o)/i.z),i}getVertex(e,i){if(!this.depthArray[0])return null;const s=Math.round(T(e*this.width,0,this.width-1)),n=Math.round(T((1-i)*this.height,0,this.height-1)),r=this.depthArray[0][n*this.width+s],o=this.rawValueToMeters*r,a=new t.Vector3(2*(e-.5),2*(i-.5),-1);return a.applyMatrix4(this.projectionMatrixInverse),a.multiplyScalar(-o/a.z),a}updateDepthData(t,e=0){this.depthData[e]=t,this.rawValueToMeters=t.rawValueToMeters,this.options.useFloat32&&(this.rawValueToMeters=1),null==this.depthArray[e]?(this.depthArray[e]=this.options.useFloat32?new Float32Array(t.data):new Uint16Array(t.data),this.width=t.width,this.height=t.height):this.depthArray[e].set(this.options.useFloat32?new Float32Array(t.data):new Uint16Array(t.data)),this.options.depthTexture.enabled&&this.depthTextures&&this.depthTextures.update(t,e),this.options.depthMesh.enabled&&this.depthMesh&&0==e&&this.depthMesh.updateDepth(t)}getTexture(t){if(this.options.depthTexture.enabled)return this.depthTextures?.get(t)}update(t){this.options.enabled&&(this.updateLocalDepth(t),this.options.occlusion.enabled&&this.renderOcclusionPass())}updateLocalDepth(t){if(ft())return;const e=this.renderer.xr?.getCamera?.()?.cameras?.[0];if(e&&this.depthMesh&&this.depthMesh.parent!=e&&(e.add(this.depthMesh),this.scene.add(e)),!t)return;const i=t.session;if(void 0!==i.depthActive&&this.depthClientsInitialized){const t=this.depthClients.size>0;if(i.depthActive&&!t?i.pauseDepthSensing?.():!i.depthActive&&t&&i.resumeDepthSensing?.(),0==this.depthClients.size)return}if(null==this.xrRefSpace)i.requestReferenceSpace("local").then((t=>{this.xrRefSpace=t})),i.addEventListener("end",(()=>{this.xrRefSpace=void 0}));else{const e=t.getViewerPose(this.xrRefSpace);if(e)for(let i=0;i<e.views.length;++i){const s=e.views[i];this.view[i]=s;const n=t.getDepthInformation(s);if(!n)return;this.updateDepthData(n,i)}else console.error("Pose unavailable in the current frame.")}}renderOcclusionPass(){const t=this.getTexture(0);t&&this.occlusionPass.setDepthTexture(t,this.rawValueToMeters,0);const e=this.getTexture(1);e&&this.occlusionPass.setDepthTexture(e,this.rawValueToMeters,1);const i=this.renderer.xr.isPresenting;this.renderer.xr.isPresenting=!1,this.occlusionPass.render(this.renderer,void 0,void 0,0),this.renderer.xr.isPresenting=i;for(const t of this.occludableShaders)this.occlusionPass.updateOcclusionMapUniforms(t.uniforms,this.renderer)}debugLog(){const t=this.depthData[0].data,e=new Uint8Array(t),i=Array.from(e,(t=>String.fromCharCode(t))).join(""),s=btoa(i);console.log(s)}resumeDepth(t){this.depthClientsInitialized=!0,this.depthClients.add(t)}pauseDepth(t){this.depthClientsInitialized=!0,this.depthClients.delete(t)}}const It={depth:1,RGB:4/3},Lt={scale:1,scaleX:.75,scaleY:.63,translateU:.2,translateV:-.02,k1:-.046,k2:0,k3:0,p1:0,p2:0,xc:0,yc:0};function Vt(t,e){if(e?.simulatorCamera){const i=window.innerWidth/window.innerHeight,s=e.simulatorCamera.width/e.simulatorCamera.height;let{u:n,v:r}=t;if(i>s){const t=s/i;n=n*t+(1-t)/2}else{const t=i/s;r=r*t+(1-t)/2}return{u:n,v:1-r}}if(!It||!It.depth||!It.RGB)return console.error("Invalid aspect ratios provided."),null;let i,s;It.depth>It.RGB?(s=1,i=It.RGB/It.depth):(i=1,s=It.depth/It.RGB);const n=t.u-.5,r=t.v-.5,o=n-Lt.xc,a=r-Lt.yc,h=o*o+a*a,l=1+Lt.k1*h+Lt.k2*h*h+Lt.k3*h*h*h;return{u:((o*l+(2*Lt.p1*o*a+Lt.p2*(h+2*o*o))+Lt.xc)*i+Lt.translateU)*Lt.scale*Lt.scaleX+.5,v:1-(((a*l+(Lt.p1*(h+2*a*a)+2*Lt.p2*o*a)+Lt.yc)*s+Lt.translateV)*Lt.scale*Lt.scaleY+.5)}}function Bt(e,i,s,n,r,o=At.instance){if(!(i&&s&&n&&o))return null;const a=Vt(e,r);if(!a)return null;const{u:h,v:l}=a,c=Math.round(T(h*o.width,0,o.width-1)),d=i[Math.round(T((1-l)*o.height,0,o.height-1))*o.width+c],u=o.rawValueToMeters*d,p=new t.Vector3(2*(h-.5),2*(l-.5),-1),g=s.clone().invert();p.applyMatrix4(g),p.multiplyScalar(-u/p.z);return p.clone().applyMatrix4(n)}async function Ft(e,i){if(!e)throw new Error("No image data provided for cropping.");const s=new Image;await new Promise(((t,i)=>{s.onload=t,s.onerror=t=>{console.error("Error loading image for cropping:",t),i(new Error("Failed to load image for cropping."))},s.src=e.startsWith("data:image")?e:`data:image/png;base64,${e}`}));const n=document.createElement("canvas"),r=n.getContext("2d"),o=new t.Box2(new t.Vector2(0,0),new t.Vector2(1,1)),a=i.clone().intersect(o),h=new t.Vector2;if(a.getSize(h),0===h.x||0===h.y)return"data:image/png;base64,";const l=s.width*a.min.x,c=s.height*a.min.y,d=s.width*h.x,u=s.height*h.y;return n.width=d,n.height=u,r.drawImage(s,l,c,d,u,0,0,d,u),n.toDataURL("image/png")}var zt;!function(t){t.IDLE="idle",t.INITIALIZING="initializing",t.STREAMING="streaming",t.ERROR="error",t.NO_DEVICES_FOUND="no_devices_found"}(zt||(zt={}));class jt extends S{constructor({willCaptureFrequently:e=!1}={}){super(),this.loaded=!1,this.state=zt.IDLE,this.stream_=null,this.video_=document.createElement("video"),this.frozenTexture_=null,this.canvas_=null,this.context_=null,this.willCaptureFrequently_=e,this.video_.autoplay=!0,this.video_.muted=!0,this.video_.playsInline=!0,this.texture=new t.VideoTexture(this.video_),this.texture.colorSpace=t.SRGBColorSpace,this.texture.minFilter=t.LinearFilter,this.texture.magFilter=t.LinearFilter}setState_(t,e={}){(this.state!==t||e.force)&&(this.state=t,this.dispatchEvent({type:"statechange",state:this.state,...e}),console.debug(`VideoStream state changed to ${t} with details:`,e))}handleVideoStreamLoadedMetadata(t,e,i=!1){try{if(this.video_.videoWidth>0&&this.video_.videoHeight>0)this.width=this.video_.videoWidth,this.height=this.video_.videoHeight,this.aspectRatio=this.width/this.height,this.loaded=!0,t();else if(i)setTimeout((()=>{this.handleVideoStreamLoadedMetadata(t,e,!1)}),500);else{const t=new Error("Failed to get valid video dimensions.");this.setState_(zt.ERROR,{error:t}),e(t)}}catch(t){t instanceof Error&&(this.setState_(zt.ERROR,{error:t}),e(t))}}getSnapshot({width:e=this.width,height:i=this.height,outputFormat:s="texture",mimeType:n="image/jpeg",quality:r=.9}={}){if(!this.loaded||!e||!i||this.video_.readyState<this.video_.HAVE_CURRENT_DATA)return null;(e>this.width||i>this.height)&&console.warn(`The requested snapshot width (${e}px x ${i}px) is larger than the source video width (${this.width}px x ${this.height}px). The snapshot will be upscaled.`);try{switch(this.canvas_&&this.canvas_.width===e&&this.canvas_.height===i||(this.canvas_=document.createElement("canvas"),this.canvas_.width=e,this.canvas_.height=i,this.context_=this.canvas_.getContext("2d",{willCaptureFrequently:this.willCaptureFrequently_})),this.context_.drawImage(this.video_,0,0,e,i),s){case"imageData":return this.context_.getImageData(0,0,e,i);case"base64":return this.canvas_.toDataURL(n,r);default:{const e=new t.Texture(this.canvas_);return e.needsUpdate=!0,e.colorSpace=t.SRGBColorSpace,this.frozenTexture_=e,this.frozenTexture_}}}catch(t){return console.error("Error capturing snapshot:",t),null}}stop_(){this.stream_&&(this.stream_.getTracks().forEach((t=>t.stop())),this.stream_=null),this.video_.srcObject&&(this.video_.srcObject=null),this.video_.src&&this.video_.src.startsWith("blob:")&&URL.revokeObjectURL(this.video_.src),this.video_.src="",this.loaded=!1,this.setState_(zt.IDLE)}dispose(){this.stop_(),this.texture?.dispose(),this.frozenTexture_?.dispose(),this.canvas_=null,this.context_=null,super.dispose()}}class kt extends jt{constructor({videoConstraints:t={facingMode:"environment"},willCaptureFrequently:e=!1}={}){super({willCaptureFrequently:e}),this.isInitializing_=!1,this.availableDevices_=[],this.currentDeviceIndex_=-1,this.videoConstraints_={...t}}async getAvailableVideoDevices(){if(!navigator.mediaDevices?.enumerateDevices)return console.warn("navigator.mediaDevices.enumerateDevices() is not supported."),[];const t=[...await navigator.mediaDevices.enumerateDevices()];if(this.simulatorCamera){const e=await this.simulatorCamera.enumerateDevices();t.push(...e)}return t.filter((t=>"videoinput"===t.kind))}async init(){this.setState_(zt.INITIALIZING);try{this.availableDevices_=await this.getAvailableVideoDevices(),this.availableDevices_.length>0?await this.initStream_():(this.setState_(zt.NO_DEVICES_FOUND),console.warn("No video devices found."))}catch(t){throw this.setState_(zt.ERROR,{error:t}),console.error("Error initializing XRDeviceCamera:",t),t}}async initStream_(){if(!this.isInitializing_){this.isInitializing_=!0,this.setState_(zt.INITIALIZING),this.currentTrackSettings_=void 0,this.currentDeviceIndex_=-1;try{console.debug("Requesting media stream with constraints:",this.videoConstraints_);let t=null;const e=this.videoConstraints_.deviceId,i="string"==typeof e?e:Array.isArray(e)?e[0]:e?.exact;if(!!this.simulatorCamera&&(i&&"simulator"===this.availableDevices_.find((t=>t.deviceId===i))?.groupId||!i&&"environment"===this.videoConstraints_.facingMode)){if(t=this.simulatorCamera.getMedia(this.videoConstraints_),!t)throw new Error("Simulator camera failed to provide a media stream.")}else t=await navigator.mediaDevices.getUserMedia({video:this.videoConstraints_});const s=t?.getVideoTracks()||[];if(!s.length)throw new Error("MediaStream has no video tracks.");const n=s[0];this.currentTrackSettings_=n.getSettings(),console.debug("Active track settings:",this.currentTrackSettings_),this.currentTrackSettings_.deviceId?this.currentDeviceIndex_=this.availableDevices_.findIndex((t=>t.deviceId===this.currentTrackSettings_.deviceId)):console.warn("Stream started without deviceId as it was unavailable"),this.stop_(),this.stream_=t,this.video_.srcObject=t,this.video_.src="",await new Promise(((t,e)=>{this.video_.onloadedmetadata=()=>{this.handleVideoStreamLoadedMetadata(t,e,!0)},this.video_.onerror=()=>{const t=new Error("Error playing camera stream.");this.setState_(zt.ERROR,{error:t}),e(t)},this.video_.play()}));const r={width:this.width,height:this.height,aspectRatio:this.aspectRatio,device:this.getCurrentDevice(),facingMode:this.currentTrackSettings_.facingMode,trackSettings:this.currentTrackSettings_};this.setState_(zt.STREAMING,r)}catch(t){throw this.setState_(zt.ERROR,{error:t}),t}finally{this.isInitializing_=!1}}}async setDeviceId(t){const e=this.availableDevices_.findIndex((e=>e.deviceId===t));if(-1===e)throw new Error(`Device with ID ${t} not found.`);e!==this.currentDeviceIndex_?(delete this.videoConstraints_.facingMode,this.videoConstraints_.deviceId={exact:t},await this.initStream_()):console.log(`Device ${t} is already active.`)}async setFacingMode(t){delete this.videoConstraints_.deviceId,this.videoConstraints_.facingMode=t,this.currentDeviceIndex_=-1,await this.initStream_()}getAvailableDevices(){return this.availableDevices_}getCurrentDevice(){if(-1!==this.currentDeviceIndex_&&this.availableDevices_.length)return this.availableDevices_[this.currentDeviceIndex_]}getCurrentTrackSettings(){return this.currentTrackSettings_}getCurrentDeviceIndex(){return this.currentDeviceIndex_}registerSimulatorCamera(t){this.simulatorCamera=t,this.init()}}class Ut{constructor(){this.instances=new Map}register(t,e){const i=e??t.constructor;if(!(t instanceof i))throw new Error(`Instance of type '${t.constructor.name}' is not an instance of the registration type '${i.name}'.`);this.instances.set(i,t)}get(t){return this.instances.get(t)}getOrCreate(t,e){let i=this.get(t);if(void 0===i){if(i=e(),!(i instanceof t))throw new Error(`Factory for type ${t.name} returned an incompatible instance of type ${i.constructor.name}.`);this.register(i,t)}return i}unregister(t){this.instances.delete(t)}}function Nt(t,e,i){const s=4*e,n=new Uint8Array(s);for(let e=0;e<i/2;e++){const r=e*s,o=(i-1-e)*s;n.set(t.subarray(r,r+s)),t.set(t.subarray(o,o+s),r),t.set(n,o)}}class Gt{constructor(t,e,i){this.resolve=t,this.reject=e,this.overlayOnCamera=i}}class Ht{constructor(){this.pendingScreenshotRequests=[],this.virtualBuffer=new Uint8Array,this.virtualRealBuffer=new Uint8Array}async onAfterRender(t,e){if(0==this.pendingScreenshotRequests.length)return;if(null==t.getRenderTarget())throw new Error("Expecting render target");this.pendingScreenshotRequests.every((t=>!t.overlayOnCamera))&&this.createVirtualImageDataURL(t).then((t=>{this.resolveVirtualOnlyRequests(t)}));const i=this.pendingScreenshotRequests.some((t=>t.overlayOnCamera));if(i&&e)this.createVirtualRealImageDataURL(t,e).then((t=>{t&&this.resolveVirtualRealRequests(t)}));else if(i)throw new Error("No device camera provided")}async createVirtualImageDataURL(t){const e=t.getRenderTarget();this.virtualBuffer.length!=e.width*e.height*4&&(this.virtualBuffer=new Uint8Array(e.width*e.height*4));const i=this.virtualBuffer;await t.readRenderTargetPixelsAsync(e,0,0,e.width,e.height,i),Nt(i,e.width,e.height);const s=this.virtualCanvas||(this.virtualCanvas=document.createElement("canvas"));s.width=e.width,s.height=e.height;const n=s.getContext("2d");if(!n)throw new Error("Failed to get 2D context");const r=new ImageData(new Uint8ClampedArray(i),e.width,e.height);return n.putImageData(r,0,0),s.toDataURL()}resolveVirtualOnlyRequests(t){let e=0;for(let i=0;i<this.pendingScreenshotRequests.length;i++){const s=this.pendingScreenshotRequests[i];s.overlayOnCamera?this.pendingScreenshotRequests[e++]=s:s.resolve(t)}this.pendingScreenshotRequests.length=e}async createVirtualRealImageDataURL(e,i){if(!i.loaded)return console.log("Waiting for device camera to be loaded"),null;this.realVirtualRenderTarget||(this.realVirtualRenderTarget=new t.WebGLRenderTarget(640,480));const s=e.getRenderTarget(),n=this.realVirtualRenderTarget;e.setRenderTarget(n);const r=this.getFullScreenQuad();r.material.map=i.texture,r.render(e),r.material.map=s.texture,r.render(e),e.setRenderTarget(s),this.virtualRealBuffer.length!=n.width*n.height*4&&(this.virtualRealBuffer=new Uint8Array(n.width*n.height*4));const o=this.virtualRealBuffer;await e.readRenderTargetPixelsAsync(n,0,0,n.width,n.height,o),Nt(o,n.width,n.height);const a=this.virtualRealCanvas||(this.virtualRealCanvas=document.createElement("canvas"));a.width=n.width,a.height=n.height;const h=a.getContext("2d");if(!h)throw new Error("Failed to get 2D context");const l=new ImageData(new Uint8ClampedArray(o),n.width,n.height);return h.putImageData(l,0,0),a.toDataURL()}resolveVirtualRealRequests(t){let e=0;for(let i=0;i<this.pendingScreenshotRequests.length;i++){const s=this.pendingScreenshotRequests[i];s.overlayOnCamera?s.resolve(t):this.pendingScreenshotRequests[e++]=s}this.pendingScreenshotRequests.length=e}getFullScreenQuad(){return this.fullScreenQuad||(this.fullScreenQuad=new i(new t.MeshBasicMaterial({transparent:!0}))),this.fullScreenQuad}async getScreenshot(t=!1){return await new Promise(((e,i)=>{this.pendingScreenshotRequests.push(new Gt(e,i,t))}))}}class Wt{constructor(t){this.initScriptFunction=t,this.scripts=new Set,this.callSelectStartBound=this.callSelectStart.bind(this),this.callSelectEndBound=this.callSelectEnd.bind(this),this.callSelectBound=this.callSelect.bind(this),this.callSqueezeStartBound=this.callSqueezeStart.bind(this),this.callSqueezeEndBound=this.callSqueezeEnd.bind(this),this.callSqueezeBound=this.callSqueeze.bind(this),this.callKeyDownBound=this.callKeyDown.bind(this),this.callKeyUpBound=this.callKeyUp.bind(this),this.initializingScripts=new Set}async initScript(t){this.scripts.has(t)||this.initializingScripts.has(t)||(this.initializingScripts.add(t),await this.initScriptFunction(t),this.scripts.add(t),this.initializingScripts.delete(t))}uninitScript(t){this.scripts.has(t)&&(t.dispose(),this.scripts.delete(t),this.initializingScripts.delete(t))}async syncScriptsWithScene(t){const e=new Set,i=[];t.traverse((t=>{if(t.isXRScript){const s=t;i.push(this.initScript(s)),e.add(s)}})),await Promise.allSettled(i);for(const t of this.scripts)e.has(t)||this.uninitScript(t)}callSelectStart(t){for(const e of this.scripts)e.onSelectStart(t)}callSelectEnd(t){for(const e of this.scripts)e.onSelectEnd(t)}callSelect(t){for(const e of this.scripts)e.onSelect(t)}callSqueezeStart(t){for(const e of this.scripts)e.onSqueezeStart(t)}callSqueezeEnd(t){for(const e of this.scripts)e.onSqueezeEnd(t)}callSqueeze(t){for(const e of this.scripts)e.onSqueeze(t)}callKeyDown(t){for(const e of this.scripts)e.onKeyDown(t)}callKeyUp(t){for(const e of this.scripts)e.onKeyUp(t)}onXRSessionStarted(t){for(const e of this.scripts)e.onXRSessionStarted(t)}onXRSessionEnded(){for(const t of this.scripts)t.onXRSessionEnded()}onSimulatorStarted(){for(const t of this.scripts)t.onSimulatorStarted()}}class qt{constructor(){this.callbacks=[]}onFrame(){this.callbacks.forEach((t=>{try{t()}catch(t){console.error(t)}})),this.callbacks.length=0}async waitFrame(){return new Promise((t=>{this.callbacks.push(t)}))}}var Xt;!function(t){t.UNSUPPORTED="unsupported",t.READY="ready",t.SESSION_START="sessionstart",t.SESSION_END="sessionend"}(Xt||(Xt={}));class Kt extends t.EventDispatcher{constructor(t,e,i){super(),this.renderer=t,this.sessionInit=e,this.mode=i,this.onSessionEndedBound=this.onSessionEndedInternal.bind(this)}async initialize(){if(!("xr"in navigator))return console.warn("WebXR not supported"),this.xrModeSupported=!1,void this.dispatchEvent({type:Xt.UNSUPPORTED});let t=!1;try{t=await navigator.xr.isSessionSupported(this.mode)||!1}catch(t){return console.error("Error getting isSessionSupported",t),this.xrModeSupported=!1,void this.dispatchEvent({type:Xt.UNSUPPORTED})}t?(this.xrModeSupported=!0,this.sessionOptions={...this.sessionInit,optionalFeatures:["local-floor",...this.sessionInit.optionalFeatures||[]]},this.dispatchEvent({type:Xt.READY,sessionOptions:this.sessionOptions}),void 0!==navigator.xr.offerSession&&navigator.xr.offerSession(this.mode,this.sessionOptions).then(this.onSessionStartedInternal.bind(this)).catch((t=>{console.warn(t)}))):(console.log(`${this.mode} not supported`),this.xrModeSupported=!1,this.dispatchEvent({type:Xt.UNSUPPORTED}))}startSession(){if(void 0===this.xrModeSupported)throw new Error("Initialize not yet complete");if(!this.xrModeSupported)throw new Error("WebXR not supported");if(this.currentSession)throw new Error("Session already started");navigator.xr.requestSession(this.mode,this.sessionOptions).then(this.onSessionStartedInternal.bind(this))}endSession(){if(!this.currentSession)throw new Error("No session to end");this.currentSession.end(),this.currentSession=void 0}isXRSupported(){return this.xrModeSupported}async onSessionStartedInternal(t){t.addEventListener("end",this.onSessionEndedBound),await this.renderer.xr.setSession(t),this.currentSession=t,this.dispatchEvent({type:Xt.SESSION_START,session:t})}onSessionEndedInternal(){this.dispatchEvent({type:Xt.SESSION_END}),this.currentSession?.removeEventListener("end",this.onSessionEndedBound),this.currentSession=void 0}}const $t="XRButton";class Qt{constructor(t,e="ENTER XR",i="END XR",s="XR NOT SUPPORTED",n="START SIMULATOR",r=!1,o=!1,a=()=>{}){this.sessionManager=t,this.startText=e,this.endText=i,this.invalidText=s,this.startSimulatorText=n,this.startSimulator=a,this.domElement=document.createElement("div"),this.simulatorButtonElement=document.createElement("button"),this.xrButtonElement=document.createElement("button"),this.domElement.id="XRButtonWrapper",this.createXRButtonElement(),r&&(ft()||o)&&this.createSimulatorButton(),this.sessionManager.addEventListener(Xt.UNSUPPORTED,this.showXRNotSupported.bind(this)),this.sessionManager.addEventListener(Xt.READY,(()=>this.onSessionReady())),this.sessionManager.addEventListener(Xt.SESSION_START,(()=>this.onSessionStarted())),this.sessionManager.addEventListener(Xt.SESSION_END,this.onSessionEnded.bind(this))}createSimulatorButton(){this.simulatorButtonElement.classList.add($t),this.simulatorButtonElement.innerText=this.startSimulatorText,this.simulatorButtonElement.onclick=()=>{this.domElement.remove(),this.startSimulator()},this.domElement.appendChild(this.simulatorButtonElement)}createXRButtonElement(){this.xrButtonElement.classList.add($t),this.xrButtonElement.disabled=!0,this.xrButtonElement.textContent="...",this.domElement.appendChild(this.xrButtonElement)}onSessionReady(){const t=this.xrButtonElement;t.style.display="",t.innerHTML=this.startText,t.disabled=!1,t.onclick=()=>{this.sessionManager.startSession()}}showXRNotSupported(){this.xrButtonElement.textContent=this.invalidText,this.xrButtonElement.disabled=!0}async onSessionStarted(){this.xrButtonElement.innerHTML=this.endText}onSessionEnded(){this.xrButtonElement.innerHTML=this.startText}}class Yt extends e{render(t,e,i,s,n,r=0){}}class Jt{constructor(e,i,s){this.renderer=e,this.scene=i,this.timer=s,this.passes=[],this.renderTargets=[],this.dimensions=new t.Vector2}addPass(t){t.renderToScreen=!1,this.passes.push(t)}setupRenderTargets(e){const i=this.renderer.getRenderTarget();if(null==i)return;const s=this.renderer.xr.isPresenting?4:2;for(let n=0;n<s;n++)(n>=this.renderTargets.length||this.renderTargets[n].width!=e.x||this.renderTargets[n].height!=e.y)&&(this.renderTargets[n]?.depthTexture?.dispose(),this.renderTargets[n]?.dispose(),this.renderTargets[n]=i.clone(),this.renderTargets[n].depthTexture=new t.DepthTexture(e.x,e.y));for(let t=s;t<this.renderTargets.length;t++)this.renderTargets[t].depthTexture?.dispose(),this.renderTargets[t].dispose()}render(){this.renderer.getDrawingBufferSize(this.dimensions),this.setupRenderTargets(this.dimensions),this.renderer.xr.cameraAutoUpdate=!1;this.renderer.getRenderTarget()&&(this.renderer.xr.isPresenting?this.renderXr():this.renderSimulator())}renderXr(){const e=this.renderer.getRenderTarget(),i=this.renderer,s=i.xr.enabled,n=i.xr.isPresenting,r=this.renderTargets,o=new t.Vector4;i.getViewport(o),i.xr.cameraAutoUpdate=!1,i.xr.enabled=!1;const a=this.timer.getDelta();if(2==i.xr.getCamera().cameras.length){for(let t=0;t<2;++t){const e=i.xr.getCamera().cameras[t];i.setViewport(e.viewport),i.setRenderTarget(r[t]),i.clear(),i.xr.isPresenting=!0,i.render(this.scene,e)}i.setRenderTarget(e),i.clear(),i.xr.isPresenting=!1,i.autoClearColor=!1;for(let t=0;t<2;t++){for(let s=0;s<this.passes.length-1;++s){const n=s%2,r=(s+1)%2;e.viewport.set(t*this.dimensions.x/2,0,this.dimensions.x/2,this.dimensions.y),this.passes[s].render(i,this.renderTargets[2*r+t],this.renderTargets[2*n+t],a,!1,t)}if(this.passes.length>0){const s=(this.passes.length-1)%2;e.viewport.set(t*this.dimensions.x/2,0,this.dimensions.x/2,this.dimensions.y),this.passes[this.passes.length-1].render(i,e,this.renderTargets[2*s+t],a,!1,t)}}i.xr.enabled=s,i.xr.isPresenting=n}}renderSimulator(){const e=this.renderer.getRenderTarget(),i=this.renderer,s=i.xr.enabled,n=i.xr.isPresenting,r=new t.Vector4;i.getViewport(r),i.xr.cameraAutoUpdate=!1,i.xr.enabled=!1;const o=this.timer.getDelta();i.setRenderTarget(e),i.clear(),i.xr.isPresenting=!1,i.autoClearColor=!1;for(let t=0;t<this.passes.length-1;++t){const e=t%2,s=(t+1)%2;this.passes[t].render(i,this.renderTargets[s],this.renderTargets[e],o,!1,0)}if(this.passes.length>0){const t=(this.passes.length-1)%2;this.passes[this.passes.length-1].render(i,e,this.renderTargets[t],o,!1,0)}i.xr.enabled=s,i.xr.isPresenting=n}}const Zt=["wrist","thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip","index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip","middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip","ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip","pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"];var te;!function(t){t[t.NONE=-1]="NONE",t[t.LEFT=0]="LEFT",t[t.RIGHT=1]="RIGHT"}(te||(te={}));class ee{constructor(t){this.hands=t,this.dominant=te.RIGHT}getJoint(t,e){let i=e;i===te.NONE&&(i=this.dominant);const s=this.hands[i];if(s){if(s.joints&&t in s.joints)return s.joints[t]}else console.log("no hand")}getIndexTip(t=te.NONE){return this.getJoint("index-finger-tip",t)}getThumbTip(t=te.NONE){return this.getJoint("thumb-tip",t)}getMiddleTip(t=te.NONE){return this.getJoint("middle-finger-tip",t)}getRingTip(t=te.NONE){return this.getJoint("ring-finger-tip",t)}getPinkyTip(t=te.NONE){return this.getJoint("pinky-finger-tip",t)}getWrist(t=te.NONE){return this.getJoint("wrist",t)}toString(){let t="";return[te.LEFT,te.RIGHT].forEach((e=>{const i=this.hands[e];i&&i.joints?Zt.forEach((s=>{const n=i.joints[s];n?n.position?t+=`${e} - ${s}: ${n.position.x.toFixed(3)}, ${n.position.y.toFixed(3)}, ${n.position.z.toFixed(3)}\n`:t+=`${e} - ${s}: Position unavailable\n`:t+=`${e} - ${s}: Joint unavailable\n`})):t+=`${e} Hand: Data unavailable\n`})),t}toPositionQuaternionArray(){const t=[],e=[te.LEFT,te.RIGHT],i=Zt.length;e.forEach((e=>{const i=this.hands[e],s=i&&i.joints;Zt.forEach((e=>{const n=s?i.joints[e]:null;if(n&&n.position&&n.quaternion)t.push(n.position.x,n.position.y,n.position.z),t.push(n.quaternion.x,n.quaternion.y,n.quaternion.z,n.quaternion.w);else for(let e=0;e<7;e++)t.push(0)}))}));const s=e.length*i*7;if(t.length!==s)for(console.error(`XRHands.toPositionQuaternionArray: Output array size mismatch. Expected ${s}, got ${t.length}. Padding with zeros.`);t.length<s;)t.push(0);return t}isValid(t){return!(!this.hands||!Array.isArray(this.hands)||2!==this.hands.length)&&(0===t||1===t?!!this.hands[t]:!!this.hands[te.LEFT]&&!!this.hands[te.RIGHT])}}const ie={uniforms:{uColor:{value:(new t.Color).setHex(16777215)},uPressed:{value:0}},vertexShader:"\n  varying vec2 vTexCoord;\n\n  void main() {\n    vTexCoord = uv;\n    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n    // Makes the position slightly closer to avoid z fighting.\n    gl_Position.z -= 0.1;\n  }\n",fragmentShader:'\n  precision mediump float;\n\n  uniform sampler2D uDepthTexture;\n  uniform vec3 uColor;\n  uniform float uPressed;\n\n  varying vec2 vTexCoord;\n\n  void main(void) {\n    // Distance from center of quad.\n    highp float dist = distance(vTexCoord, vec2(0.5f, 0.5f));\n    if (dist > 0.45) discard;\n\n    // Get the rate of change of dist on x and y.\n    highp vec2 dist_grad = vec2(dFdx(dist), dFdy(dist));\n    highp float grad_magnitude = length(dist_grad);\n    highp float antialias_dist = max(grad_magnitude, 0.001f);\n\n    // Outer radius is 0.5, but we want to bring it in a few pixels so we have room\n    // for a gradient outward to anti-alias the circle.\n    // These "few pixels" are determined by our derivative calculation above.\n    highp float outerradius = 0.5f - antialias_dist;\n    highp float delta_to_outer = dist - outerradius;\n    highp float clamped_outer_delta = clamp(delta_to_outer, 0.0f, antialias_dist);\n    highp float outer_alpha = 1.0f - (clamped_outer_delta / antialias_dist);\n\n    // #FFFFFF = (1,1,1)\n    // #FFFFFF with 0.5 alpha = (((1,1,1) * 0.5), 0.5)\n    vec4 inner_base_color = vec4(0.5 * uColor, 0.5);\n    vec4 pressed_inner_color = vec4(uColor, 1.0);\n    // #505050 = (0.077,0.077,0.077)\n    // #505050 with 0.7 alpha = (((0.077,0.077,0.077)*0.7), 0.7)\n    const vec4 inner_gradient_color = vec4(0.054, 0.054, 0.054, 1.0);\n    const vec4 outer_ring_color = vec4(0.077, 0.077, 0.077, 1.0);\n    // 0.5 - stoke_width (0.75dp = 0.04 approx)\n    const float gradient_end = 0.46;\n    // 73% of gradient_end\n    const float gradient_start = 0.33;\n    // gradient_end - 130% stoke_width. Additional 30% to account for the down scaling.\n    const float pressed_inner_radius = 0.41;\n\n    vec4 unpressed_inner_color =\n            mix(inner_base_color, inner_gradient_color,\n                    smoothstep(gradient_start, gradient_end, dist));\n    vec4 unpressed_color =\n            mix(unpressed_inner_color, outer_ring_color,\n                    step(gradient_end, dist));\n\n    // Builds a smooth gradient to fade between colors.\n    highp float smooth_distance = antialias_dist * 4.0;\n    float percent_to_inner_rad = max(pressed_inner_radius - dist, 0.0) / pressed_inner_radius;\n    highp float pressed_color_t = 1.0 - percent_to_inner_rad;\n    pressed_color_t -= (1.0 - smooth_distance);\n    pressed_color_t *= (1.0 / smooth_distance);\n    pressed_color_t = clamp(pressed_color_t, 0.0, 1.0);\n    vec4 pressed_color = mix(pressed_inner_color, outer_ring_color, pressed_color_t);\n\n    vec4 final_color = mix(unpressed_color, pressed_color, uPressed);\n    gl_FragColor = final_color * outer_alpha;\n    // Converts to straight alpha.\n    gl_FragColor.rgb = gl_FragColor.rgb / max(gl_FragColor.a, 0.001);\n  }\n'};class se extends t.Mesh{constructor(e=.8,i=.001,s=.019,n=!1){const r=new t.CircleGeometry(s,32);r.applyMatrix4((new t.Matrix4).makeTranslation(0,0,i)),super(r,new t.ShaderMaterial({uniforms:t.UniformsUtils.clone(ie.uniforms),vertexShader:ie.vertexShader,fragmentShader:ie.fragmentShader,depthTest:n,transparent:!0})),this.name="Reticle",this.ignoreReticleRaycast=!0,this.direction=new t.Vector3,this.renderOrder=1e3,this.originalNormal=new t.Vector3(0,0,1),this.newRotation=new t.Quaternion,this.objectRotation=new t.Quaternion,this.normalVector=new t.Vector3,this.rotationSmoothing=e,this.offset=i}setRotationFromNormalVector(t){const e=this.originalNormal.angleTo(t);this.originalNormal.cross(t).normalize(),this.newRotation.setFromAxisAngle(this.originalNormal,e),this.originalNormal.set(0,0,1),this.quaternion.slerp(this.newRotation,1-this.rotationSmoothing)}setPoseFromIntersection(t){t&&t.normal&&(this.intersection=t,this.position.copy(t.point),t.object.getWorldQuaternion(this.objectRotation),this.normalVector.copy(t.normal).applyQuaternion(this.objectRotation),this.setRotationFromNormalVector(this.normalVector))}setColor(t){this.material.uniforms.uColor.value.set(t)}getColor(){return this.material.uniforms.uColor.value}setPressed(t){this.material.uniforms.uPressed.value=t?1:0,this.scale.setScalar(t?.7:1)}setPressedAmount(t){this.material.uniforms.uPressed.value=t,this.scale.setScalar(R(1,.7,t))}raycast(){}}class ne extends t.Line{constructor(){super((new t.BufferGeometry).setFromPoints([new t.Vector3(0,0,0),new t.Vector3(0,0,-1)])),this.scale.z=5}raycast(){}}class re{constructor(t=0,e=0,i=1,s=1){this.value=t,this.minValue=e,this.maxValue=i,this.speed=s}update(t){this.value=T(this.value+t*this.speed,this.minValue,this.maxValue)}}class oe extends S{constructor(){super(...arguments),this.userData={connected:!1,id:2,selected:!1},this.reticle=new se,this.activationTimeSeconds=1.5,this.activationAmount=new re(0,0,1,1/this.activationTimeSeconds),this.lastReticlePosition=new t.Vector3,this.clock=new t.Clock}static{this.dependencies={camera:t.Camera}}init({camera:t}){this.camera=t}update(){super.update(),this.position.copy(this.camera.position),this.quaternion.copy(this.camera.quaternion),this.updateMatrixWorld();const t=this.clock.getDelta();this.activationAmount.update(t);this.lastReticlePosition.distanceTo(this.reticle.position)/t>.2&&(this.activationAmount.value=0,this.userData.selected&&this.callSelectEnd(),this.userData.selected=!1),1!=this.activationAmount.value||this.userData.selected||this.callSelectStart(),this.updateReticleScale(),this.lastReticlePosition.copy(this.reticle.position)}updateReticleScale(){this.reticle.setPressedAmount(this.activationAmount.value)}callSelectStart(){this.dispatchEvent({type:"selectstart",target:this})}callSelectEnd(){this.dispatchEvent({type:"selectend",target:this})}connect(){this.dispatchEvent({type:"connected",target:this})}disconnect(){this.dispatchEvent({type:"disconnected",target:this})}}class ae extends S{static{this.dependencies={camera:t.Camera}}constructor(){super(),this.userData={id:3,connected:!1,selected:!1},this.raycaster=new t.Raycaster,this.forwardVector=new t.Vector3(0,0,-1)}init({camera:t}){this.camera=t}update(){super.update(),this.userData.connected&&this.position.copy(this.camera.position)}updateMousePositionFromEvent(e){this.position.copy(this.camera.position);const i=new t.Vector2;i.x=e.clientX/window.innerWidth*2-1,i.y=-e.clientY/window.innerHeight*2+1,this.raycaster.setFromCamera(i,this.camera);const s=this.raycaster.ray.direction;this.quaternion.setFromUnitVectors(this.forwardVector,s),this.updateMatrixWorld()}callSelectStart(){this.dispatchEvent({type:"selectstart",target:this})}callSelectEnd(){this.dispatchEvent({type:"selectend",target:this})}connect(){this.dispatchEvent({type:"connected",target:this})}disconnect(){this.dispatchEvent({type:"disconnected",target:this})}}class he extends t.Object3D{}const le=new t.Matrix4;class ce{constructor(){this.controllers=[],this.controllerGrips=[],this.hands=[],this.raycaster=new t.Raycaster,this.initialized=!1,this.pivotsEnabled=!1,this.gazeController=new oe,this.mouseController=new ae,this.controllersEnabled=!0,this.listeners=new Map,this.intersectionsForController=new Map,this.intersections=[],this.activeControllers=new he}init({scene:t,options:e,renderer:i}){t.add(this.activeControllers),this.options=e,this.scene=t;const r=this.controllers,o=this.controllerGrips;for(let t=0;t<2;++t)r.push(i.xr.getController(t)),r[t].userData.id=t,this.activeControllers.add(this.controllers[t]);r.push(this.gazeController),r.push(this.mouseController),this.activeControllers.add(this.mouseController);for(const t of r)this.intersectionsForController.set(t,[]);if(e.controllers.enabled){if(e.controllers.visualization){const t=new s;for(let e=0;e<2;++e)o.push(i.xr.getControllerGrip(e)),o[e].add(t.createControllerModel(o[e])),this.activeControllers.add(o[e])}if(e.hands.enabled){for(let t=0;t<2;++t)this.hands.push(i.xr.getHand(t)),this.activeControllers.add(this.hands[t]);if(e.hands.visualization){if(e.hands.visualizeJoints){console.log("Visualize hand joints.");const t=new n;for(let e=0;e<2;++e){const i=t.createHandModel(this.hands[e],"boxes");i.ignoreReticleRaycast=!0,this.hands[e].add(i)}}if(e.hands.visualizeMeshes){console.log("Visualize hand meshes.");const t=new n;for(let e=0;e<2;++e){const i=t.createHandModel(this.hands[e],"mesh");i.ignoreReticleRaycast=!0,this.hands[e].add(i)}}}}}if(e.controllers.visualizeRays)for(let t=0;t<2;++t)r[t].add(new ne);this.bindSelectStart(this.defaultOnSelectStart.bind(this)),this.bindSelectEnd(this.defaultOnSelectEnd.bind(this)),this.bindSqueezeStart(this.defaultOnSelectStart.bind(this)),this.bindSqueezeEnd(this.defaultOnSelectEnd.bind(this)),this.bindListener("connected",this.defaultOnConnected.bind(this)),this.bindListener("disconnected",this.defaultOnDisconnected.bind(this))}get(t){return this.controllers[t]}addObject(e){const i=new t.Group;i.add(e);for(let t=0;t<this.controllers.length;++t)this.controllers[t].add(i.clone())}enablePivots(){if(this.pivotsEnabled)return;this.pivotsEnabled=!0;const e=new t.Mesh(new t.IcosahedronGeometry(.01,3));e.name="pivot",e.position.z=-.05,this.addObject(e)}addReticles(){let t=0;for(const e of this.controllers)null==e.reticle&&(e.reticle=new se,e.reticle.name="Reticle "+t,++t),e.reticle.visible=!1,this.scene.add(e.reticle)}defaultOnSelectStart(t){const e=t.target;e.userData.selected=!0,this._setRaycasterFromController(e),this.performRaycastOnScene(e)}defaultOnSelectEnd(t){t.target.userData.selected=!1}defaultOnSqueezeStart(t){t.target.userData.squeezing=!0}defaultOnSqueezeEnd(t){t.target.userData.squeezing=!1}defaultOnConnected(t){const e=t.target;switch(e.userData.connected=!0,e.gamepad=t.data?.gamepad,e.inputSource=t.data,t.data?.handedness){case"left":this.leftController=e;break;case"right":this.rightController=e}}defaultOnDisconnected(t){const e=t.target;switch(e.userData.connected=!1,e.reticle&&(e.reticle.visible=!1),delete e?.gamepad,t.data?.handedness){case"left":this.leftController=void 0;break;case"right":this.rightController=void 0}}bindListener(t,e){for(const i of this.controllers)i.addEventListener(t,e);this.listeners.has(t)||this.listeners.set(t,[]),this.listeners.get(t).push(e)}unbindListener(t,e){if(this.listeners.has(t)){const i=this.listeners.get(t),s=i.indexOf(e);-1!==s&&i.splice(s,1)}for(const i of this.controllers)i.removeEventListener(t,e)}dispatchEvent(t){if(this.listeners.has(t.type))for(const e of this.listeners.get(t.type))e(t)}bindSelectStart(t){this.bindListener("selectstart",t)}bindSelectEnd(t){this.bindListener("selectend",t)}bindSelect(t){this.bindListener("select",t)}bindSqueezeStart(t){this.bindListener("squeezestart",t)}bindSqueezeEnd(t){this.bindListener("squeezeend",t)}bindSqueeze(t){this.bindListener("squeeze",t)}bindKeyDown(t){window.addEventListener("keydown",t)}bindKeyUp(t){window.addEventListener("keyup",t)}unbindKeyDown(t){window.removeEventListener("keydown",t)}unbindKeyUp(t){window.removeEventListener("keyup",t)}intersectObjectByController(t,e){return t.updateMatrixWorld(),this.raycaster.setFromXRController(t),this.raycaster.intersectObject(e,!1)}intersectObjectByEvent(t,e){return this.intersectObjectByController(t.target,e)}intersectObject(t){const e=this.intersectObjectByController(this.controllers[0],t);return e.length>0?e:this.intersectObjectByController(this.controllers[1],t)}update(){if(this.controllersEnabled)for(const t of this.controllers)this.updateController(t)}updateController(t){!1!==t.userData.connected&&(t.updateMatrixWorld(),this._setRaycasterFromController(t),this.performRaycastOnScene(t),this.updateReticleFromIntersections(t))}_setRaycasterFromController(t){t.getWorldPosition(this.raycaster.ray.origin),le.identity().extractRotation(t.matrixWorld),this.raycaster.ray.direction.set(0,0,-1).applyMatrix4(le).normalize()}updateReticleFromIntersections(t){if(!t.reticle)return;const e=t.reticle,i=this.intersectionsForController.get(t)?.find((t=>{let e=t.object;for(;e;){if(!0===e.ignoreReticleRaycast)return!1;e=e.parent}return!0}));i?(e.visible=!0,i.object?.isXRScript?i.object.ux.update(t,i):i.object?.parent?.isXRScript&&i.object.parent.ux.update(t,i),e.intersection=i,e.direction.copy(this.raycaster.ray.direction).normalize(),e.setPoseFromIntersection(i),e.setPressed(t.userData.selected)):e.visible=!1}enableGazeController(){this.activeControllers.add(this.gazeController),this.gazeController.connect()}disableGazeController(){this.gazeController.disconnect(),this.activeControllers.remove(this.gazeController)}disableControllers(){this.controllersEnabled=!1;for(const t of this.controllers)t.userData.selected=!1,t.reticle&&(t.reticle.visible=!1,t.reticle.targetObject=void 0)}enableControllers(){this.controllersEnabled=!0}performRaycastOnScene(t){this.intersectionsForController.has(t)||this.intersectionsForController.set(t,[]);const e=this.intersectionsForController.get(t);e.length=0,this.raycaster.intersectObject(this.scene,!0,e)}}class de{constructor(){if(this.dirLight=new t.DirectionalLight,this.ambientProbe=new t.LightProbe,this.ambientLight=new t.Vector3,this.shadowOpacity=0,this.lightGroup=new t.Group,this.simulatorRunning=!1,de.instance)return de.instance;de.instance=this}init(e,i,s,n){if(this.options=e,this.depth=n,this.options.enabled){if(this.xrLight=new r(i),this.options.castDirectionalLightShadow&&(i.shadowMap.enabled=!0,i.shadowMap.type=t.PCFShadowMap),this.options.castDirectionalLightShadow){const e=this.dirLight;e.castShadow=!0,e.shadow.mapSize.width=2048,e.shadow.mapSize.height=2048,e.shadow.camera.near=.3,e.shadow.camera.far=50;const i=4;e.shadow.camera.left=-4,e.shadow.camera.right=i,e.shadow.camera.top=i,e.shadow.camera.bottom=-4,e.shadow.blurSamples=25,e.shadow.radius=5,e.shadow.bias=0,this.lightGroup.add(e.target),this.options.debugging&&s.add(new t.CameraHelper(e.shadow.camera))}this.options.useAmbientSH&&this.lightGroup.add(this.ambientProbe),this.options.useDirectionalLight&&this.lightGroup.add(this.dirLight),s.add(this.lightGroup),this.xrLight.addEventListener("estimationend",(()=>{s.remove(this.xrLight)}))}}update(){if(this.options.enabled&&(this.dirLight.position.copy(this.xrLight.directionalLight.position).multiplyScalar(20),this.dirLight.target.position.setScalar(0),this.dirLight.color=this.xrLight.directionalLight.color,this.dirLight.intensity=this.xrLight.directionalLight.intensity,this.ambientProbe.sh.copy(this.xrLight.lightProbe.sh),this.ambientProbe.intensity=this.xrLight.lightProbe.intensity,this.ambientLight.copy(this.xrLight.lightProbe.sh.coefficients[0]),this.simulatorRunning&&(this.dirLight.position.set(-10,10,-2),this.dirLight.target.position.set(0,0,-.5),this.dirLight.color.setHex(16777215),this.dirLight.intensity=3.8,this.ambientProbe.sh.fromArray([.22636516392230988,.2994415760040283,.2827182114124298,.03430574759840965,.029604531824588776,-.002050594426691532,.016114741563796997,.004344218410551548,.07621686905622482,.024204734712839127,-.02397896535694599,-.07645703107118607,.15790101885795593,.16706973314285278,.18418270349502563,-.13088643550872803,-.1461198776960373,-.1411236822605133,.04788218438625336,.08909443765878677,.10185115039348602,.020251473411917686,-.002100071171298623,-.06455840915441513,-.12393051385879517,-.05158703774213791,-.00532124936580658]),this.ambientProbe.intensity=1,this.ambientLight.copy(this.ambientProbe.sh.coefficients[0])),this.options.castDirectionalLightShadow&&this.options.useDynamicSoftShadow)){const e=this.ambientLight,i=.21*e.x+.72*e.y+.07*e.z,s=new t.Vector3(this.dirLight.color.r,this.dirLight.color.g,this.dirLight.color.b).multiplyScalar(this.dirLight.intensity),n=i/(.21*s.x+.72*s.y+.07*s.z);this.dirLight.shadow.radius=Math.min(Math.max(1,30*n),10),this.shadowOpacity=Math.max(Math.min(.7*(10-30*n),.7),.3),this.depth?.options?.enabled&&this.depth.options.depthMesh.enabled&&this.depth.depthMesh?.material instanceof t.ShadowMaterial&&(this.depth.depthMesh.material.opacity=this.shadowOpacity)}this.options.debugging&&this.debugLog()}debugLog(){console.log("Lighting.dirLight",this.dirLight),console.log("Lighting.ambientProbe",this.ambientProbe),console.log("Lighting.ambientLight",this.ambientLight)}}class ue{constructor(){this.initialized=!1,this.fps=0}get timestep(){return 1/this.fps}async init({physicsOptions:t}){this.options=t,this.RAPIER=this.options.RAPIER,this.fps=this.options.fps,this.RAPIER.init&&await this.RAPIER.init(),this.blendedWorld=new this.RAPIER.World(this.options.gravity),this.blendedWorld.timestep=this.timestep,this.options.useEventQueue&&(this.eventQueue=new this.RAPIER.EventQueue(!0)),this.initialized=!0}physicsStep(){this.options?.worldStep&&this.blendedWorld&&this.blendedWorld.step(this.eventQueue)}dispose(){this.eventQueue&&this.eventQueue.free(),this.blendedWorld&&this.blendedWorld.free()}}class pe{constructor(t){this.enabled=!1,this.visualization=!1,this.visualizeJoints=!1,this.visualizeMeshes=!1,this.debugging=!1,lt(this,t)}enableHands(){return this.enabled=!0,this}enableHandsVisualization(){return this.enabled=!0,this.visualization=!0,this}}class ge{constructor(t){this.debugging=!1,this.enabled=!1,this.useAmbientSH=!1,this.useDirectionalLight=!1,this.castDirectionalLightShadow=!1,this.useDynamicSoftShadow=!1,lt(this,t)}}class me{constructor(){this.fps=45,this.gravity={x:0,y:-9.81,z:0},this.worldStep=!0,this.useEventQueue=!1}}var fe;!function(t){t.USER="User",t.POSE="Navigation",t.CONTROLLER="Hands"}(fe||(fe={}));const ve={[fe.USER]:fe.POSE,[fe.POSE]:fe.CONTROLLER,[fe.CONTROLLER]:fe.USER};class ye{constructor(t){this.initialCameraPosition={x:0,y:1.5,z:0},this.scenePath=at+"simulator/scenes/XREmulatorsceneV5_livingRoom.glb",this.initialScenePosition={x:-1.6,y:.3,z:0},this.defaultMode=fe.USER,this.defaultHand=te.LEFT,this.modeIndicator={enabled:!0,element:"xrblocks-simulator-mode-indicator"},this.instructions={enabled:!0,element:"xrblocks-simulator-instructions",customInstructions:[]},this.handPosePanel={enabled:!0,element:"xrblocks-simulator-hand-pose-panel"},this.geminilive=!1,this.stereo={enabled:!1},this.renderToRenderTexture=!0,this.blendingMode="normal",lt(this,t)}}class we{constructor(){this.enabled=!1,this.allowInterruptions=!1}}class xe{constructor(){this.enabled=!0,this.lang="en-US",this.continuous=!1,this.commands=[],this.interimResults=!1,this.commandConfidenceThreshold=.7,this.playSimulatorActivationSounds=!0}}class Se{constructor(){this.speechSynthesizer=new we,this.speechRecognizer=new xe}}class be{constructor(t){this.debugging=!1,this.enabled=!1,this.showDebugVisualizations=!1,this.objectImageMargin=.05,this.backendConfig={activeBackend:"gemini",gemini:{systemInstruction:"Please provide me with the bounding box coordinates for the primary objects in the given image, prioritizing objects that are nearby. For each bounding box, include ymin, xmin, ymax, and xmax. These coordinates should be absolute values ranging from 0 to 1000, corresponding to the image as if it were resized to 1000x1000 pixels. The origin (xmin:0; ymin:0) is the top-left corner of the image, and (xmax:1000; ymax:1000) is the bottom-right corner. List a maximum of 5 objects. Ignore hands and other human body parts, as well as any UI elements attached to them (e.g., a blue circle attached to a finger).",responseSchema:{type:"ARRAY",items:{type:"OBJECT",required:["objectName","ymin","xmin","ymax","xmax"],properties:{objectName:{type:"STRING"},ymin:{type:"NUMBER"},xmin:{type:"NUMBER"},ymax:{type:"NUMBER"},xmax:{type:"NUMBER"}}}}},mediapipe:{}},t&&lt(this,t)}enable(){return this.enabled=!0,this}}class Ce{constructor(t){this.debugging=!1,this.enabled=!1,this.showDebugVisualizations=!1,t&&lt(this,t)}enable(){return this.enabled=!0,this}}class Te{constructor(t){this.debugging=!1,this.enabled=!1,this.planes=new Ce,this.objects=new be,t&&lt(this,t)}enablePlaneDetection(){return this.enabled=!0,this.planes.enable(),this}enableObjectDetection(){return this.enabled=!0,this.objects.enable(),this}}class Re{constructor(){this.enabled=!0,this.enabledMouse=!0,this.debug=!1,this.visualization=!1,this.visualizeRays=!1}}class Me{constructor(){this.enabled=!0}}class De{constructor(){this.enabled=!1,this.transitionTime=.5,this.defaultBackgroundColor=16777215}}class Ee{constructor(t){this.antialias=!0,this.logarithmicDepthBuffer=!1,this.debugging=!1,this.stencil=!1,this.webxrRequiredFeatures=[],this.referenceSpaceType="local-floor",this.controllers=new Re,this.depth=new xt,this.lighting=new ge,this.deviceCamera=new ct,this.hands=new pe,this.reticles=new Me,this.sound=new Se,this.ai=new F,this.simulator=new ye,this.world=new Te,this.physics=new me,this.transition=new De,this.camera={near:.01,far:500},this.usePostprocessing=!1,this.xrButton={enabled:!0,startText:"Enter XR",endText:"Exit XR",invalidText:"XR Not Supported",startSimulatorText:"Enter Simulator",enableSimulator:!0,showSimulatorButtonOnMobile:!1,autostartSimulatorOnDesktop:!0,autostartSimulator:!1},lt(this,t)}enableUI(){return this.antialias=!0,this.reticles.enabled=!0,this}enableReticles(){return this.reticles.enabled=!0,this}enableDepth(){return this.depth=new xt(St),this}enablePlaneDetection(){return this.world.enablePlaneDetection(),this}enableObjectDetection(){return this.world.enableObjectDetection(),this}enableCamera(t="environment"){return this.deviceCamera=new ct("environment"===t?ut:pt),this}enableHands(){return this.hands.enabled=!0,this}enableHandRays(){return this.controllers.visualizeRays=!0,this}enableGeminiLive(){return this.simulator.geminilive=!0,this}enableAI(){return this.ai.enabled=!0,this.ai.gemini.enabled=!0,this.ai.gemini.live.enabled=!0,this}enableXRTransitions(){return this.transition.enabled=!0,this}}class _e{constructor(t="simulator",e="simulator",i="videoinput",s="Simulator Camera"){this.deviceId=t,this.groupId=e,this.kind=i,this.label=s}}var Pe;!function(t){t[t.EXACT=0]="EXACT",t[t.IDEAL=1]="IDEAL",t[t.ACCEPTABLE=2]="ACCEPTABLE",t[t.UNACCEPTABLE=3]="UNACCEPTABLE"}(Pe||(Pe={}));class Oe{constructor(e){this.renderer=e,this.cameraCreated=!1,this.fps=30,this.matchRenderingCamera=!0,this.width=512,this.height=512,this.camera=new t.PerspectiveCamera}init(){this.createSimulatorCamera()}createSimulatorCamera(){if(this.cameraCreated)return;this.canvas=document.createElement("canvas"),this.canvas.width=this.width,this.canvas.height=this.height,this.context=this.canvas.getContext("2d"),this.mediaStream=this.canvas.captureStream(this.fps);const t=this.mediaStream.getVideoTracks()[0],e=this.mediaStream.getVideoTracks()[0].getSettings().deviceId;this.cameraInfo=new _e(e),t.stop(),this.cameraCreated=!0}async enumerateDevices(){return this.cameraInfo?[this.cameraInfo]:[]}onBeforeSimulatorSceneRender(t,e){if(this.cameraCreated&&!this.matchRenderingCamera){this.camera.position.copy(t.position),this.camera.quaternion.copy(t.quaternion),e(this.camera);const i=this.renderer.domElement.width,s=this.renderer.domElement.height,n=this.width/this.height,r=Math.min(i,s*n),o=Math.min(s,i/n),a=(i-r)/2,h=(s-o)/2;this.context.drawImage(this.renderer.domElement,a,h,r,o,0,0,this.width,this.height)}}onSimulatorSceneRendered(){if(this.cameraCreated&&this.matchRenderingCamera){const t=this.renderer.domElement.width,e=this.renderer.domElement.height,i=this.width/this.height,s=Math.min(t,e*i),n=Math.min(e,t/i),r=(t-s)/2,o=(e-n)/2;this.context.drawImage(this.renderer.domElement,r,o,s,n,0,0,this.width,this.height)}}restartVideoTrack(){if(!this.cameraCreated)return;this.mediaStream=this.canvas.captureStream(this.fps);const t=this.mediaStream.getVideoTracks()[0].getSettings().deviceId;this.cameraInfo.deviceId=t||""}getMedia(t={}){if(this.cameraCreated){if(!t?.deviceId||function(t,e){const i=(t,e)=>"string"==typeof t?e===t:t.includes(e);return null==t?Pe.ACCEPTABLE:"string"==typeof t||Array.isArray(t)?i(t,e)?Pe.EXACT:Pe.UNACCEPTABLE:"object"==typeof t?void 0!==t.exact?i(t.exact,e)?Pe.EXACT:Pe.UNACCEPTABLE:void 0!==t.ideal&&i(t.ideal,e)?Pe.IDEAL:Pe.ACCEPTABLE:Pe.UNACCEPTABLE}(t?.deviceId,this.cameraInfo.deviceId)!=Pe.UNACCEPTABLE){return"ended"==this.mediaStream.getVideoTracks()[0].readyState&&this.restartVideoTrack(),this.mediaStream}return null}}}const Ae=.063;var Ie,Le;!function(t){t.DEFAULT="default",t.STEREO_LEFT="left",t.STEREO_RIGHT="right"}(Ie||(Ie={}));class Ve{constructor(){this.localControllerPositions=[new t.Vector3(-.3,-.1,-.3),new t.Vector3(.3,-.1,-.3)],this.localControllerOrientations=[new t.Quaternion,new t.Quaternion],this.currentControllerIndex=0}}!function(t){t.W_CODE="KeyW",t.A_CODE="KeyA",t.S_CODE="KeyS",t.D_CODE="KeyD",t.UP="ArrowUp",t.DOWN="ArrowDown",t.LEFT="ArrowLeft",t.RIGHT="ArrowRight",t.Q_CODE="KeyQ",t.E_CODE="KeyE",t.PAGE_UP="PageUp",t.PAGE_DOWN="PageDown",t.SPACE_CODE="Space",t.ENTER_CODE="Enter",t.T_CODE="KeyT",t.LEFT_SHIFT_CODE="ShiftLeft",t.RIGHT_SHIFT_CODE="ShiftRight",t.LEFT_CTRL_CODE="ControlLeft",t.RIGHT_CTRL_CODE="ControlRight",t.LEFT_ALT_CODE="AltLeft",t.RIGHT_ALT_CODE="AltRight",t.CAPS_LOCK_CODE="CapsLock",t.ESCAPE_CODE="Escape",t.TAB_CODE="Tab",t.B_CODE="KeyB",t.C_CODE="KeyC",t.F_CODE="KeyF",t.G_CODE="KeyG",t.H_CODE="KeyH",t.I_CODE="KeyI",t.J_CODE="KeyJ",t.K_CODE="KeyK",t.L_CODE="KeyL",t.M_CODE="KeyM",t.N_CODE="KeyN",t.O_CODE="KeyO",t.P_CODE="KeyP",t.R_CODE="KeyR",t.U_CODE="KeyU",t.V_CODE="KeyV",t.X_CODE="KeyX",t.Y_CODE="KeyY",t.Z_CODE="KeyZ",t.DIGIT_0="Digit0",t.DIGIT_1="Digit1",t.DIGIT_2="Digit2",t.DIGIT_3="Digit3",t.DIGIT_4="Digit4",t.DIGIT_5="Digit5",t.DIGIT_6="Digit6",t.DIGIT_7="Digit7",t.DIGIT_8="Digit8",t.DIGIT_9="Digit9",t.BACKQUOTE="Backquote"}(Le||(Le={}));const{A_CODE:Be,D_CODE:Fe,E_CODE:ze,Q_CODE:je,S_CODE:ke,W_CODE:Ue}=Le,Ne=new t.Vector3,Ge=new t.Euler;class He{constructor(t,e,i,s,n){this.simulatorControllerState=t,this.downKeys=e,this.hands=i,this.setStereoRenderMode=s,this.toggleUserInterface=n}init({camera:t,input:e,timer:i}){this.camera=t,this.input=e,this.timer=i}onPointerDown(t){}onPointerUp(t){}onPointerMove(t){}onKeyDown(t){t.code==Le.DIGIT_1?this.setStereoRenderMode(Ie.STEREO_LEFT):t.code==Le.DIGIT_2?this.setStereoRenderMode(Ie.STEREO_RIGHT):t.code==Le.BACKQUOTE&&this.toggleUserInterface()}onModeActivated(){}onModeDeactivated(){}update(){this.updateCameraPosition(),this.updateControllerPositions()}updateCameraPosition(){const t=this.timer.getDelta(),e=this.camera.quaternion,i=this.camera.position,s=this.downKeys;Ne.set(Number(s.has(Fe))-Number(s.has(Be)),Number(s.has(je))-Number(s.has(ze)),Number(s.has(ke))-Number(s.has(Ue))).multiplyScalar(t).applyQuaternion(e),i.add(Ne)}updateControllerPositions(){this.camera.updateMatrixWorld();for(let t=0;t<2;t++){const e=this.input.controllers[t];e.position.copy(this.simulatorControllerState.localControllerPositions[t]).applyMatrix4(this.camera.matrixWorld),e.quaternion.copy(this.simulatorControllerState.localControllerOrientations[t]).premultiply(this.camera.quaternion),e.updateMatrix();const i=0==t?this.hands.leftController:this.hands.rightController;i.position.copy(e.position),i.quaternion.copy(e.quaternion)}}rotateOnPointerMove(t,e,i=.002){Ge.setFromQuaternion(e,"YXZ"),Ge.y+=t.movementX*i,Ge.x+=t.movementY*i;const s=Math.PI/2;Ge.x=Math.max(.01-s,Math.min(s-.01,Ge.x)),e.setFromEuler(Ge)}enableSimulatorHands(){this.hands.showHands(),this.input.dispatchEvent({type:"connected",target:this.input.controllers[0],data:{handedness:"left"}}),this.input.dispatchEvent({type:"connected",target:this.input.controllers[1],data:{handedness:"right"}})}disableSimulatorHands(){this.hands.hideHands(),this.input.dispatchEvent({type:"disconnected",target:this.input.controllers[0],data:{handedness:"left"}}),this.input.dispatchEvent({type:"disconnected",target:this.input.controllers[1],data:{handedness:"right"}})}}const We=new t.Vector3,{A_CODE:qe,D_CODE:Xe,E_CODE:Ke,Q_CODE:$e,S_CODE:Qe,SPACE_CODE:Ye,T_CODE:Je,W_CODE:Ze}=Le;class ti extends He{onPointerMove(t){if(t.buttons){const e=this.simulatorControllerState.localControllerOrientations[this.simulatorControllerState.currentControllerIndex];this.rotateOnPointerMove(t,e,-.002)}}update(){this.updateControllerPositions()}onModeActivated(){this.enableSimulatorHands()}updateControllerPositions(){const t=this.timer.getDelta(),e=this.downKeys;We.set(Number(e.has(Xe))-Number(e.has(qe)),Number(e.has($e))-Number(e.has(Ke)),Number(e.has(Qe))-Number(e.has(Ze))).multiplyScalar(t),this.simulatorControllerState.localControllerPositions[this.simulatorControllerState.currentControllerIndex].add(We),super.updateControllerPositions()}toggleControllerIndex(){this.hands.toggleHandedness()}onKeyDown(t){if(super.onKeyDown(t),t.code==Je)this.toggleControllerIndex();else if(t.code==Ye){const t=this.input.controllers[this.simulatorControllerState.currentControllerIndex].userData?.selected,e=!t;0==this.simulatorControllerState.currentControllerIndex?this.hands.setLeftHandPinching(e):this.hands.setRightHandPinching(e)}}}class ei extends He{onModeActivated(){this.enableSimulatorHands()}onPointerMove(t){t.buttons&&this.rotateOnPointerMove(t,this.camera.quaternion)}}class ii extends He{onModeActivated(){this.disableSimulatorHands(),this.input.mouseController.connect()}onModeDeactivated(){this.input.mouseController.disconnect()}onPointerDown(t){1&t.buttons&&this.input.mouseController.callSelectStart()}onPointerUp(){this.input.mouseController.userData.selected&&this.input.mouseController.callSelectEnd()}onPointerMove(t){this.input.mouseController.updateMousePositionFromEvent(t),2&t.buttons&&this.rotateOnPointerMove(t,this.camera.quaternion)}}class si extends Event{static{this.type="setSimulatorMode"}constructor(t){super(si.type,{bubbles:!0,composed:!0}),this.simulatorMode=t}}function ni(t){t.preventDefault()}class ri{constructor(t,e,i,s){this.simulatorControllerState=t,this.hands=e,this.userInterface=s,this.pointerDown=!1,this.downKeys=new Set,this.simulatorMode=fe.USER,this._onPointerDown=this.onPointerDown.bind(this),this._onPointerUp=this.onPointerUp.bind(this),this._onKeyDown=this.onKeyDown.bind(this),this._onKeyUp=this.onKeyUp.bind(this),this._onPointerMove=this.onPointerMove.bind(this);const n=()=>{this.userInterface.toggleInterfaceVisible()};this.simulatorModes={[fe.USER]:new ii(this.simulatorControllerState,this.downKeys,e,i,n),[fe.POSE]:new ei(this.simulatorControllerState,this.downKeys,e,i,n),[fe.CONTROLLER]:new ti(this.simulatorControllerState,this.downKeys,e,i,n)},this.simulatorModeControls=this.simulatorModes[this.simulatorMode]}init({camera:t,input:e,timer:i,renderer:s,simulatorOptions:n}){for(const s in this.simulatorModes)this.simulatorModes[s].init({camera:t,input:e,timer:i});this.renderer=s,this.setSimulatorMode(n.defaultMode),this.simulatorControllerState.currentControllerIndex=n.defaultHand===te.LEFT?0:1,this.connect()}connect(){const t=this.renderer.domElement;document.addEventListener("keyup",this._onKeyUp),document.addEventListener("keydown",this._onKeyDown),t.addEventListener("pointermove",this._onPointerMove),t.addEventListener("pointerdown",this._onPointerDown),t.addEventListener("pointerup",this._onPointerUp),t.addEventListener("contextmenu",ni)}update(){this.simulatorModeControls.update()}onPointerMove(t){this.simulatorModeControls.onPointerMove(t)}onPointerDown(t){this.simulatorModeControls.onPointerDown(t),this.pointerDown=!0}onPointerUp(t){this.simulatorModeControls.onPointerUp(t),this.pointerDown=!1}onKeyDown(t){this.downKeys.add(t.code),t.code==Le.LEFT_SHIFT_CODE&&this.setSimulatorMode(ve[this.simulatorMode]),this.simulatorModeControls.onKeyDown(t)}onKeyUp(t){this.downKeys.delete(t.code)}setSimulatorMode(t){this.simulatorMode=t,this.simulatorModeControls.onModeDeactivated(),this.simulatorModeControls=this.simulatorModes[this.simulatorMode],this.simulatorModeControls.onModeActivated(),this.modeIndicatorElement&&(this.modeIndicatorElement.simulatorMode=t)}setModeIndicatorElement(t){t.simulatorMode=this.simulatorMode,t.addEventListener("setSimulatorMode",(t=>{t instanceof si&&this.setSimulatorMode(t.simulatorMode)})),this.modeIndicatorElement=t}}class oi extends t.MeshBasicMaterial{onBeforeCompile(t){t.vertexShader=t.vertexShader.replace("#include <clipping_planes_pars_vertex>",["#include <clipping_planes_pars_vertex>","varying vec4 vViewCoordinates;"].join("\n")).replace("#include <project_vertex>",["#include <project_vertex>","vViewCoordinates = mvPosition;"].join("\n")),t.fragmentShader=t.fragmentShader.replace("#include <clipping_planes_pars_fragment>",["#include <clipping_planes_pars_fragment>","varying vec4 vViewCoordinates;"].join("\n")).replace("#include <dithering_fragment>",["#include <dithering_fragment>","gl_FragColor = vec4(-vViewCoordinates.z, 0.0, 0.0, 1.0);"].join("\n"))}}class ai{constructor(t){this.simulatorScene=t,this.depthWidth=160,this.depthHeight=160,this.depthBufferSlice=new Float32Array}init(t,e,i){this.renderer=t,this.camera=e,this.depth=i,this.createRenderTarget(),this.depthMaterial=new oi}createRenderTarget(){this.depthRenderTarget=new t.WebGLRenderTarget(this.depthWidth,this.depthHeight,{format:t.RedFormat,type:t.FloatType}),this.depthBuffer=new Float32Array(this.depthWidth*this.depthHeight)}update(){this.renderDepthScene(),this.updateDepth()}renderDepthScene(){const t=this.renderer.getRenderTarget();this.renderer.setRenderTarget(this.depthRenderTarget),this.simulatorScene.overrideMaterial=this.depthMaterial,this.renderer.render(this.simulatorScene,this.camera),this.simulatorScene.overrideMaterial=null,this.renderer.setRenderTarget(t)}updateDepth(){const t=this.renderer.getContext();t.bindBuffer(t.PIXEL_PACK_BUFFER,null),this.renderer.readRenderTargetPixels(this.depthRenderTarget,0,0,this.depthWidth,this.depthHeight,this.depthBuffer),this.depthBufferSlice.length!=this.depthWidth&&(this.depthBufferSlice=new Float32Array(this.depthWidth));for(let t=0;t<this.depthHeight/2;++t){const e=this.depthHeight-1-t,i=t*this.depthWidth,s=e*this.depthWidth;this.depthBufferSlice.set(this.depthBuffer.subarray(i,i+this.depthWidth)),this.depthBuffer.copyWithin(i,s,s+this.depthWidth),this.depthBuffer.set(this.depthBufferSlice,s)}const e={width:this.depthWidth,height:this.depthHeight,data:this.depthBuffer.buffer,rawValueToMeters:1};this.depth.updateDepthData(e,0)}}class hi extends Event{static{this.type="SimulatorHandPoseChangeRequestEvent"}constructor(t){super(hi.type,{bubbles:!0,composed:!0}),this.pose=t}}var li;!function(t){t.RELAXED="relaxed",t.PINCHING="pinching",t.FIST="fist",t.THUMBS_UP="thumbs_up",t.POINTING="pointing",t.ROCK="rock",t.THUMBS_DOWN="thumbs_down",t.VICTORY="victory"}(li||(li={}));const ci=Object.freeze({[li.RELAXED]:[{t:[-.05,-.08,-.1],r:[.5373,0,0,.8434]},{t:[-.0281,-.0594,-.1165],r:[.3943,-.2036,-.3103,.8407]},{t:[.0026,-.0299,-.1518],r:[.3476,-.1049,-.5285,.7674]},{t:[.0169,-.0181,-.1728],r:[.3521,.0515,-.635,.6857]},{t:[.0268,-.0018,-.1966],r:[.3521,.0515,-.635,.6857]},{t:[-.0369,-.0541,-.1121],r:[.5882,-.1036,.0205,.8018]},{t:[-.024,.0143,-.1465],r:[.3269,-.0887,-3e-4,.9409]},{t:[-.0172,.0394,-.1765],r:[-.0114,-.0813,-.0286,.9962]},{t:[-.0138,.0388,-.1986],r:[-.1994,-.0379,-.0372,.9785]},{t:[-.0125,.0287,-.2199],r:[-.1994,-.0379,-.0372,.9785]},{t:[-.0499,-.0528,-.1125],r:[.5569,-.0203,.0319,.8297]},{t:[-.0496,.0131,-.1445],r:[.3908,-.0273,.1089,.9136]},{t:[-.0513,.0438,-.1738],r:[.0747,-.0923,.0634,.9909]},{t:[-.0462,.0488,-.2036],r:[-.1936,-.1156,.0299,.9738]},{t:[-.0404,.0387,-.2253],r:[-.1936,-.1156,.0299,.9738]},{t:[-.0612,-.0561,-.1138],r:[.5095,.0572,.0274,.8581]},{t:[-.0698,.0022,-.1468],r:[.4396,-.0068,.1748,.881]},{t:[-.0751,.0329,-.1719],r:[.071,-.0911,.1344,.9842]},{t:[-.0703,.0383,-.2029],r:[-.1764,-.1244,.0831,.9729]},{t:[-.0641,.0302,-.2227],r:[-.1764,-.1244,.0831,.9729]},{t:[-.0708,-.0616,-.1145],r:[.4571,.1437,.0457,.8765]},{t:[-.0889,-.0132,-.148],r:[.3971,.0569,.2436,.883]},{t:[-.098,.0096,-.1727],r:[.1604,-.0085,.243,.9566]},{t:[-.0997,.0171,-.194],r:[-.0034,-.0735,.1859,.9798]},{t:[-.0979,.0165,-.2131],r:[-.0034,-.0735,.1859,.9798]}],[li.PINCHING]:[{t:[-.05,-.08,-.1],r:[.5373,0,0,.8434],s:[1,1,1]},{t:[-.0281,-.0594,-.1165],r:[.3072,-.0483,-.257,.915],s:[1,1,1]},{t:[-.0083,-.0299,-.1581],r:[.1832,.0632,-.4718,.8602],s:[1,1,1]},{t:[-.0069,-.0195,-.1841],r:[.2232,.1362,-.6112,.747],s:[1,1,.9999]},{t:[-.0063,-.0051,-.2109],r:[.2232,.1362,-.6112,.747],s:[1,1,.9999]},{t:[-.0369,-.0541,-.112],r:[.5858,-.1038,.0205,.8035],s:[1,1,1]},{t:[-.024,.0142,-.1465],r:[.1342,-.1392,-.0707,.9786],s:[1.0001,1,.9999]},{t:[-.0122,.0248,-.1828],r:[-.2614,-.0983,-.1184,.9529],s:[1.0001,.9999,.9999]},{t:[-.0095,.0131,-.2017],r:[-.3454,-.0506,-.1338,.9275],s:[1,.9999,1]},{t:[-.0098,-.0028,-.219],r:[-.3454,-.0506,-.1338,.9275],s:[1,.9999,1]},{t:[-.0498,-.0529,-.1126],r:[.5552,-.0196,.0307,.8309],s:[1.0001,1,1]},{t:[-.0496,.0131,-.1444],r:[.3957,-.0669,.0916,.9113],s:[1,.9999,1]},{t:[-.0477,.0443,-.173],r:[.0284,-.1256,.0276,.9913],s:[1,1,.9999]},{t:[-.0403,.0463,-.2027],r:[-.1956,-.1387,-.007,.9708],s:[1.0001,1,1]},{t:[-.0339,.036,-.224],r:[-.1956,-.1387,-.007,.9708],s:[1.0001,1,1]},{t:[-.0612,-.0561,-.1137],r:[.5088,.0591,.0245,.8585],s:[1,1.0001,1]},{t:[-.0697,.0021,-.1467],r:[.464,-.0595,.1601,.8692],s:[1,1,1]},{t:[-.0713,.0348,-.1698],r:[.0595,-.1373,.0948,.9842],s:[1.0001,1.0001,1]},{t:[-.0633,.0395,-.2003],r:[-.1735,-.159,.0354,.9713],s:[1,1,.9999]},{t:[-.0561,.0313,-.2197],r:[-.1735,-.159,.0354,.9713],s:[1,1,.9999]},{t:[-.0707,-.0617,-.1146],r:[.4573,.1467,.0408,.8762],s:[1,1,1]},{t:[-.0889,-.0132,-.148],r:[.4065,.0051,.2314,.8838],s:[1,.9999,1.0001]},{t:[-.0946,.0109,-.1723],r:[.1595,-.0578,.2175,.9612],s:[1,.9999,1]},{t:[-.094,.019,-.1934],r:[-.0122,-.1189,.1509,.9813],s:[1.0001,1,1]},{t:[-.0904,.0182,-.2123],r:[-.0122,-.1189,.1509,.9813],s:[1.0001,1,1]}],[li.FIST]:[{t:[-.0933,-.0266,-.1338],r:[.1346,-.1437,.0038,.9804]},{t:[-.0648,-.0265,-.1529],r:[.0354,-.3351,-.1786,.9244]},{t:[-.0318,-.0293,-.1932],r:[.0407,-.2202,-.5685,.7916]},{t:[-.0212,-.0345,-.2179],r:[.0132,-.12,-.576,.8084]},{t:[-.0161,-.039,-.2469],r:[.0132,-.12,-.576,.8084]},{t:[-.0731,-.0197,-.1569],r:[.0999,-.2377,.0822,.9627]},{t:[-.0399,-.0023,-.2221],r:[-.4356,-.1075,-.0127,.8936]},{t:[-.0325,-.0319,-.246],r:[.9331,.066,.0832,-.3436]},{t:[-.035,-.0462,-.2296],r:[.9874,.021,.128,-.0903]},{t:[-.0408,-.0496,-.2076],r:[.9874,.021,.128,-.0903]},{t:[-.0853,-.0187,-.1614],r:[.115,-.1594,.0889,.9765]},{t:[-.0646,-7e-4,-.2271],r:[-.4919,-.1197,.0382,.8616]},{t:[-.0544,-.0353,-.2477],r:[.9309,.1571,.0605,-.324]},{t:[-.0548,-.0542,-.2244],r:[.9835,.1315,.1097,.0583]},{t:[-.0607,-.051,-.2013],r:[.9835,.1315,.1097,.0583]},{t:[-.0972,-.0213,-.1628],r:[.0881,-.0966,.0847,.9878]},{t:[-.0856,-.0088,-.2263],r:[-.4818,-.1075,.1033,.8635]},{t:[-.0742,-.0406,-.246],r:[.9378,.1774,.0089,-.2983]},{t:[-.0715,-.0585,-.2205],r:[.9769,.1847,.0804,.0714]},{t:[-.0757,-.0552,-.1994],r:[.9769,.1847,.0804,.0714]},{t:[-.1078,-.0253,-.162],r:[.0535,-.0126,.0933,.9941]},{t:[-.1069,-.0188,-.2215],r:[-.4433,-.1294,.1523,.8738]},{t:[-.0939,-.0444,-.2398],r:[.9002,.2018,-.0275,-.385]},{t:[-.0891,-.0599,-.2248],r:[.9644,.2553,.0425,-.0538]},{t:[-.0914,-.0623,-.2063],r:[.9644,.2553,.0425,-.0538]}],[li.THUMBS_UP]:[{t:[-.011,-.0299,-.0701],r:[.1224,-.1562,.6052,.771]},{t:[.0025,-.0017,-.0854],r:[.3796,-.3776,.3843,.7521]},{t:[.0162,.041,-.1065],r:[.6152,-.1749,.0935,.763]},{t:[.0204,.0676,-.1116],r:[.5992,-.1247,.1335,.7795]},{t:[.0225,.096,-.1202],r:[.5992,-.1247,.1335,.7795]},{t:[-.0042,-.008,-.0928],r:[.1427,-.2467,.6763,.6793]},{t:[.0063,.0312,-.155],r:[-.4551,-.5645,.3425,.5974]},{t:[.0447,.0257,-.1538],r:[.7509,.6277,.1981,-.053]},{t:[.0396,.0184,-.1338],r:[.7246,.5124,.4244,.1797]},{t:[.0207,.0148,-.1212],r:[.7246,.5124,.4244,.1797]},{t:[-.0078,-.0192,-.0982],r:[.109,-.1737,.6698,.7137]},{t:[-6e-4,.0083,-.163],r:[-.4929,-.5301,.4215,.5462]},{t:[.0407,.0046,-.1614],r:[.705,.703,.0897,-.0263]},{t:[.0382,-5e-4,-.132],r:[.6279,.5816,.4074,.3186]},{t:[.0165,-.0021,-.1217],r:[.6279,.5816,.4074,.3186]},{t:[-.0092,-.031,-.0993],r:[.0472,-.1416,.6514,.7439]},{t:[6e-4,-.0142,-.1626],r:[-.5202,-.4929,.4819,.5042]},{t:[.0398,-.0159,-.1611],r:[.6996,.7076,.0706,.0696]},{t:[.0338,-.0161,-.1304],r:[.5876,.6289,.3607,.3593]},{t:[.0143,-.0168,-.1208],r:[.5876,.6289,.3607,.3593]},{t:[-.0081,-.0426,-.0982],r:[-.0269,-.0934,.6476,.7558]},{t:[.0026,-.0377,-.1578],r:[.5435,.4612,-.5243,-.4658]},{t:[.0366,-.0376,-.1559],r:[.6991,.7017,.0384,.1318]},{t:[.032,-.0347,-.1344],r:[.575,.6796,.2522,.3795]},{t:[.0166,-.0342,-.1237],r:[.575,.6796,.2522,.3795]}],[li.POINTING]:[{t:[-.0283,-.0376,-.0293],r:[.1372,-.208,.241,.938]},{t:[.0016,-.0246,-.0431],r:[.0106,-.3992,-.0014,.9168]},{t:[.0392,-.0237,-.0781],r:[-.1,-.2869,-.466,.831]},{t:[.0496,-.0357,-.1004],r:[-.1511,-.183,-.4918,.8377]},{t:[.0533,-.0497,-.1265],r:[-.1511,-.183,-.4918,.8377]},{t:[-.0078,-.0226,-.0496],r:[.1168,-.3031,.3253,.8881]},{t:[.0265,.0074,-.1082],r:[.0563,-.1303,.2725,.9516]},{t:[.0346,.0153,-.1453],r:[-.0635,-.1606,.2541,.9516]},{t:[.0419,.0144,-.1659],r:[-.1073,-.1342,.2464,.9538]},{t:[.0494,.0105,-.1873],r:[-.1073,-.1342,.2464,.9538]},{t:[-.0184,-.0273,-.0562],r:[.1156,-.2249,.3238,.9117]},{t:[.0052,-.0021,-.1177],r:[-.4452,-.2871,.2041,.8233]},{t:[.0324,-.0274,-.1363],r:[.8476,.3909,.031,-.3574]},{t:[.0392,-.0465,-.1142],r:[.9167,.3645,.16,-.0352]},{t:[.032,-.0501,-.0915],r:[.9167,.3645,.16,-.0352]},{t:[-.028,-.0348,-.0593],r:[.0757,-.1724,.308,.9326]},{t:[-.01,-.0186,-.1201],r:[-.5151,-.3075,.2332,.7654]},{t:[.018,-.0439,-.1306],r:[.8841,.4115,.0419,-.2175]},{t:[.0214,-.0572,-.1026],r:[.8915,.3885,.1955,.1266]},{t:[.0111,-.0549,-.0835],r:[.8915,.3885,.1955,.1266]},{t:[-.0357,-.0434,-.0601],r:[.0242,-.0998,.3079,.9459]},{t:[-.0254,-.037,-.1183],r:[-.4608,-.35,.2807,.7658]},{t:[.0022,-.0544,-.1281],r:[.8346,.4535,.0038,-.3127]},{t:[.0089,-.0663,-.1107],r:[.8657,.4769,.1519,-.0059]},{t:[.003,-.0699,-.0932],r:[.8657,.4769,.1519,-.0059]}],[li.ROCK]:[{t:[-.0123,-.0183,-.0267],r:[.5149,-.0845,-.1158,.8452],s:[1,1,1]},{t:[.0153,-.0052,-.0437],r:[.2665,-.0899,-.3721,.8846],s:[1,1,1]},{t:[.0335,.0154,-.0867],r:[.0177,.1842,-.6731,.716],s:[1,1,1]},{t:[.0267,.0228,-.1122],r:[.0728,.2226,-.6735,.7011],s:[1,1,1]},{t:[.019,.0341,-.1386],r:[.0728,.2226,-.6735,.7011],s:[1,1,1]},{t:[.0067,.0029,-.0406],r:[.475,-.2118,-.0726,.851],s:[1,1,1]},{t:[.0388,.061,-.0749],r:[.5779,-.1002,-.0602,.8077],s:[1,1,1]},{t:[.0481,.097,-.086],r:[.5059,-.0922,-.0672,.855],s:[1,1,1]},{t:[.0529,.1158,-.0964],r:[.4458,-.0565,-.053,.8918],s:[1,1,1]},{t:[.0562,.1334,-.1107],r:[.4458,-.0565,-.053,.8918],s:[1,1,1]},{t:[-.0052,.0075,-.0412],r:[.5055,-.126,-.0623,.8513],s:[1,1,1]},{t:[.0144,.0671,-.0735],r:[.1227,-.0631,-.0269,.9901],s:[1,1,1]},{t:[.0199,.0775,-.1133],r:[-.4479,-.0687,-.0876,.8871],s:[1,1,1]},{t:[.0211,.0534,-.1312],r:[-.6828,-.0523,-.1046,.7212],s:[1,1,1]},{t:[.0192,.0294,-.1316],r:[-.6828,-.0523,-.1046,.7212],s:[1,1,1]},{t:[-.0167,.0074,-.0424],r:[.491,-.0372,-.0778,.8669],s:[1,1,1]},{t:[-.0075,.0623,-.0758],r:[.1717,-.0904,.0273,.9806],s:[1,1,1]},{t:[-7e-4,.0753,-.1121],r:[-.3257,-.1136,-.0418,.9377],s:[1,1,1]},{t:[.005,.0561,-.1361],r:[-.5492,-.1111,-.0905,.8233],s:[1,1,1]},{t:[.0066,.0356,-.1433],r:[-.5492,-.1111,-.0905,.8233],s:[1,1,1]},{t:[-.0273,.0051,-.0431],r:[.4566,.0629,-.0766,.8841],s:[1,1,1]},{t:[-.0297,.0531,-.0769],r:[.3942,-.0035,.1163,.9116],s:[1,1,1]},{t:[-.0317,.0768,-.1013],r:[.4582,6e-4,.1099,.882],s:[1,1,1]},{t:[-.0341,.0951,-.1136],r:[.4085,-.0179,.0535,.911],s:[1,1,1]},{t:[-.0354,.1086,-.1266],r:[.4085,-.0179,.0535,.911],s:[1,1,1]}],[li.THUMBS_DOWN]:[{t:[-.0169,.0317,-.0845],r:[.2721,-.3488,-.6314,.6369],s:[1,1,1]},{t:[-.0019,.008,-.1021],r:[-.0533,.5043,.7891,-.3467],s:[1,1,1]},{t:[.0208,-.0318,-.1276],r:[-.2229,.6138,.7555,.0539],s:[1,1,1]},{t:[.0282,-.0578,-.1318],r:[-.2724,.6476,.7112,.0242],s:[1,1,1]},{t:[.0389,-.0856,-.1338],r:[-.2724,.6476,.7112,.0242],s:[1,1,1]},{t:[.0046,.0177,-.0997],r:[.1919,-.3993,-.6438,.6238],s:[1,1,1]},{t:[.0618,-.0034,-.1463],r:[-.1884,.0883,-.6795,.7035],s:[1,1,1]},{t:[.0481,-.0093,-.1821],r:[.6204,-.5352,.4297,-.3794],s:[1,1,1]},{t:[.0275,-.0094,-.1746],r:[.6806,-.6532,.2814,-.176],s:[1,1,1]},{t:[.0141,-.0064,-.1561],r:[.6806,-.6532,.2814,-.176],s:[1,1,1]},{t:[.0062,.0299,-.1019],r:[.2399,-.3631,-.598,.6731],s:[1,1,1]},{t:[.0621,.0218,-.1466],r:[-.241,.1225,-.6156,.7403],s:[1,1,1]},{t:[.0427,.0133,-.1823],r:[.7097,-.4862,.373,-.3475],s:[1,1,1]},{t:[.0165,.0095,-.1681],r:[.7968,-.5892,.1321,-.0209],s:[1,1,1]},{t:[.0119,.0128,-.1447],r:[.7968,-.5892,.1321,-.0209],s:[1,1,1]},{t:[.0033,.0406,-.1037],r:[.2574,-.3085,-.5681,.7183],s:[1,1,1]},{t:[.052,.0419,-.1485],r:[-.2306,.1278,-.5499,.7925],s:[1,1,1]},{t:[.0339,.0328,-.182],r:[.7575,-.4754,.2861,-.344],s:[1,1,1]},{t:[.0099,.025,-.1634],r:[.843,-.5293,.0926,-.0248],s:[1,1,1]},{t:[.0068,.0266,-.142],r:[.843,-.5293,.0926,-.0248],s:[1,1,1]},{t:[-.0018,.0508,-.104],r:[.2798,-.2351,-.5355,.7614],s:[1,1,1]},{t:[.0378,.0613,-.1483],r:[-.1652,.0952,-.5046,.842],s:[1,1,1]},{t:[.0259,.054,-.1792],r:[.7429,-.4404,.2677,-.4273],s:[1,1,1]},{t:[.0084,.0449,-.169],r:[.8704,-.4542,.1121,-.1532],s:[1,1,1]},{t:[.002,.0431,-.1514],r:[.8704,-.4542,.1121,-.1532],s:[1,1,1]}],[li.VICTORY]:[{t:[-.0485,-.0629,-.0748],r:[.5235,.0269,-.0122,.8515],s:[1,1,1]},{t:[-.0274,-.0424,-.0935],r:[.2683,-.0091,-.2476,.9309],s:[1,1,1]},{t:[-.0197,-.0171,-.1372],r:[-.0874,.2587,-.5403,.7959],s:[1,1,1]},{t:[-.0337,-.0134,-.1604],r:[-.1021,.3471,-.5231,.7717],s:[1,1,1]},{t:[-.0538,-.0084,-.1819],r:[-.1021,.3471,-.5231,.7717],s:[1,1,1]},{t:[-.0376,-.037,-.0897],r:[.5048,-.107,.0348,.8559],s:[1,1,1]},{t:[-.0266,.0281,-.1246],r:[.567,-.0696,.0098,.8207],s:[1,1,1]},{t:[-.0224,.0646,-.1371],r:[.5031,-.0677,.0059,.8615],s:[1,1,1]},{t:[-.0201,.0836,-.1477],r:[.4589,-.0365,.0223,.8874],s:[1,1,1]},{t:[-.019,.1018,-.1617],r:[.4589,-.0365,.0223,.8874],s:[1,1,1]},{t:[-.0503,-.0361,-.0891],r:[.5225,-.0136,.0382,.8517],s:[1,1,1]},{t:[-.0515,.0267,-.1211],r:[.5428,.1035,.1149,.8255],s:[1,1,1]},{t:[-.0638,.0631,-.1369],r:[.5306,.067,.0906,.8401],s:[1,1,1]},{t:[-.0702,.0896,-.1495],r:[.5467,.0608,.081,.8312],s:[1,1,1]},{t:[-.0747,.1108,-.1601],r:[.5467,.0608,.081,.8312],s:[1,1,1]},{t:[-.0613,-.0396,-.0891],r:[.4925,.0763,.0204,.8667],s:[1,1,1]},{t:[-.0712,.0158,-.1219],r:[.2546,-.0246,.1592,.9535],s:[1,1,1]},{t:[-.0722,.0349,-.1561],r:[-.2354,-.1181,.1042,.959],s:[1,1,1]},{t:[-.0638,.0217,-.1832],r:[-.4573,-.1496,.0503,.8752],s:[1,1,1]},{t:[-.0571,.0041,-.1941],r:[-.4573,-.1496,.0503,.8752],s:[1,1,1]},{t:[-.0706,-.045,-.0892],r:[.4433,.1733,.0233,.8791],s:[1,1,1]},{t:[-.0898,6e-4,-.1216],r:[.0458,-.1976,.107,.9733],s:[1,1,1]},{t:[-.0762,.0038,-.1526],r:[-.348,-.2273,.0117,.9095],s:[1,1,1]},{t:[-.0668,-.0095,-.1675],r:[-.5475,-.2656,-.0806,.7894],s:[1,1,1]},{t:[-.0618,-.0269,-.1725],r:[-.5475,-.2656,-.0806,.7894],s:[1,1,1]}]}),di=Object.freeze({[li.RELAXED]:[{t:[.05,-.08,-.1],r:[.5373,0,0,.8434]},{t:[.0279,-.0592,-.1167],r:[.3237,.1161,.293,.8921]},{t:[.0026,-.0313,-.158],r:[.2171,.0194,.5207,.8254]},{t:[-.0042,-.0219,-.1837],r:[.2597,-.0685,.6498,.711]},{t:[-.01,-.0084,-.2107],r:[.2597,-.0685,.6498,.711]},{t:[.037,-.0539,-.1123],r:[.5808,.1164,-.0414,.8046]},{t:[.0238,.0151,-.147],r:[.3081,.0484,-.0273,.9497]},{t:[.0206,.0393,-.1786],r:[-.0461,.0526,-.0104,.9975]},{t:[.0185,.0373,-.201],r:[-.1674,.0162,-.0064,.9857]},{t:[.0177,.0287,-.223],r:[-.1674,.0162,-.0064,.9857]},{t:[.05,-.0527,-.1126],r:[.5619,.0306,-.0478,.8252]},{t:[.0497,.0138,-.1449],r:[.353,.0474,-.1014,.9289]},{t:[.0491,.0425,-.1767],r:[.0777,.1076,-.0559,.9896]},{t:[.0431,.0478,-.2066],r:[-.0679,.1248,-.0343,.9893]},{t:[.0369,.0436,-.2302],r:[-.0679,.1248,-.0343,.9893]},{t:[.0614,-.0561,-.1136],r:[.5303,-.05,-.0384,.8455]},{t:[.0699,.0028,-.1472],r:[.4168,.0427,-.1662,.8926]},{t:[.0722,.0331,-.1739],r:[.1339,.1107,-.1236,.977]},{t:[.0665,.0425,-.2041],r:[-.0175,.1318,-.0809,.9878]},{t:[.0606,.0413,-.2257],r:[-.0175,.1318,-.0809,.9878]},{t:[.0711,-.0618,-.1145],r:[.4891,-.1378,-.0535,.8596]},{t:[.0892,-.0127,-.1484],r:[.3439,.0196,-.23,.9102]},{t:[.0924,.0087,-.1761],r:[.1965,.0585,-.2173,.9543]},{t:[.0921,.0184,-.1968],r:[.0936,.1069,-.1575,.9773]},{t:[.0896,.0217,-.2157],r:[.0936,.1069,-.1575,.9773]}],[li.PINCHING]:[{t:[.05,-.08,-.1],r:[.5373,0,0,.8434],s:[1,1,1]},{t:[.0279,-.0593,-.1166],r:[.307,.046,.2483,.9176],s:[1,1,1]},{t:[.0082,-.0291,-.1587],r:[.1833,-.0669,.4657,.8632],s:[.9999,1,1]},{t:[.0071,-.0186,-.185],r:[.2256,-.1369,.6093,.7477],s:[1,1,.9999]},{t:[.0064,-.0039,-.212],r:[.2256,-.1369,.6093,.7477],s:[1,1,.9999]},{t:[.037,-.0539,-.1122],r:[.5831,.1146,-.0388,.8034],s:[1,.9999,1]},{t:[.0237,.0153,-.147],r:[.1209,.0891,.0196,.9885],s:[1,.9999,1]},{t:[.0163,.0257,-.1849],r:[-.2747,.0723,.0511,.9574],s:[1,.9999,.9999]},{t:[.014,.0138,-.204],r:[-.3165,.0337,.0633,.9459],s:[1,.9999,1]},{t:[.0136,-.0012,-.2226],r:[-.3165,.0337,.0633,.9459],s:[1,.9999,1]},{t:[.0501,-.0527,-.1126],r:[.5625,.0291,-.0455,.825],s:[1,1,1]},{t:[.0497,.0141,-.1449],r:[.3465,.0658,-.0921,.9312],s:[1.0001,.9999,.9999]},{t:[.0473,.0424,-.177],r:[.0559,.1235,-.0403,.9899],s:[1.0001,1,.9999]},{t:[.0402,.0463,-.2069],r:[-.0703,.1381,-.0195,.9877],s:[1.0001,1,.9999]},{t:[.0335,.0419,-.2304],r:[-.0703,.1381,-.0195,.9877],s:[1.0001,1,.9999]},{t:[.0615,-.0561,-.1136],r:[.5287,-.0513,-.0363,.8465],s:[1.0001,1,.9999]},{t:[.07,.003,-.1472],r:[.4197,.0598,-.1607,.8913],s:[1,1,.9999]},{t:[.0709,.0336,-.1737],r:[.1329,.1258,-.1128,.9766],s:[1,1,1]},{t:[.0643,.0431,-.2038],r:[-.0172,.145,-.068,.9869],s:[1.0001,.9999,1]},{t:[.0577,.0418,-.2253],r:[-.0172,.145,-.068,.9869],s:[1.0001,.9999,1]},{t:[.0711,-.0617,-.1145],r:[.4861,-.139,-.0517,.8612],s:[1.0001,.9999,1]},{t:[.0893,-.0125,-.1485],r:[.317,.0459,-.2224,.9208],s:[1.0001,.9999,1]},{t:[.0902,.0078,-.1772],r:[.1921,.0784,-.2077,.9559],s:[1,1,.9999]},{t:[.0889,.0174,-.1979],r:[.0936,.1253,-.1462,.9768],s:[1.0001,1,1]},{t:[.0857,.0208,-.2167],r:[.0936,.1253,-.1462,.9768],s:[1.0001,1,1]}],[li.FIST]:[{t:[.0504,-.0155,-.1083],r:[.1392,.117,-.058,.9816]},{t:[.022,-.0122,-.1291],r:[-.0068,.3422,.1705,.924]},{t:[-.011,-.019,-.1691],r:[-.0952,.2257,.5977,.7634]},{t:[-.0171,-.0305,-.1932],r:[-.249,.0162,.627,.738]},{t:[-.0073,-.0427,-.2185],r:[-.249,.0162,.627,.738]},{t:[.0314,-.0068,-.133],r:[.1126,.213,-.1468,.9594]},{t:[.0035,.014,-.1987],r:[-.5177,.1865,.0124,.8349]},{t:[-.0086,-.0192,-.2148],r:[.9671,-.1129,-.1466,-.1747]},{t:[-.0031,-.0274,-.1952],r:[.9714,-.0492,-.2057,.1081]},{t:[.0063,-.0222,-.1749],r:[.9714,-.0492,-.2057,.1081]},{t:[.0441,-.0073,-.137],r:[.1251,.1341,-.1467,.972]},{t:[.0283,.0126,-.2028],r:[-.5227,.1469,-.0852,.8354]},{t:[.0144,-.0224,-.2202],r:[.9399,-.2078,-.0451,-.2671]},{t:[.0137,-.0382,-.1948],r:[.9665,-.181,-.1188,.1381]},{t:[.0207,-.0318,-.1726],r:[.9665,-.181,-.1188,.1381]},{t:[.0559,-.0112,-.1379],r:[.0948,.0732,-.1351,.9836]},{t:[.0482,.0022,-.2011],r:[-.5015,.1223,-.1588,.8416]},{t:[.0337,-.0294,-.2191],r:[.9432,-.2267,.0156,-.2423]},{t:[.0294,-.0438,-.1916],r:[.9569,-.2379,-.08,.1464]},{t:[.0346,-.0376,-.1714],r:[.9569,-.2379,-.08,.1464]},{t:[.0662,-.0164,-.1368],r:[.0546,-.0084,-.1349,.9893]},{t:[.068,-.0102,-.1955],r:[-.4587,.1335,-.2099,.853]},{t:[.0529,-.0353,-.2127],r:[.9107,-.2444,.0606,-.3274]},{t:[.0466,-.0483,-.1959],r:[.9518,-.3056,-.0236,.0063]},{t:[.0488,-.0485,-.1773],r:[.9518,-.3056,-.0236,.0063]}],[li.THUMBS_UP]:[{t:[.0317,-.0212,-.089],r:[.2199,.1003,-.594,.7673]},{t:[.0223,.009,-.1042],r:[.4294,.285,-.3619,.7768]},{t:[.0158,.0521,-.1273],r:[.6012,.067,-.0513,.7947]},{t:[.0145,.0784,-.1348],r:[.597,.0134,-.0918,.7968]},{t:[.0163,.1065,-.1446],r:[.597,.0134,-.0918,.7968]},{t:[.0303,.0032,-.1103],r:[.2434,.2002,-.656,.6858]},{t:[.0337,.0475,-.1698],r:[-.3298,.4729,-.4297,.6949]},{t:[-.0026,.0462,-.1835],r:[.7134,-.6368,-2e-4,-.2925]},{t:[-.0107,.0369,-.1654],r:[.7745,-.5891,-.2133,-.0877]},{t:[-.0047,.0282,-.145],r:[.7745,-.5891,-.2133,-.0877]},{t:[.0347,-.0077,-.1158],r:[.2088,.1254,-.6589,.7117]},{t:[.0416,.0251,-.1782],r:[-.3597,.4829,-.4746,.6421]},{t:[.0018,.0251,-.19],r:[-.673,.7069,-.0014,.2177]},{t:[-.0077,.0162,-.163],r:[.6957,-.6456,-.2988,.0994]},{t:[.0063,.0104,-.1443],r:[.6957,-.6456,-.2988,.0994]},{t:[.0361,-.0196,-.1178],r:[.1467,.0923,-.6537,.7367]},{t:[.0398,.0027,-.1801],r:[-.3611,.446,-.5466,.6099]},{t:[.0028,.0047,-.193],r:[-.6782,.7246,-.0014,.1226]},{t:[-.003,-6e-4,-.1628],r:[-.652,.6801,.2937,-.1613]},{t:[.0108,-.0046,-.1465],r:[-.652,.6801,.2937,-.1613]},{t:[.0343,-.0315,-.1182],r:[.0757,.0463,-.6692,.7378]},{t:[.0363,-.021,-.1779],r:[-.3141,.3981,-.6168,.602]},{t:[.0062,-.0166,-.1931],r:[-.6691,.7354,-.0331,.1021]},{t:[.0012,-.0185,-.1716],r:[-.6175,.7316,.235,-.168]},{t:[.0116,-.0223,-.1564],r:[-.6175,.7316,.235,-.168]}],[li.POINTING]:[{t:[-.0042,-.0248,-.0222],r:[.1163,-.0095,-.3006,.9466]},{t:[-.024,-.0114,-.048],r:[-.052,.2376,-.0719,.9673]},{t:[-.0482,-.0149,-.0937],r:[-.2324,.2162,.3797,.869]},{t:[-.0535,-.0306,-.1155],r:[-.2846,.1212,.4068,.8595]},{t:[-.0521,-.0492,-.1388],r:[-.2846,.1212,.4068,.8595]},{t:[-.0129,-.0119,-.0508],r:[.1258,.0866,-.3895,.9083]},{t:[-.0173,.01,-.1215],r:[.1174,-.0564,-.3421,.9306]},{t:[-.0097,.018,-.1587],r:[-.0512,.0028,-.347,.9365]},{t:[-.0105,.0158,-.1805],r:[-.1583,.003,-.3458,.9249]},{t:[-.0137,.0085,-.2021],r:[-.1583,.003,-.3458,.9249]},{t:[-.0017,-.019,-.052],r:[.1155,.0062,-.386,.9152]},{t:[.0038,-.0037,-.1206],r:[-.2494,.0619,-.3947,.8822]},{t:[-.0086,-.0197,-.1569],r:[-.7146,.3231,-.2612,.5628]},{t:[-.0306,-.0389,-.1502],r:[.8643,-.4054,.1306,-.2676]},{t:[-.0406,-.0469,-.1297],r:[.8643,-.4054,.1306,-.2676]},{t:[.0068,-.0279,-.0499],r:[.0671,-.0438,-.3807,.9212]},{t:[.0155,-.022,-.1146],r:[-.3096,.1005,-.4385,.8377]},{t:[-.0022,-.0389,-.1452],r:[.7388,-.369,.2794,-.4899]},{t:[-.0264,-.0553,-.1341],r:[.852,-.4611,.1257,-.214]},{t:[-.0346,-.0602,-.1146],r:[.852,-.4611,.1257,-.214]},{t:[.0126,-.0374,-.0464],r:[.0105,-.1129,-.3882,.9146]},{t:[.0254,-.0415,-.1045],r:[-.3088,.1125,-.4825,.8119]},{t:[.0078,-.0548,-.1304],r:[-.6368,.3211,-.3767,.5912]},{t:[-.0112,-.0661,-.1307],r:[.7535,-.4639,.2523,-.3916]},{t:[-.0244,-.0737,-.1196],r:[.7535,-.4639,.2523,-.3916]}],[li.ROCK]:[{t:[.0015,-.0417,-.0513],r:[.5617,.0123,.1355,.8161],s:[1,1,1]},{t:[-.0235,-.025,-.07],r:[.2818,.0046,.4006,.8718],s:[1,1,1]},{t:[-.0354,-1e-4,-.1128],r:[-.0257,-.2764,.6652,.6931],s:[1,1,1]},{t:[-.0238,.0089,-.1359],r:[-6e-4,-.3419,.6556,.6733],s:[1,1,1]},{t:[-.0088,.0215,-.1584],r:[-6e-4,-.3419,.6556,.6733],s:[1,1,1]},{t:[-.015,-.0179,-.0645],r:[.5302,.1299,.1154,.8299],s:[1,1,1]},{t:[-.0403,.0456,-.0947],r:[.5874,.0115,.0813,.8051],s:[1,1,1]},{t:[-.0451,.0825,-.1058],r:[.5048,.001,.0806,.8595],s:[1,1,1]},{t:[-.0468,.1015,-.1165],r:[.4494,-.0352,.0601,.8906],s:[1,1,1]},{t:[-.0465,.1195,-.1308],r:[.4494,-.0352,.0601,.8906],s:[1,1,1]},{t:[-.0029,-.0139,-.063],r:[.5567,.046,.0996,.8234],s:[1,1,1]},{t:[-.016,.0502,-.0895],r:[.1657,-.0189,.0053,.986],s:[1,1,1]},{t:[-.0146,.0642,-.1285],r:[-.4455,.0104,.0258,.8948],s:[1,1,1]},{t:[-.0143,.0404,-.1468],r:[-.7027,.0133,.0292,.7107],s:[1,1,1]},{t:[-.0137,.0163,-.146],r:[-.7027,.0133,.0292,.7107],s:[1,1,1]},{t:[.0087,-.0144,-.0627],r:[.5389,-.0411,.1061,.8346],s:[1,1,1]},{t:[.0058,.0446,-.0897],r:[.2331,.0139,-.0389,.9716],s:[1,1,1]},{t:[.0052,.0621,-.1248],r:[-.3041,.0513,-.0024,.9512],s:[1,1,1]},{t:[.0022,.0442,-.1503],r:[-.5472,.0609,.0335,.8341],s:[1,1,1]},{t:[9e-4,.0239,-.1579],r:[-.5472,.0609,.0335,.8341],s:[1,1,1]},{t:[.0194,-.0172,-.0627],r:[.5054,-.1365,.0899,.8473],s:[1,1,1]},{t:[.0276,.0346,-.0893],r:[.4597,-.0527,-.1093,.8797],s:[1,1,1]},{t:[.0334,.0611,-.1099],r:[.5162,-.056,-.0989,.8489],s:[1,1,1]},{t:[.0378,.0805,-.1194],r:[.4448,-.0407,-.0462,.8935],s:[1,1,1]},{t:[.0411,.0949,-.1311],r:[.4448,-.0407,-.0462,.8935],s:[1,1,1]}],[li.THUMBS_DOWN]:[{t:[.0237,.033,-.083],r:[.325,.2979,.5612,.7004],s:[1,1,1]},{t:[.0039,.0142,-.1018],r:[.0744,.4501,.7672,.4508],s:[1,1,1]},{t:[-.0239,-.0191,-.133],r:[.2089,.5732,.7915,.0363],s:[1,1,1]},{t:[-.0341,-.0435,-.1401],r:[.2664,.6251,.7316,.0555],s:[1,1,1]},{t:[-.0476,-.0698,-.144],r:[.2664,.6251,.7316,.0555],s:[1,1,1]},{t:[-3e-4,.0251,-.0989],r:[.2488,.3591,.5717,.6944],s:[1,1,1]},{t:[-.0603,.0201,-.1463],r:[-.2217,-.1036,.5936,.7667],s:[1,1,1]},{t:[-.045,.0116,-.1809],r:[.681,.4806,-.3657,-.4143],s:[1,1,1]},{t:[-.0253,.0071,-.1724],r:[.7487,.5817,-.2444,-.2032],s:[1,1,1]},{t:[-.0121,.0068,-.1535],r:[.7487,.5817,-.2444,-.2032],s:[1,1,1]},{t:[.001,.0374,-.1005],r:[.2971,.3158,.527,.7309],s:[1,1,1]},{t:[-.0548,.0447,-.1454],r:[-.2475,-.1117,.5236,.8076],s:[1,1,1]},{t:[-.0369,.0331,-.181],r:[.759,.413,-.3155,-.3922],s:[1,1,1]},{t:[-.0126,.0231,-.1665],r:[.8595,.4988,-.1065,-.0339],s:[1,1,1]},{t:[-.0084,.0248,-.1428],r:[.8595,.4988,-.1065,-.0339],s:[1,1,1]},{t:[.0064,.0472,-.1018],r:[.3122,.2567,.4998,.766],s:[1,1,1]},{t:[-.0402,.0619,-.1463],r:[-.22,-.1072,.4537,.8569],s:[1,1,1]},{t:[-.025,.0506,-.1806],r:[.8003,.3914,-.2353,-.3886],s:[1,1,1]},{t:[-.0035,.0369,-.1624],r:[.8979,.4322,-.0728,-.0395],s:[1,1,1]},{t:[-8e-4,.0373,-.1409],r:[.8979,.4322,-.0728,-.0395],s:[1,1,1]},{t:[.0136,.0558,-.1017],r:[.3278,.1772,.4672,.8018],s:[1,1,1]},{t:[-.0219,.0775,-.1452],r:[-.1811,-.0932,.4016,.8929],s:[1,1,1]},{t:[-.0108,.0677,-.1758],r:[.7842,.3582,-.2073,-.4623],s:[1,1,1]},{t:[.004,.0547,-.1656],r:[.9158,.3542,-.0821,-.1706],s:[1,1,1]},{t:[.0096,.0511,-.1481],r:[.9158,.3542,-.0821,-.1706],s:[1,1,1]}],[li.VICTORY]:[{t:[-.0017,-.0652,-.0663],r:[.5651,.0392,-.0573,.8221],s:[1,1,1]},{t:[-.0247,-.042,-.0786],r:[.3207,.0849,.243,.9115],s:[1,1,1]},{t:[-.0407,-.0141,-.1186],r:[-.0285,-.1953,.5625,.8029],s:[1,1,1]},{t:[-.031,-.0094,-.1439],r:[-.0751,-.3079,.5331,.7845],s:[1,1,1]},{t:[-.0133,-.0043,-.1673],r:[-.0751,-.3079,.5331,.7845],s:[1,1,1]},{t:[-.0136,-.0376,-.076],r:[.5464,.1682,-.0848,.8161],s:[1,1,1]},{t:[-.0272,.0313,-.1019],r:[.6129,.1411,-.0752,.7738],s:[1,1,1]},{t:[-.032,.0692,-.1089],r:[.5643,.143,-.0679,.8103],s:[1,1,1]},{t:[-.0353,.0897,-.1161],r:[.5256,.1162,-.0834,.8386],s:[1,1,1]},{t:[-.038,.11,-.1265],r:[.5256,.1162,-.0834,.8386],s:[1,1,1]},{t:[-9e-4,-.0372,-.0776],r:[.5593,.0765,-.0968,.8197],s:[1,1,1]},{t:[-.0021,.0287,-.1033],r:[.6072,-.0412,-.1868,.7712],s:[1,1,1]},{t:[.01,.0671,-.1136],r:[.5687,2e-4,-.1587,.8071],s:[1,1,1]},{t:[.0156,.0946,-.124],r:[.5609,.0092,-.1498,.8142],s:[1,1,1]},{t:[.019,.1163,-.1339],r:[.5609,.0092,-.1498,.8142],s:[1,1,1]},{t:[.0096,-.0411,-.08],r:[.5291,-.0092,-.0837,.8443],s:[1,1,1]},{t:[.0165,.0173,-.1087],r:[.2191,.1389,-.1874,.9474],s:[1,1,1]},{t:[.009,.0353,-.1427],r:[-.3548,.2386,-.0503,.9026],s:[1,1,1]},{t:[-.0055,.0162,-.1628],r:[-.5898,.2546,.0402,.7653],s:[1,1,1]},{t:[-.0126,-.0042,-.1657],r:[-.5898,.2546,.0402,.7653],s:[1,1,1]},{t:[.0184,-.0469,-.0826],r:[.4806,-.0996,-.0936,.8662],s:[1,1,1]},{t:[.034,.0014,-.1134],r:[.079,.2891,-.1225,.9461],s:[1,1,1]},{t:[.0152,.0077,-.141],r:[-.2784,.3171,.0012,.9066],s:[1,1,1]},{t:[.0023,-.0029,-.1556],r:[-.458,.3482,.1094,.8106],s:[1,1,1]},{t:[-.0053,-.0187,-.1623],r:[-.458,.3482,.1094,.8106],s:[1,1,1]}]}),ui=Object.freeze({[li.RELAXED]:"Relaxed",[li.PINCHING]:"Pinching",[li.FIST]:"Fist",[li.THUMBS_UP]:"Thumbs Up",[li.POINTING]:"Pointing",[li.ROCK]:"Rock",[li.THUMBS_DOWN]:"Thumbs Down",[li.VICTORY]:"Victory"});class pi{}const gi=new t.Vector3,mi=new t.Quaternion;class fi{constructor(e,i){this.simulatorControllerState=e,this.simulatorScene=i,this.leftController=new t.Object3D,this.rightController=new t.Object3D,this.leftHandBones=[],this.rightHandBones=[],this.leftHandPose=li.RELAXED,this.rightHandPose=li.RELAXED,this.leftHandTargetJoints=ci[li.RELAXED],this.rightHandTargetJoints=di[li.RELAXED],this.lerpSpeed=.1,this.onHandPoseChangeRequestBound=this.onHandPoseChangeRequest.bind(this),this.leftXRHand=new pi,this.rightXRHand=new pi}init({input:t}){this.input=t,this.loadMeshes(),this.simulatorScene.add(this.leftController),this.simulatorScene.add(this.rightController)}loadMeshes(){this.loader=new o,this.loader.setPath("https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles/generic-hand/"),this.loader.load("left.glb",(t=>{this.leftHand=t.scene,this.leftController.add(this.leftHand),Zt.forEach((e=>{const i=t.scene.getObjectByName(e);i?this.leftHandBones.push(i):console.warn(`Couldn't find ${e} in left hand mesh`)})),this.setLeftHandJoints(this.leftHandTargetJoints),this.input.hands[0]?.dispatchEvent?.({type:"connected",data:{hand:this.leftXRHand,handedness:"left"}})})),this.loader.load("right.glb",(t=>{this.rightHand=t.scene,this.rightController.add(this.rightHand),Zt.forEach((e=>{const i=t.scene.getObjectByName(e);i?this.rightHandBones.push(i):console.warn(`Couldn't find ${e} in right hand mesh`)})),this.setRightHandJoints(this.rightHandTargetJoints),this.input.hands[1]?.dispatchEvent?.({type:"connected",data:{hand:this.rightXRHand,handedness:"right"}})}))}setLeftHandLerpPose(t){this.leftHandPose!==t&&(t===li.PINCHING?this.input.dispatchEvent({type:"selectstart",target:this.input.controllers[0],data:{handedness:"left"}}):this.leftHandPose===li.PINCHING&&this.input.dispatchEvent({type:"selectend",target:this.input.controllers[0],data:{handedness:"left"}}),this.leftHandPose=t,this.leftHandTargetJoints=ci[t],this.updateHandPosePanel())}setRightHandLerpPose(t){this.rightHandPose!==t&&(t===li.PINCHING?this.input.dispatchEvent({type:"selectstart",target:this.input.controllers[1],data:{handedness:"right"}}):this.rightHandPose===li.PINCHING&&this.input.dispatchEvent({type:"selectend",target:this.input.controllers[1],data:{handedness:"right"}}),this.rightHandPose=t,this.rightHandTargetJoints=di[t],this.updateHandPosePanel())}setLeftHandJoints(t){this.leftHandPose===li.PINCHING&&this.input.dispatchEvent({type:"selectend",target:this.input.controllers[1],data:{handedness:"left"}}),t!=this.leftHandTargetJoints&&(this.leftHandPose=void 0,this.leftHandTargetJoints=t);for(let e=0;e<this.leftHandBones.length;e++){const i=this.leftHandBones[e],s=t[e];i&&s&&(i.position.fromArray(s.t),i.quaternion.fromArray(s.r),i.scale.fromArray([1,1,1]))}}setRightHandJoints(t){this.rightHandPose===li.PINCHING&&this.input.dispatchEvent({type:"selectend",target:this.input.controllers[1],data:{handedness:"right"}}),t!=this.rightHandTargetJoints&&(this.rightHandPose=void 0,this.rightHandTargetJoints=t);for(let e=0;e<this.rightHandBones.length;e++){const i=this.rightHandBones[e],s=t[e];i&&s&&(i.position.fromArray(s.t),i.quaternion.fromArray(s.r),i.scale.fromArray([1,1,1]))}}update(){this.lerpLeftHandPose(),this.lerpRightHandPose(),this.syncHandJoints()}lerpLeftHandPose(){for(let t=0;t<this.leftHandBones.length;t++){const e=this.leftHandBones[t],i=this.leftHandTargetJoints[t];e&&i&&(gi.fromArray(i.t),mi.fromArray(i.r),e.position.lerp(gi,this.lerpSpeed),e.quaternion.slerp(mi,this.lerpSpeed))}}lerpRightHandPose(){for(let t=0;t<this.rightHandBones.length;t++){const e=this.rightHandBones[t],i=this.rightHandTargetJoints[t];e&&i&&(gi.fromArray(i.t),mi.fromArray(i.r),e.position.lerp(gi,this.lerpSpeed),e.quaternion.slerp(mi,this.lerpSpeed))}}syncHandJoints(){const e=this.input.hands,i=e[0];if(i){this.leftController.updateWorldMatrix(!0,!1),i.position.setFromMatrixPosition(this.leftController.matrixWorld),i.setRotationFromMatrix(this.leftController.matrixWorld),i.updateMatrix();for(let e=0;e<this.leftHandBones.length;e++){const s=Zt[e];s in i.joints||(i.joints[s]=new t.Group,i.add(i.joints[s])),i.joints[s].position.copy(this.leftHandBones[e].position),i.joints[s].quaternion.copy(this.leftHandBones[e].quaternion),i.updateWorldMatrix(!1,!0)}}const s=e[1];if(s){this.rightController.updateWorldMatrix(!0,!1),s.position.setFromMatrixPosition(this.rightController.matrixWorld),s.setRotationFromMatrix(this.rightController.matrixWorld),s.updateMatrix();for(let e=0;e<this.rightHandBones.length;e++){const i=Zt[e];i in s.joints||(s.joints[i]=new t.Group,s.add(s.joints[i])),s.joints[i].position.copy(this.rightHandBones[e].position),s.joints[i].quaternion.copy(this.rightHandBones[e].quaternion),s.updateWorldMatrix(!1,!0)}}}setLeftHandPinching(t=!0){this.setLeftHandLerpPose(t?li.PINCHING:li.RELAXED)}setRightHandPinching(t=!0){this.setRightHandLerpPose(t?li.PINCHING:li.RELAXED)}showHands(){this.leftController.visible=!0,this.rightController.visible=!0;for(let t=0;t<this.input.hands.length;t++)this.input.hands[t].visible=!0;this.updateHandPosePanel()}hideHands(){this.leftController.visible=!1,this.rightController.visible=!1;for(let t=0;t<this.input.hands.length;t++)this.input.hands[t].visible=!1;this.updateHandPosePanel()}updateHandPosePanel(){this.handPosePanelElement&&(0===this.simulatorControllerState.currentControllerIndex?(this.handPosePanelElement.visible=this.leftController.visible,this.handPosePanelElement.handPose=this.leftHandPose):(this.handPosePanelElement.visible=this.rightController.visible,this.handPosePanelElement.handPose=this.rightHandPose))}setHandPosePanelElement(t){this.handPosePanelElement&&this.handPosePanelElement.removeEventListener(hi.type,this.onHandPoseChangeRequestBound),t.addEventListener(hi.type,this.onHandPoseChangeRequestBound),this.handPosePanelElement=t,this.updateHandPosePanel()}onHandPoseChangeRequest(t){if(t.type!=hi.type)return;const e=t;0===this.simulatorControllerState.currentControllerIndex?this.setLeftHandLerpPose(e.pose):this.setRightHandLerpPose(e.pose)}toggleHandedness(){this.simulatorControllerState.currentControllerIndex=(this.simulatorControllerState.currentControllerIndex+1)%2,this.updateHandPosePanel()}}class vi{constructor(){this.elements=[],this.interfaceVisible=!0}init(t,e,i){this.createModeIndicator(t,e),this.showGeminiLivePanel(t),this.createHandPosePanel(t,i),this.showInstructions(t)}createModeIndicator(t,e){if(t.modeIndicator.enabled){const i=document.createElement(t.modeIndicator.element);document.body.appendChild(i),e.setModeIndicatorElement(i),this.elements.push(i)}}showInstructions(t){if(t.instructions.enabled){const e=document.createElement(t.instructions.element);e.customInstructions=t.instructions.customInstructions,document.body.appendChild(e),this.elements.push(e)}}showGeminiLivePanel(t){if(t.geminilive){const t=document.createElement("xrblocks-simulator-geminilive");document.body.appendChild(t),this.elements.push(t)}}createHandPosePanel(t,e){if(t.handPosePanel.enabled){const i=document.createElement(t.handPosePanel.element);document.body.appendChild(i),e.setHandPosePanelElement(i),this.elements.push(i)}}hideUiElements(){for(const t of this.elements)t.style.display="none";this.interfaceVisible=!1}showUiElements(){for(const t of this.elements)t.style.display="";this.interfaceVisible=!0}getInterfaceVisible(){return!this.interfaceVisible}toggleInterfaceVisible(){this.interfaceVisible?this.hideUiElements():this.showUiElements()}}class yi extends t.Scene{constructor(){super()}async init(e){this.addLights(),e.scenePath&&await this.loadGLTF(e.scenePath,new t.Vector3(e.initialScenePosition.x,e.initialScenePosition.y,e.initialScenePosition.z))}addLights(){this.add(new t.HemisphereLight(12303291,8947848,3))}async loadGLTF(t,e){const i=new o;return new Promise(((s,n)=>{i.load(t,(t=>{t.scene.position.copy(e),this.add(t.scene),this.gltf=t,s(t)}),(()=>{}),(t=>{n(t)}))}))}}async function wi(t,e,i){const s=t.constructor.dependencies;null!=s?await t.init(Object.fromEntries(Object.entries(s).map((([t,i])=>{const s=e.get(i);if(!s)throw new Error(`Dependency not found for key: ${i.name}`);return[t,s]})))):await t.init(i)}class xi extends S{static{this.dependencies={waitFrame:qt,registry:Ut}}constructor(){super(),this.journeyId=0}init({waitFrame:t,registry:e}){this.waitFrame=t,this.registry=e}stopJourney(){++this.journeyId}isOnJourneyId(t){return t==this.journeyId}async loadJourney(t){console.log("Load journey");const e=++this.journeyId;for(let i=0;this.isOnJourneyId(e)&&i<t.length;++i)wi(t[i],this.registry,void 0),await t[i].play({simulatorUser:this,journeyId:e,waitFrame:this.waitFrame});console.log("Journey finished")}}class Si extends S{static{this.dependencies={simulatorOptions:ye,input:ce,timer:t.Timer,camera:t.Camera,renderer:t.WebGLRenderer,scene:t.Scene,registry:Ut,options:Ee,depth:At}}constructor(t){super(),this.renderMainScene=t,this.simulatorScene=new yi,this.depth=new ai(this.simulatorScene),this.simulatorControllerState=new Ve,this.hands=new fi(this.simulatorControllerState,this.simulatorScene),this.simulatorUser=new xi,this.userInterface=new vi,this.controls=new ri(this.simulatorControllerState,this.hands,this.setStereoRenderMode.bind(this),this.userInterface),this.renderDepthPass=!1,this.renderMode=Ie.DEFAULT,this.stereoCameras=[],this.initialized=!1,this.renderSimulatorSceneToCanvasBound=this.renderSimulatorSceneToCanvas.bind(this),this.add(this.simulatorUser)}async init({simulatorOptions:e,input:s,timer:n,camera:r,renderer:o,scene:a,registry:h,options:l,depth:c}){if(this.initialized)return;const d=h.get(kt),u=h.get(yt);this.options=e,r.position.copy(this.options.initialCameraPosition),this.userInterface.init(e,this.controls,this.hands),o.autoClearColor=!1,await this.simulatorScene.init(e),this.hands.init({input:s}),this.controls.init({camera:r,input:s,timer:n,renderer:o,simulatorOptions:e}),d&&!this.camera&&(this.camera=new Oe(o),this.camera.init(),d.registerSimulatorCamera(this.camera)),l.depth.enabled&&(this.renderDepthPass=!0,this.depth.init(o,r,c),l.depth.depthMesh.enabled&&u&&r.add(u)),a.add(r),this.options.stereo.enabled&&this.setupStereoCameras(r),this.virtualSceneRenderTarget=new t.WebGLRenderTarget(o.domElement.width,o.domElement.height,{stencilBuffer:l.stencil});const p=new t.MeshBasicMaterial({map:this.virtualSceneRenderTarget.texture,transparent:!0});"screen"===this.options.blendingMode&&(p.blending=t.CustomBlending,p.blendSrc=t.OneFactor,p.blendDst=t.OneMinusSrcColorFactor,p.blendEquation=t.AddEquation),this.virtualSceneFullScreenQuad=new i(p),this.renderer=o,this.mainCamera=r,this.mainScene=a,this.initialized=!0}simulatorUpdate(){this.controls.update(),this.hands.update(),this.renderDepthPass&&this.depth.update()}setStereoRenderMode(t){this.options.stereo.enabled&&(this.renderMode=t)}setupStereoCameras(t){const e=t.clone(),i=t.clone();e.layers.disableAll(),e.layers.enable(0),e.layers.enable(1),i.layers.disableAll(),i.layers.enable(0),i.layers.enable(2),e.position.set(-.0315,0,0),i.position.set(.0315,0,0),e.updateWorldMatrix(!0,!1),i.updateWorldMatrix(!0,!1),this.stereoCameras.length=0,this.stereoCameras.push(e,i),t.add(e,i),this.setStereoRenderMode(Ie.STEREO_LEFT)}onBeforeSimulatorSceneRender(){this.camera&&this.camera.onBeforeSimulatorSceneRender(this.mainCamera,this.renderSimulatorSceneToCanvasBound)}onSimulatorSceneRendered(){this.camera&&this.camera.onSimulatorSceneRendered()}getRenderCamera(){return{[Ie.DEFAULT]:this.mainCamera,[Ie.STEREO_LEFT]:this.stereoCameras[0],[Ie.STEREO_RIGHT]:this.stereoCameras[1]}[this.renderMode]}renderScene(){if(this.renderer&&this.options.renderToRenderTexture){if(this.virtualSceneRenderTarget.width!=this.renderer.domElement.width||this.virtualSceneRenderTarget.height!=this.renderer.domElement.height){const e=!!this.virtualSceneRenderTarget?.stencilBuffer;this.virtualSceneRenderTarget.dispose(),this.virtualSceneRenderTarget=new t.WebGLRenderTarget(this.renderer.domElement.width,this.renderer.domElement.height,{stencilBuffer:e}),this.virtualSceneFullScreenQuad.material.map=this.virtualSceneRenderTarget.texture}this.renderer.setRenderTarget(this.virtualSceneRenderTarget),this.renderer.clear(),this.renderMainScene(this.getRenderCamera())}}renderSimulatorScene(){this.onBeforeSimulatorSceneRender(),this.renderSimulatorSceneToCanvas(this.getRenderCamera()),this.onSimulatorSceneRendered(),this.options.renderToRenderTexture?this.virtualSceneFullScreenQuad.render(this.renderer):this.renderMainScene(this.getRenderCamera())}renderSimulatorSceneToCanvas(t){this.renderer.setRenderTarget(null),this.renderer.render(this.simulatorScene,t),this.renderer.clearDepth()}}class bi extends S{static{this.dependencies={registry:Ut}}constructor(t={}){super(),this.isCapturing=!1,this.latestAudioBuffer=null,this.accumulatedChunks=[],this.isAccumulating=!1,this.options={sampleRate:16e3,channelCount:1,echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,...t}}init({registry:t}){this.registry=t}async startCapture(t={}){if(!this.isCapturing){this.onAudioData=t.onAudioData,this.onError=t.onError,this.isAccumulating=t.accumulate||!1,this.isAccumulating&&(this.accumulatedChunks=[]);try{await this.setupAudioCapture(),this.isCapturing=!0}catch(t){console.error("Failed to start audio capture:",t),this.onError?.(t),this.cleanup()}}}stopCapture(){this.isCapturing&&(this.cleanup(),this.isCapturing=!1)}async setupAudioCapture(){this.audioStream=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1});const t=this.audioStream.getAudioTracks()[0].getSettings().sampleRate;this.audioContext=new AudioContext({sampleRate:t}),await this.setupAudioWorklet(),this.sourceNode=this.audioContext.createMediaStreamSource(this.audioStream),this.processorNode=new AudioWorkletNode(this.audioContext,"audio-capture-processor"),this.processorNode.port.onmessage=t=>{"audioData"===t.data.type&&(this.latestAudioBuffer=t.data.data,this.isAccumulating&&this.accumulatedChunks.push(t.data.data),this.onAudioData?.(t.data.data),this.streamToAI(t.data.data))},"suspended"===this.audioContext.state&&await this.audioContext.resume(),this.sourceNode.connect(this.processorNode)}async setupAudioWorklet(){const t=new Blob(["\n      class AudioCaptureProcessor extends AudioWorkletProcessor {\n        process(inputs, outputs, parameters) {\n          const input = inputs[0];\n          if (input && input[0]) {\n            const inputData = input[0];\n            const pcmData = new Int16Array(inputData.length);\n            for (let i = 0; i < inputData.length; i++) {\n              pcmData[i] = Math.max(-32768, Math.min(32767, inputData[i] * 32768));\n            }\n            this.port.postMessage({type: 'audioData', data: pcmData.buffer});\n          }\n          return true;\n        }\n      }\n      registerProcessor('audio-capture-processor', AudioCaptureProcessor);\n    "],{type:"application/javascript"}),e=URL.createObjectURL(t);await this.audioContext.audioWorklet.addModule(e),URL.revokeObjectURL(e)}streamToAI(t){if(!this.aiService?.sendRealtimeInput)return;const e=function(t){const e=new Uint8Array(t);let i="";for(let t=0;t<e.length;t++)i+=String.fromCharCode(e[t]);return btoa(i)}(t),i=this.audioContext?.sampleRate||this.options.sampleRate;this.aiService.sendRealtimeInput({audio:{data:e,mimeType:`audio/pcm;rate=${i}`}})}setAIStreaming(t){this.aiService=t?this.registry.get($):void 0}cleanup(){this.processorNode?.disconnect(),this.sourceNode?.disconnect(),this.audioContext&&"closed"!==this.audioContext.state&&this.audioContext.close(),this.audioStream?.getTracks().forEach((t=>t.stop())),this.processorNode=void 0,this.sourceNode=void 0,this.audioContext=void 0,this.audioStream=void 0,this.onAudioData=void 0,this.onError=void 0,this.latestAudioBuffer=null,this.accumulatedChunks=[],this.isAccumulating=!1,this.aiService=void 0}static isSupported(){return!(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)}getIsCapturing(){return this.isCapturing}getLatestAudioBuffer(){return this.latestAudioBuffer}clearLatestAudioBuffer(){this.latestAudioBuffer=null}getAccumulatedBuffer(){if(0===this.accumulatedChunks.length)return null;const t=this.accumulatedChunks.reduce(((t,e)=>t+e.byteLength),0),e=new ArrayBuffer(t),i=new Uint8Array(e);let s=0;for(const t of this.accumulatedChunks)i.set(new Uint8Array(t),s),s+=t.byteLength;return e}clearAccumulatedBuffer(){this.accumulatedChunks=[]}getAccumulatedChunkCount(){return this.accumulatedChunks.length}dispose(){this.stopCapture(),super.dispose()}}class Ci extends S{constructor(t={}){super(),this.options={},this.audioQueue=[],this.isPlaying=!1,this.nextStartTime=0,this.volume=1,this.category="speech",this.options={sampleRate:48e3,channelCount:1,...t},t.category&&(this.category=t.category)}setCategoryVolumes(t){this.categoryVolumes=t,this.updateGainNodeVolume()}setVolume(t){this.volume=Math.max(0,Math.min(1,t)),this.updateGainNodeVolume()}updateGainNodeVolume(){if(this.gainNode&&this.categoryVolumes){const t=this.categoryVolumes.getEffectiveVolume(this.category,this.volume);this.gainNode.gain.value=t}else this.gainNode&&(this.gainNode.gain.value=this.volume)}async initializeAudioContext(){this.audioContext||(this.audioContext=new AudioContext({sampleRate:this.options.sampleRate}),this.nextStartTime=this.audioContext.currentTime,this.gainNode=this.audioContext.createGain(),this.gainNode.connect(this.audioContext.destination),this.updateGainNodeVolume())}async playAudioChunk(t){if(!t)return;await this.initializeAudioContext();const e=this.base64ToArrayBuffer(t),i=this.audioContext.createBuffer(this.options.channelCount,e.byteLength/2,this.options.sampleRate),s=i.getChannelData(0),n=new Int16Array(e);for(let t=0;t<n.length;t++)s[t]=n[t]/32768;this.audioQueue.push(i),this.isPlaying||this.playNextAudioBuffer()}playNextAudioBuffer(){if(0===this.audioQueue.length)return void(this.isPlaying=!1);this.isPlaying=!0;const t=this.audioQueue.shift(),e=this.audioContext.currentTime,i=Math.max(this.nextStartTime,e),s=this.audioContext.createBufferSource();s.buffer=t,s.connect(this.gainNode||this.audioContext.destination),s.onended=()=>this.playNextAudioBuffer(),s.start(i),this.nextStartTime=i+t.duration}clearQueue(){this.audioQueue=[],this.isPlaying=!1}getIsPlaying(){return this.isPlaying}getQueueLength(){return this.audioQueue.length}base64ToArrayBuffer(t){const e=atob(t),i=new Uint8Array(e.length);for(let t=0;t<e.length;t++)i[t]=e.charCodeAt(t);return i.buffer}stop(){this.clearQueue(),this.audioContext&&(this.audioContext.close(),this.audioContext=void 0,this.gainNode=void 0)}static isSupported(){return!(!("AudioContext"in window)&&!("webkitAudioContext"in window))}dispose(){this.stop(),super.dispose()}}const Ti=at+"musicLibrary/",Ri={ambient:Ti+"AmbientLoop.opus",background:Ti+"BackgroundMusic4.mp3",buttonHover:Ti+"ButtonHover.opus",buttonPress:Ti+"ButtonPress.opus",menuDismiss:Ti+"MenuDismiss.opus"};class Mi extends S{constructor(e,i){super(),this.listener=e,this.categoryVolumes=i,this.audioLoader=new t.AudioLoader,this.currentAudio=null,this.isPlaying=!1,this.musicLibrary=Ri,this.specificVolume=.5,this.musicCategory="music"}setVolume(e){if(this.specificVolume=t.MathUtils.clamp(e,0,1),this.currentAudio&&this.isPlaying&&this.categoryVolumes){const t=this.categoryVolumes.getEffectiveVolume(this.musicCategory,this.specificVolume);this.currentAudio.setVolume(t),console.log(`BackgroundMusic volume updated to: ${t} (specific: ${this.specificVolume})`)}}playMusic(e,i="music"){if(!this.categoryVolumes||!this.listener||!this.audioLoader)return void console.error("BackgroundMusic not properly initialized.");const s=this.musicLibrary[e];if(!s)return void console.error(`BackgroundMusic: Music key "${e}" not found.`);this.stopMusic(),console.log(`BackgroundMusic: Loading sound: ${s}`),this.musicCategory=i;const n=this.listener;this.audioLoader.load(s,(i=>{console.log(`BackgroundMusic: Successfully loaded ${s}`);const r=new t.Audio(n);r.setBuffer(i),r.setLoop("music"===this.musicCategory||"ambient"===this.musicCategory);const o=this.categoryVolumes.getEffectiveVolume(this.musicCategory,this.specificVolume);r.setVolume(o),console.log(`BackgroundMusic: Setting volume for "${e}" to ${o}`),r.play(),this.currentAudio=r,this.isPlaying=!0,console.log(`BackgroundMusic: Playing "${e}" in category "${this.musicCategory}"`)}),(t=>{console.log(`BackgroundMusic: Loading ${s} - ${(t.loaded/t.total*100).toFixed(0)}% loaded`)}),(t=>{console.error(`BackgroundMusic: Error loading sound ${s}:`,t),this.currentAudio=null,this.isPlaying=!1}))}stopMusic(){this.currentAudio&&this.isPlaying&&(console.log("BackgroundMusic: Stopping current audio."),this.currentAudio.stop()),this.currentAudio=null,this.isPlaying=!1}destroy(){console.log("BackgroundMusic Destroying..."),this.stopMusic()}}var Di;!function(t){t.music="music",t.sfx="sfx",t.speech="speech",t.ui="ui"}(Di||(Di={}));class Ei{constructor(){this.isMuted=!1,this.masterVolume=1,this.volumes=Object.fromEntries(Object.values(Di).map((t=>[t,1])))}getCategoryVolume(t){return this.volumes[t]??1}getEffectiveVolume(e,i=1){if(this.isMuted)return 0;const s=this.getCategoryVolume(e),n=t.MathUtils.clamp(i,0,1);return this.masterVolume*s*n}}const _i={BEEP:{frequency:1e3,duration:.07,waveformType:"sine"},CLICK:[{frequency:1500,duration:.02,waveformType:"triangle",delay:0}],ACTIVATE:[{frequency:800,duration:.05,waveformType:"sine",delay:0},{frequency:1200,duration:.07,waveformType:"sine",delay:50}],DEACTIVATE:[{frequency:1200,duration:.05,waveformType:"sine",delay:0},{frequency:800,duration:.07,waveformType:"sine",delay:50}]};class Pi extends S{constructor(){super(...arguments),this.isInitialized=!1,this.debug=!1}_initAudioContext(){this.isInitialized||(this.audioContext=new AudioContext,this.isInitialized=!0,this.debug&&console.log("SoundSynthesizer: AudioContext initialized."))}playTone(t,e,i,s){if(this._initAudioContext(),!this.audioContext)return void console.error("SoundSynthesizer: AudioContext not available. Cannot play tone.");const n=this.audioContext.createOscillator();n.type=s,n.frequency.setValueAtTime(t,this.audioContext.currentTime);const r=this.audioContext.createGain();r.gain.setValueAtTime(i,this.audioContext.currentTime),n.connect(r),r.connect(this.audioContext.destination),n.start();const o=this.audioContext.currentTime+e,a=Math.max(.01,.1*e);r.gain.exponentialRampToValueAtTime(1e-5,o-a),n.stop(o)}playPresetTone(t,e=.5){const i=_i[t];if(i)if(Array.isArray(i))i.forEach((t=>{setTimeout((()=>{this.playTone(t.frequency,t.duration,e,t.waveformType)}),t.delay||0)}));else{const t=i;this.playTone(t.frequency,t.duration,e,t.waveformType)}else console.warn(`SoundSynthesizer: Preset '${t}' not found.`)}}const Oi={ambient:"musicLibrary/AmbientLoop.opus",buttonHover:"musicLibrary/ButtonHover.opus",paintOneShot1:"musicLibrary/PaintOneShot1.opus"};let Ai=0;class Ii extends S{constructor(e,i){super(),this.listener=e,this.categoryVolumes=i,this.audioLoader=new t.AudioLoader,this.soundLibrary=Oi,this.activeSounds=new Map,this.specificVolume=1,this.category="sfx",this.defaultRefDistance=1,this.defaultRolloffFactor=1}playSoundAtObject(e,i,s={}){if(!this.listener||!this.audioLoader||!i)return console.error("SpatialAudio not properly initialized or targetObject missing."),null;const n=this.soundLibrary[e];if(!n)return console.error(`SpatialAudio: Sound key "${e}" not found.`),null;const r=++Ai,o=void 0!==s.volume?s.volume:this.specificVolume,a=s.loop||!1,h=void 0!==s.refDistance?s.refDistance:this.defaultRefDistance,l=void 0!==s.rolloffFactor?s.rolloffFactor:this.defaultRolloffFactor;return console.log(`SpatialAudio: Loading sound "${e}" (${n})`),this.audioLoader.load(n,(n=>{if(console.log(`SpatialAudio: Successfully loaded "${e}"`),!this.listener)return void console.error("SpatialAudio: Listener lost during load.");const c=new t.PositionalAudio(this.listener);c.setBuffer(n),c.setLoop(a),c.setRefDistance(h),c.setRolloffFactor(l);const d=this.categoryVolumes.getEffectiveVolume(this.category,o);c.setVolume(d),i.add(c),this.activeSounds.set(r,{audio:c,target:i,options:s}),a||(c.onEnded=()=>{console.log(`SpatialAudio: Sound "${e}" (ID: ${r}) ended.`),this._cleanupSound(r),s.onEnded&&"function"==typeof s.onEnded&&s.onEnded(),c.onEnded=()=>{}}),c.play(),console.log(`SpatialAudio: Playing "${e}" (ID: ${r}) at object ${i.name||i.uuid}, Volume: ${d}`)}),(t=>{console.log(`SpatialAudio: Loading "${e}" - ${(t.loaded/t.total*100).toFixed(0)}% loaded`)}),(t=>{console.error(`SpatialAudio: Error loading sound "${e}":`,t),this.activeSounds.delete(r)})),r}stopSound(t){const e=this.activeSounds.get(t);e?(console.log(`SpatialAudio: Stopping sound ID: ${t}`),e.audio.isPlaying&&e.audio.stop(),this._cleanupSound(t)):console.warn(`SpatialAudio: Sound ID ${t} not found for stopping.`)}_cleanupSound(t){const e=this.activeSounds.get(t);if(e){if(e.audio.isPlaying)try{e.audio.stop()}catch{}e.target&&e.audio.parent===e.target&&e.target.remove(e.audio),this.activeSounds.delete(t),console.log(`SpatialAudio: Cleaned up sound ID: ${t}`)}}setVolume(e){this.specificVolume=t.MathUtils.clamp(e,0,1),console.log(`SpatialAudio default specific volume set to: ${this.specificVolume}`)}updateAllVolumes(){this.categoryVolumes&&(console.log(`SpatialAudio: Updating volumes for ${this.activeSounds.size} active sounds.`),this.activeSounds.forEach((t=>{const e=void 0!==t.options.volume?t.options.volume:this.specificVolume,i=this.categoryVolumes.getEffectiveVolume(this.category,e);t.audio.setVolume(i)})))}destroy(){console.log("SpatialAudio Destroying...");Array.from(this.activeSounds.keys()).forEach((t=>this.stopSound(t))),this.activeSounds.clear(),console.log("SpatialAudio Destroyed.")}}class Li extends S{static{this.dependencies={soundOptions:Se}}constructor(t){super(),this.soundSynthesizer=t,this.isListening=!1,this.lastTranscript="",this.lastConfidence=0,this.playActivationSounds=!1,this.handleStartBound=this._handleStart.bind(this),this.handleResultBound=this._handleResult.bind(this),this.handleEndBound=this._handleEnd.bind(this),this.handleErrorBound=this._handleError.bind(this)}init({soundOptions:t}){this.options=t.speechRecognizer;const e=window.SpeechRecognition||window.webkitSpeechRecognition;if(!e)return console.warn("SpeechRecognizer: Speech Recognition API not supported in this browser."),void(this.error="API not supported");this.recognition=new e,this.recognition.lang=this.options.lang,this.recognition.continuous=this.options.continuous,this.recognition.interimResults=this.options.interimResults,this.recognition.onstart=this.handleStartBound,this.recognition.onresult=this.handleResultBound,this.recognition.onend=this.handleEndBound,this.recognition.onerror=this.handleErrorBound}onSimulatorStarted(){this.playActivationSounds=this.options.playSimulatorActivationSounds}start(){if(this.recognition)if(this.isListening)console.warn("SpeechRecognizer: Already listening.");else try{this.lastTranscript="",this.lastCommand=void 0,this.lastConfidence=0,this.error=void 0,this.recognition.start(),this.isListening=!0,console.debug("SpeechRecognizer: Listening started.")}catch(t){console.error("SpeechRecognizer: Error starting recognition:",t),this.error=t.message||"Start failed",this.isListening=!1,this.dispatchEvent({type:"error",error:this.error})}else console.error("SpeechRecognizer: Not initialized.")}stop(){if(this.recognition&&this.isListening)try{this.recognition.stop(),console.debug("SpeechRecognizer: Stop requested.")}catch(t){console.error("SpeechRecognizer: Error stopping recognition:",t),this.error=t.message||"Stop failed",this.isListening=!1}}getLastTranscript(){return this.lastTranscript}getLastCommand(){return this.lastCommand}getLastConfidence(){return this.lastConfidence}_handleStart(){console.debug("SpeechRecognizer: Listening started."),this.dispatchEvent({type:"start"}),this.playActivationSounds&&this.soundSynthesizer.playPresetTone("ACTIVATE")}_handleResult(t){let e="",i="",s=0;for(let n=t.resultIndex;n<t.results.length;++n){const r=t.results[n],o=r[0].transcript;r.isFinal?(i+=o,s=r[0].confidence):e+=o}if(this.lastTranscript=i.trim()||e.trim(),this.lastConfidence=s,this.lastCommand=void 0,i&&this.options.commands.length>0){const t=i.trim().toUpperCase();for(const e of this.options.commands)if(t.includes(e.toUpperCase())&&this.lastConfidence>=this.options.commandConfidenceThreshold){this.lastCommand=e,console.debug(`SpeechRecognizer Detected Command: ${this.lastCommand}`);break}}this.dispatchEvent({type:"result",originalEvent:t,transcript:this.lastTranscript,confidence:this.lastConfidence,command:this.lastCommand,isFinal:!!i})}_handleEnd(){this.isListening=!1,this.dispatchEvent({type:"end"}),this.options.continuous&&"aborted"!==this.error&&"no-speech"!==this.error?(console.debug("SpeechRecognizer: Restarting continuous listening..."),setTimeout((()=>this.start()),100)):this.playActivationSounds&&this.soundSynthesizer.playPresetTone("DEACTIVATE")}_handleError(t){console.error("SpeechRecognizer: Error:",t.error),this.error=t.error,this.isListening=!1,this.dispatchEvent({type:"error",error:t.error})}destroy(){this.stop(),this.recognition&&(this.recognition.onstart=null,this.recognition.onresult=null,this.recognition.onend=null,this.recognition.onerror=null,this.recognition=void 0)}}class Vi extends S{static{this.dependencies={soundOptions:Se}}constructor(t,e=()=>{},i=()=>{},s=t=>{}){super(),this.categoryVolumes=t,this.onStartCallback=e,this.onEndCallback=i,this.onErrorCallback=s,this.synth=window.speechSynthesis,this.voices=[],this.isSpeaking=!1,this.debug=!1,this.specificVolume=1,this.speechCategory="speech",this.synth?(this.loadVoices(),void 0!==this.synth.onvoiceschanged&&(this.synth.onvoiceschanged=this.loadVoices.bind(this))):console.error("SpeechSynthesizer: Speech Synthesis API not supported."),!this.categoryVolumes&&this.synth&&console.warn("SpeechSynthesizer: CategoryVolumes not found. Volume control will use specificVolume only.")}init({soundOptions:t}){this.options=t.speechSynthesizer,this.debug&&console.log("SpeechSynthesizer initialized.")}loadVoices(){this.synth&&(this.voices=this.synth.getVoices(),this.debug&&console.log("SpeechSynthesizer: Voices loaded:",this.voices.length),this.selectedVoice=this.voices.find((t=>t.name.includes("Google")&&t.lang.startsWith("en")))||this.voices.find((t=>t.lang.startsWith("en"))),this.selectedVoice?this.debug&&console.log("SpeechSynthesizer: Selected voice:",this.selectedVoice.name):console.warn("SpeechSynthesizer: No suitable default voice found."))}setVolume(e){this.specificVolume=t.MathUtils.clamp(e,0,1),console.log(`SpeechSynthesizer specific volume set to: ${this.specificVolume}`)}speak(e,i="en-US",s=1,n=1){return new Promise(((r,o)=>{if(!this.synth)return console.warn("SpeechSynthesizer: Cannot speak. API not supported."),o(new Error("Speech Synthesis API not supported."));if(this.isSpeaking){if(!this.options.allowInterruptions){const t="Already speaking and interruptions are not allowed.";return console.warn(`SpeechSynthesizer: ${t}`),o(new Error(t))}console.warn("SpeechSynthesizer: Already speaking. Interrupting current speech."),this.cancel()}const a=new SpeechSynthesisUtterance(e);a.onstart=()=>{this.isSpeaking=!0,console.log("SpeechSynthesizer: Speaking started."),this.onStartCallback&&this.onStartCallback()},a.onend=()=>{this.isSpeaking=!1,console.log("SpeechSynthesizer: Speaking ended."),this.onEndCallback&&this.onEndCallback(),r()},a.onerror=t=>{!this.options.allowInterruptions||"interrupted"!==t.error&&"canceled"!==t.error?(console.error("SpeechSynthesizer: Error occurred:",t.error),this.isSpeaking=!1,this.onErrorCallback(new Error(`Speech synthesis error code ${t.error}`)),o(t.error)):console.warn(`SpeechSynthesizer: Speech utterance interrupted: ${t.error}`)};let h=this.selectedVoice;h&&h.lang.startsWith(i.substring(0,2))||(h=this.voices.find((t=>t.lang===i&&t.name.includes("Google")))||this.voices.find((t=>t.lang.startsWith(i.substring(0,2))&&t.name.includes("Google")))||this.voices.find((t=>t.lang===i))||this.voices.find((t=>t.lang.startsWith(i.substring(0,2))))),h?(a.voice=h,console.log(`SpeechSynthesizer: Using voice: ${h.name} for lang ${i}`)):(a.lang=i,console.warn(`SpeechSynthesizer: No specific voice found for lang ${i}. Using browser default.`)),a.pitch=t.MathUtils.clamp(s,0,2),a.rate=t.MathUtils.clamp(n,.1,10);let l=this.specificVolume;l=this.categoryVolumes?this.categoryVolumes.getEffectiveVolume(this.speechCategory,this.specificVolume):t.MathUtils.clamp(this.specificVolume,0,1),a.volume=l,console.log(`SpeechSynthesizer: Setting utterance volume to ${l}`),this.synth.speak(a)}))}tts(t,e,i,s){this.speak(t,e,i,s)}cancel(){this.synth&&this.synth.speaking&&(this.synth.cancel(),this.isSpeaking=!1,console.log("SpeechSynthesizer: Speech cancelled."))}destroy(){this.cancel(),this.synth&&void 0!==this.synth.onvoiceschanged&&(this.synth.onvoiceschanged=null),this.voices=[],console.log("SpeechSynthesizer destroyed.")}}class Bi extends S{constructor(){super(...arguments),this.categoryVolumes=new Ei,this.soundSynthesizer=new Pi,this.listener=new t.AudioListener}static{this.dependencies={camera:t.Camera,soundOptions:Se}}init({camera:t,soundOptions:e}){this.options=e,this.backgroundMusic=new Mi(this.listener,this.categoryVolumes),this.spatialAudio=new Ii(this.listener,this.categoryVolumes),this.audioListener=new bi,this.audioPlayer=new Ci,this.audioPlayer.setCategoryVolumes(this.categoryVolumes),t.add(this.listener),this.add(this.backgroundMusic),this.add(this.spatialAudio),this.add(this.audioListener),this.add(this.audioPlayer),this.add(this.soundSynthesizer),this.options.speechRecognizer.enabled&&(this.speechRecognizer=new Li(this.soundSynthesizer),this.add(this.speechRecognizer)),this.options.speechSynthesizer.enabled&&(this.speechSynthesizer=new Vi(this.categoryVolumes),this.add(this.speechSynthesizer))}getAudioListener(){return this.listener}setMasterVolume(e){this.categoryVolumes.masterVolume=t.MathUtils.clamp(e,0,1),this.audioPlayer?.updateGainNodeVolume()}getMasterVolume(){return this.categoryVolumes.isMuted?0:this.categoryVolumes.masterVolume}setCategoryVolume(e,i){e in this.categoryVolumes.volumes&&(this.categoryVolumes.volumes[e]=t.MathUtils.clamp(i,0,1))}getCategoryVolume(t){return t in this.categoryVolumes.volumes?this.categoryVolumes.volumes[t]:1}async enableAudio(t={}){const{streamToAI:e=!0,accumulate:i=!1}=t;e&&this.speechRecognizer?.isListening&&(console.log("Disabling SpeechRecognizer while streaming audio."),this.speechRecognizer.stop()),this.audioListener.setAIStreaming(e),await this.audioListener.startCapture({accumulate:i})}disableAudio(){this.audioListener?.stopCapture()}async startRecording(){await this.audioListener.startCapture({accumulate:!0})}stopRecording(){const t=this.audioListener.getAccumulatedBuffer();return this.audioListener.stopCapture(),t}getRecordedBuffer(){return this.audioListener.getAccumulatedBuffer()}clearRecordedBuffer(){this.audioListener.clearAccumulatedBuffer()}getRecordingSampleRate(){return this.audioListener.audioContext?.sampleRate||48e3}setAIStreaming(t){this.audioListener?.setAIStreaming(t)}isAIStreamingEnabled(){return null!==this.audioListener?.aiService}async playAIAudio(t){await this.audioPlayer.playAudioChunk(t)}stopAIAudio(){this.audioPlayer?.clearQueue()}isAIAudioPlaying(){return this.audioPlayer?.getIsPlaying()}async playRecordedAudio(t,e){if(!t)return;e&&e!==this.audioPlayer.options.sampleRate&&(this.audioPlayer.options.sampleRate=e,this.audioPlayer.stop());const i=new Uint8Array(t);let s="";for(let t=0;t<i.length;t++)s+=String.fromCharCode(i[t]);const n=btoa(s);await this.audioPlayer.playAudioChunk(n)}isAudioEnabled(){return this.audioListener?.getIsCapturing()}getLatestAudioBuffer(){return this.audioListener?.getLatestAudioBuffer()}clearLatestAudioBuffer(){this.audioListener?.clearLatestAudioBuffer()}getEffectiveVolume(t,e=1){return this.categoryVolumes.getEffectiveVolume(t,e)}muteAll(){this.categoryVolumes.isMuted=!0}unmuteAll(){this.categoryVolumes.isMuted=!1}destroy(){this.backgroundMusic?.destroy(),this.spatialAudio?.destroy(),this.speechRecognizer?.destroy(),this.speechSynthesizer?.destroy(),this.audioListener?.dispose(),this.audioPlayer?.dispose(),this.listener?.parent?.remove(this.listener)}}const Fi=.868,zi=new t.Vector3;class ji extends S{get rangeX(){return Math.max(this.aspectRatio,1)}get rangeY(){return Math.max(1/this.aspectRatio,1)}constructor(e={},i,s){super(),this.name="View",this.isQuad=!0,this.isRoot=!1,this.isView=!0,this.selectable=!0,this.weight=.5,this.width=1,this.height=1,this.x=0,this.y=0,this.z=0,this.paddingX=0,this.paddingY=0,this.paddingZ=0,this.opacity=1,this.aspectRatio=1,i&&s&&(this.mesh=new t.Mesh(i,s),this.add(this.mesh)),Object.assign(this,e)}static dpToMeters(t){return t*Fi*.001}dpToLocalUnits(t){return this.getWorldScale(zi),ji.dpToMeters(t)/zi.x}show(){this.visible=!0,this.traverse((t=>{t.visible=!0}))}hide(){this.visible=!1,this.traverse((t=>{t.visible=!1}))}updateLayout(){this.isRoot||null==this.parent?(this.aspectRatio=this.width/this.height,this.scale.setScalar(Math.min(this.width,this.height))):this.parent instanceof ji&&(this.position.set((this.x+this.paddingX)*this.parent.rangeX,(this.y-this.paddingY)*this.parent.rangeY,this.paddingZ+tt),this.aspectRatio=this.width/this.height*this.parent.aspectRatio,this.scale.setScalar(Math.min(this.parent.rangeX*this.width,this.parent.rangeY*this.height)),this.renderOrder=this.parent.renderOrder+1)}updateLayouts(){this.updateLayoutsBFS()}updateLayoutsBFS(){const t=[this];for(;t.length>0;){const e=t.shift();e instanceof ji&&(e.updateLayout(),e.children.forEach((e=>{t.push(e)})))}}resetLayout(){}resetLayouts(){const t=[this];for(;t.length>0;){const e=t.shift();e instanceof ji&&(e.resetLayout(),e.children.forEach((e=>{t.push(e)})))}}add(...t){super.add(...t);for(const e of t)e instanceof ji&&e.updateLayoutsBFS();return this}onTriggered(t){}}const ki="https://fonts.gstatic.com/s/roboto/v18/KFOmCnqEu92Fr1Mu4mxM.woff",Ui="https://cdn.jsdelivr.net/gh/marella/material-icons@v1.13.14/iconfont/material-icons.woff";var Ni;let Gi;!function(t){t[t.PENDING=0]="PENDING",t[t.SUCCESS=1]="SUCCESS",t[t.FAILED=2]="FAILED"}(Ni||(Ni={}));let Hi,Wi=Ni.PENDING;class qi extends ji{set text(t){this._text=t,this.useSDFText&&Gi&&this.textObj instanceof Gi?(this.textObj.text=t,this.textObj.sync()):this.updateHTMLText()}get text(){return this._text}constructor(t={},e,i){super(t,e,i),this.useSDFText=!0,this.isRoot=!1,this.name="TextView",this.font=ki,this.fontColor=16777215,this.maxWidth=1,this.mode="fitWidth",this.anchorX="center",this.anchorY="middle",this.textAlign="center",this.imageOffsetX=0,this.imageOffsetY=0,this.x=0,this.y=0,this.width=1,this.height=1,this.lineHeight=0,this.lineCount=0,this._initializeTextCalled=!1,this._text="TextView",this.useSDFText=t.useSDFText??this.useSDFText,this.font=t.font??this.font,this.fontSize=t.fontSize??this.fontSize,this.fontSizeDp=t.fontSizeDp??this.fontSizeDp,this.fontColor=t.fontColor??this.fontColor,this.maxWidth=t.maxWidth??this.maxWidth,this.mode=t.mode??this.mode,this.anchorX=t.anchorX??this.anchorX,this.anchorY=t.anchorY??this.anchorY,this.textAlign=t.textAlign??this.textAlign,this.imageOverlay=t.imageOverlay??this.imageOverlay,this.imageOffsetX=t.imageOffsetX??this.imageOffsetX,this.imageOffsetY=t.imageOffsetY??this.imageOffsetY,this.text=t.text??this._text}async init(t){this.useSDFText=this.useSDFText&&await async function(){if(Gi)return!0;try{const t=await import("troika-three-text");return Gi=t.Text,Wi=Ni.SUCCESS,!0}catch(t){return t instanceof Error&&(Hi=t),Wi=Ni.FAILED,!1}}(),this._initializeText()}setText(t){this.text=t}updateLayout(){if(super.updateLayout(),this.textObj&&(this.textObj.renderOrder=this.renderOrder,void 0===this.fontSizeDp&&"fitWidth"===this.mode))this.textObj.scale.setScalar(this.rangeX);this.fontSizeDp&&this.textObj&&this.createTextSDF()}createTextSDF(){const t=Gi&&this.textObj instanceof Gi?this.textObj:new Gi;t.text=this.text,t.color=I(this.fontColor),t.font=this.font,t.anchorX=this.anchorX,t.anchorY=this.anchorY,void 0!==this.fontSizeDp?t.fontSize=this.dpToLocalUnits(this.fontSizeDp):void 0!==this.fontSize?t.fontSize=this.fontSize:t.fontSize=.06,t.maxWidth=this.maxWidth,t.textAlign=this.textAlign,t.material&&(t.material.depthWrite=!t.material.transparent),t.sync(),this.textObj=t,this.textObj.layers.mask=this.layers.mask,this.add(this.textObj)}createTextHTML(){this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d");const e=new t.PlaneGeometry(this.width,this.height),i=new t.CanvasTexture(this.canvas),s=new t.MeshBasicMaterial({map:i,transparent:!0});this.textObj=new t.Mesh(e,s),this.updateHTMLText(),this.add(this.textObj)}updateHTMLText(){if(!this.ctx)return;const{canvas:t,ctx:e}=this;t.width=256*this.width,t.height=256*this.height,e.clearRect(0,0,t.width,t.height);const i=void 0!==this.fontSizeDp?this.dpToLocalUnits(this.fontSizeDp):this.fontSize??.06;e.font=`${256*i}px ${this.font}`,e.fillStyle=`#${I(this.fontColor).toString(16).padStart(6,"0")}`,e.textAlign="center",e.textBaseline="middle",e.fillText(this.text,t.width/2,t.height/2),this.textObj?.material.map&&(this.textObj.material.map.needsUpdate=!0)}onSyncComplete(){if(!(this.useSDFText&&this.textObj instanceof Gi&&this.textObj.textRenderInfo))return;const t=this.textObj.textRenderInfo.caretPositions,e=t.length/4;let i=0;const s=e>0?t[0]:0;let n=999999;for(let s=0;s<e;s++){const e=t[4*s+2];e<n-(t[4*s+3]-e)/2&&(i++,n=e)}this.lineHeight=e>0?(s-n)/i:0,this.lineCount=i,this.dispatchEvent({type:"synccomplete"})}_initializeText(){this._initializeTextCalled||(this._initializeTextCalled=!0,this.useSDFText&&Wi===Ni.SUCCESS?this.createTextSDF():(Wi===Ni.FAILED&&(console.warn("Failed to import `troika-three-text`. For 3D text rendering, please ensure `troika-three-text`, `troika-three-utils`, `troika-worker-utils`, `bidi-js`, and `webgl-sdf-generator` are included in your importmap or installed via npm. Refer to templates/1_ui for an example. Falling back to HTML-based text rendering.","Error details:",Hi?.message),Hi=void 0),this.createTextHTML()),this.useSDFText&&Gi&&this.textObj instanceof Gi&&(this.textObj.addEventListener("synccomplete",this.onSyncComplete.bind(this)),this.imageOverlay&&(new t.TextureLoader).load(this.imageOverlay,(e=>{e.colorSpace=t.SRGBColorSpace,e.offset.x=this.imageOffsetX;const i=this.textObj;i.material.map=e,i.material.needsUpdate=!0,i.sync()}))),this.updateLayout())}syncTextObj(){Gi&&this.textObj instanceof Gi&&this.textObj.sync()}setTextColor(t){Gi&&this.textObj instanceof Gi&&(this.textObj.color=t)}dispose(){this.useSDFText&&this.textObj&&Gi&&this.textObj instanceof Gi&&this.textObj.removeEventListener("synccomplete",this.onSyncComplete.bind(this)),super.dispose()}}class Xi extends qi{get rangeX(){return 1}get rangeY(){return 1}constructor(e={}){const{backgroundColor:i=11184810}=e;super(e,new t.CircleGeometry(.5,32),new t.MeshBasicMaterial({color:i,transparent:!0,depthWrite:!1,opacity:0,side:t.FrontSide})),this.opacity=1,this.defaultOpacity=0,this.hoverColor=11184810,this.hoverOpacity=.2,this.selectedOpacity=.4,this.font=Ui,Object.assign(this,e)}async init(t){await super.init(),this.mesh&&(this.mesh.renderOrder=this.renderOrder),this.textObj&&(this.textObj.renderOrder=this.renderOrder+1)}onHoverOver(){this.ux&&this.update()}onHoverOut(){this.ux&&this.update()}update(){this.ux&&(this.ux.isHovered()||this.ux.isSelected()?this.mesh.material.opacity=this.ux.isSelected()?this.selectedOpacity*this.opacity:this.hoverOpacity*this.opacity:this.mesh.material.opacity=this.defaultOpacity*this.opacity)}_initializeText(){if(super._initializeText(),this.textObj){if(this.textObj.position.set(0,0,tt),this.textObj.raycast=()=>{},this.update(),"center"===this.mode)this.textObj.scale.setScalar(this.rangeX);this.textObj.scale.set(1,1,1)}this.syncTextObj(),this.updateLayout()}}class Ki extends qi{constructor(t={}){super({font:Ui,...t})}}class $i extends ji{constructor(e={}){super(e),this.initCalled=!1,this.textureLoader=new t.TextureLoader;const i=new t.MeshBasicMaterial({map:null,transparent:!0,depthWrite:!1,side:t.DoubleSide}),s=new t.PlaneGeometry(1,1);this.mesh=new t.Mesh(s,i),this.material=i,this.add(this.mesh)}init(){this.initCalled||(this.initCalled=!0,this.reload())}reload(){if(!this.src)return this.material.map&&(this.material.map=null,this.material.needsUpdate=!0),this.texture?.dispose(),void(this.texture=void 0);this.texture?.dispose(),this.texture=this.textureLoader.load(this.src,(e=>{e.colorSpace=t.SRGBColorSpace,this.material.map=e,this.material.needsUpdate=!0,this.updateLayout()}))}updateLayout(){super.updateLayout(),this.mesh&&(this.mesh.renderOrder=this.renderOrder),this.scaleImageToCorrectAspectRatio()}scaleImageToCorrectAspectRatio(){if(this.texture?.image){const{image:t}=this.texture,e=t.width,i=t.height,s=this.rangeX/e,n=this.rangeY/i,r=Math.min(s,n);this.mesh.scale.set(e*r,i*r,1)}}load(t){this.src=t,this.reload()}}class Qi extends qi{constructor(t={}){super(t),this.layers.set(4)}createTextSDF(){super.createTextSDF(),this.textObj.material.depthText=!1,this.textObj.material.depthWrite=!1}}const Yi={uniforms:{uMainTex:{value:null},uUseImage:{value:0},uBackgroundColor:{value:new t.Vector4(.4,.8,1,1)},uBoxSize:{value:new t.Vector2(.5,.5)},uRadius:{value:.05},uOpacity:{value:1}},vertexShader:"\n    #define USE_UV\n    #include <common>\n    #include <batching_pars_vertex>\n    #include <uv_pars_vertex>\n    #include <envmap_pars_vertex>\n    #include <color_pars_vertex>\n    #include <fog_pars_vertex>\n    #include <morphtarget_pars_vertex>\n    #include <skinning_pars_vertex>\n    #include <logdepthbuf_pars_vertex>\n    #include <clipping_planes_pars_vertex>\n\n    void main() {\n      #include <uv_vertex>\n      #include <color_vertex>\n      #include <morphinstance_vertex>\n      #include <morphcolor_vertex>\n      #include <batching_vertex>\n\n      #if defined ( USE_ENVMAP ) || defined ( USE_SKINNING )\n\n        #include <beginnormal_vertex>\n        #include <morphnormal_vertex>\n        #include <skinbase_vertex>\n        #include <skinnormal_vertex>\n        #include <defaultnormal_vertex>\n\n      #endif\n\n      #include <begin_vertex>\n      #include <morphtarget_vertex>\n      #include <skinning_vertex>\n      #include <project_vertex>\n      #include <logdepthbuf_vertex>\n      #include <clipping_planes_vertex>\n\n      #include <worldpos_vertex>\n      #include <envmap_vertex>\n      #include <fog_vertex>\n    }\n  ",fragmentShader:"\n    precision mediump float;\n\n    uniform sampler2D uMainTex;\n    uniform vec4 uBackgroundColor;\n    uniform vec2 uBoxSize;\n    uniform float uRadius;\n    uniform float uUseImage;\n    uniform float uOpacity;\n\n    #define USE_UV\n    #include <common>\n    #include <dithering_pars_fragment>\n    #include <color_pars_fragment>\n    #include <uv_pars_fragment>\n    #include <map_pars_fragment>\n    #include <alphamap_pars_fragment>\n    #include <alphatest_pars_fragment>\n    #include <alphahash_pars_fragment>\n    #include <aomap_pars_fragment>\n    #include <lightmap_pars_fragment>\n    #include <envmap_common_pars_fragment>\n    #include <envmap_pars_fragment>\n    #include <fog_pars_fragment>\n    #include <specularmap_pars_fragment>\n    #include <logdepthbuf_pars_fragment>\n    #include <clipping_planes_pars_fragment>\n\n    // Distance function for rounded box.\n    float distRoundBox(vec2 p, vec2 b, float r) {\n      return length(max(abs(p) - b + r, 0.0)) - r;\n    }\n\n    void main(void) {\n      #include <clipping_planes_fragment>\n\n      #include <logdepthbuf_fragment>\n      #include <map_fragment>\n      #include <color_fragment>\n      #include <alphamap_fragment>\n      #include <alphatest_fragment>\n      #include <alphahash_fragment>\n      #include <specularmap_fragment>\n      vec2 size = uBoxSize * 1000.0;\n\n      // Calculates the adjusted radius based on box size.\n      float radius = min(size.x, size.y) * (0.05 + uRadius);\n      vec2 half_size = 0.5 * size;\n\n      // Compute the distance from the rounded box edge.\n      float dist = distRoundBox(vUv * size - half_size, half_size, radius);\n\n      // Use lerp for smooth color transition based on distance.\n      vec4 colorInside = uBackgroundColor;\n\n      if (uUseImage > 0.5) {\n        colorInside = texture2D(uMainTex, vUv);\n        colorInside.a = 1.0;\n      }\n\n      // Transparent black for outside.\n      vec4 colorOutside = vec4(0.0, 0.0, 0.0, 0.0);\n\n      vec4 finalColor = mix(colorInside, colorOutside, smoothstep(0.0, 1.0, dist));\n\n      // Return premultiplied alpha.\n      gl_FragColor = uOpacity * finalColor.a * vec4(finalColor.rgb, 1.0);\n    }\n  "};class Ji extends qi{constructor(e={}){const i=new t.PlaneGeometry(1,1),s=A(e.backgroundColor??"#00000000"),{opacity:n=0,radius:r=Yi.uniforms.uRadius.value,boxSize:o=Yi.uniforms.uBoxSize.value}=e,a={...Yi.uniforms,uBackgroundColor:{value:s},uOpacity:{value:n},uAspect:{value:1},uRadius:{value:r},uBoxSize:{value:o}};super(e,i,new t.ShaderMaterial({...Yi,transparent:!0,uniforms:a,depthWrite:!1})),this.name="TextButton",this.fontSize=.05,this.fontColor=16777215,this.opacity=1,this.defaultOpacity=1,this.hoverColor=11184810,this.hoverOpacity=.2,this.selectedFontColor=10066329,this.selectedOpacity=.4,this.width=.9,this.height=.9,this.mode="center",this.imageOffsetX=0,this.imageOffsetY=0,this.uniforms=a,this.opacity=n,this.fontSize=e.fontSize??this.fontSize,this.fontColor=e.fontColor??this.fontColor,this.width=e.width??this.width,this.height=e.height??this.height}async init(){await super.init(),this.textObj.position.set(0,0,tt),this.mesh&&(this.mesh.renderOrder=this.renderOrder),this.textObj.renderOrder=this.renderOrder+1,this.textObj.raycast=()=>{}}update(){if(!this.textObj)return;this.textObj&&(this.textObj.renderOrder=this.renderOrder+1);const t=this.ux;t.isHovered()?t.isSelected()?this.setTextColor(6710886):this.setTextColor(11184810):(this.setTextColor(16777215),this.uniforms.uOpacity.value=this.defaultOpacity*this.opacity)}}class Zi extends ji{constructor(e={}){super(e),this.name="VideoView",this.mode="center",this.isRoot=!1,this.muted=!0,this.loop=!0,this.autoplay=!0,this.playsInline=!0,this.crossOrigin="anonymous",this.videoAspectRatio=0;const i=new t.PlaneGeometry(1,1),s=new t.MeshBasicMaterial({transparent:!0,depthWrite:!1,side:t.DoubleSide});this.mesh=new t.Mesh(i,s),this.material=s,this.add(this.mesh),this.texture instanceof t.Texture||(this.texture=new t.Texture),this.material.map=this.texture}init(){super.init(),this.material.map instanceof t.VideoTexture&&this.material.map.image?this.loadFromVideoTexture(this.material.map):this.src&&this.load(this.src)}load(e){e instanceof HTMLVideoElement?this.loadFromVideoElement(e):e instanceof t.VideoTexture?this.loadFromVideoTexture(e):"string"==typeof e?this.loadFromURL(e):e instanceof jt?this.loadFromStream(e):console.error("VideoView: Invalid video source provided.",e)}loadFromStream(t){this.disposeStreamListener_(),this.stream_=t,this.streamReadyCallback_=t=>{this.stream_?.texture?(this.loadFromVideoTexture(this.stream_.texture),void 0!==t.details?.aspectRatio&&(this.videoAspectRatio=t.details?.aspectRatio),this.updateLayout()):console.warn("Stream is ready, but its texture is not available.")},this.stream_.loaded?this.streamReadyCallback_({details:{aspectRatio:this.stream_.aspectRatio}}):this.stream_.addEventListener("statechange",this.streamReadyCallback_)}loadFromURL(t){this.src=t;const e=document.createElement("video");e.muted=this.muted,e.loop=this.loop,e.playsInline=this.playsInline,e.autoplay=this.autoplay,e.crossOrigin=this.crossOrigin,e.src=t,this.loadFromVideoElement(e)}loadFromVideoElement(e){this.video=e,this.video.autoplay&&this.video.paused&&this.video.play().catch((t=>{console.warn("VideoView: Autoplay prevented for video element.",t)}));const i=new t.VideoTexture(this.video);i.colorSpace=t.SRGBColorSpace,this.texture=i,this.material.map=this.texture,this.material.needsUpdate=!0;const s=()=>{this.video.videoWidth&&this.video.videoHeight?this.videoAspectRatio=this.video.videoWidth/this.video.videoHeight:(console.warn("VideoView: Video metadata loaded but dimensions are 0."),this.videoAspectRatio=0),this.updateLayout()};this.video.readyState>=this.video.HAVE_METADATA?s():this.video.addEventListener("loadedmetadata",s,{once:!0})}loadFromVideoTexture(t){this.texture=t,this.material.map=this.texture,this.material.needsUpdate=!0,this.video=this.texture.image,this.video&&this.video.videoWidth&&this.video.videoHeight?(this.videoAspectRatio=this.video.videoWidth/this.video.videoHeight,this.updateLayout()):this.video?this.video.addEventListener("loadedmetadata",(()=>{this.video.videoWidth&&this.video.videoHeight?this.videoAspectRatio=this.video.videoWidth/this.video.videoHeight:this.videoAspectRatio=0,this.updateLayout()}),{once:!0}):(console.warn("VideoView: VideoTexture does not have a valid underlying video element."),this.videoAspectRatio=0,this.updateLayout())}play(){this.video&&this.video.paused&&this.video.play().catch((t=>console.warn("VideoView: Error playing video:",t)))}pause(){this.video&&!this.video.paused&&this.video.pause()}disposeStreamListener_(){this.stream_&&this.streamReadyCallback_&&(this.stream_.removeEventListener("statechange",this.streamReadyCallback_),this.stream_=void 0,this.streamReadyCallback_=void 0)}dispose(){this.disposeStreamListener_(),this.video&&(this.video.pause(),this.video.removeAttribute("src"),this.video.load(),this.video=void 0),this.texture&&(this.texture.dispose(),this.texture=void 0),super.dispose()}updateLayout(){super.updateLayout(),"stretch"===this.mode||this.videoAspectRatio<=0||!this.material.map||this.mesh.scale.set(Math.min(this.rangeX,this.videoAspectRatio*this.rangeY),Math.min(this.rangeY,this.rangeX/this.videoAspectRatio),1)}}function ts(t,e){let i=t;for(;i;){if(i===e)return!0;i=i.parent}return!1}function es(t,e){if(e(t))return!0;for(const i of t.children)if(es(i,e))return!0;return!1}class is extends S{static{this.dependencies={input:ce,scene:t.Scene}}constructor(){super(),this.local=!0,this.numHands=2,this.height=1.6,this.panelDistance=1.75,this.handedness=1,this.safeSpaceRadius=.2,this.objectDistance=1.5,this.objectAngle=-.1*Math.PI,this.pivots=[],this.hoveredObjectsForController=new Map,this.selectedObjectsForController=new Map,this.touchedObjects=new Map,this.grabbedObjects=new Map}init({input:t,scene:e}){this.input=t,this.controllers=t.controllers,this.scene=e}setHeight(t){this.height=t.position.y}enablePivots(){this.input.enablePivots()}getPivot(t){return this.controllers[t].getObjectByName("pivot")}getPivotPosition(e){return this.getPivot(e)?.getWorldPosition(new t.Vector3)}getReticleDirection(t){return this.controllers[t].reticle?.direction}getReticleTarget(t){return this.controllers[t].reticle?.targetObject}getReticleIntersection(t){return this.controllers[t].reticle?.intersection}isPointingAt(t){for(const e of this.hoveredObjectsForController.values())if(ts(e,t))return!0;return!1}isSelectingAt(t){for(const e of this.selectedObjectsForController.values())if(ts(e,t))return!0;return!1}getIntersectionAt(t,e=-1){if(-1==e){for(let e=0;e<2;++e)if(this.getReticleTarget(e)===t)return this.getReticleIntersection(e)}else if(this.getReticleTarget(e)===t)return this.getReticleIntersection(e);return null}getControllerPosition(e,i=new t.Vector3){return this.controllers[e].getWorldPosition(i),i}getControllerObjectDistance(e,i){const s=this.getControllerPosition(e),n=new t.Vector3;return i.getWorldPosition(n),s.distanceTo(n)}isSelecting(t=-1){return-1==t?this.input.controllers.some((t=>t.userData.selected)):this.input.controllers[t].userData.selected}isSqueezing(t=-1){return-1==t?this.input.controllers.some((t=>t.userData.squeezing)):this.input.controllers[t].userData.squeezing}onSelectStart(t){const e=t.target,i=this.input.intersectionsForController.get(e).filter((t=>{let e=t.object;for(;e;){if(!0===e.ignoreReticleRaycast)return!1;e=e.parent}return!0}));i&&i.length>0&&(this.selectedObjectsForController.set(e,i[0].object),this.callObjectSelectStart(t,i[0].object))}onSelectEnd(t){const e=t.target,i=this.input.intersectionsForController.get(e);if(i&&i.length>0){const i=this.selectedObjectsForController.get(e);this.callObjectSelectEnd(t,i||null),this.selectedObjectsForController.delete(e);let s=i||null;for(;s;){if(s.isView&&s.visible){s.onTriggered(e.userData.id);break}s=s.parent}}}onSqueezeStart(t){}onSqueezeEnd(t){}update(){if(this.input.controllersEnabled)for(const t of this.input.controllers)this.updateForController(t);this.updateTouchState(),this.updateGrabState()}updateGrabState(){if(this.hands)for(let t=0;t<this.numHands;t++){const e=this.isSelecting(t),i=this.touchedObjects.get(t)||new Set,s=e?i:new Set,n=this.grabbedObjects.get(t)||new Map,r=[...s].filter((t=>!n.has(t))),o=[...n.keys()].filter((t=>!s.has(t)));for(const e of r){const i=this.hands.getWrist(t);if(!i)continue;const s={handIndex:t,hand:i};this.grabbedObjects.has(t)||this.grabbedObjects.set(t,new Map),this.grabbedObjects.get(t).set(e,s),this.callObjectGrabStart(s,e)}for(const t of o){const e=n.get(t);this.callObjectGrabEnd(e,t),n.delete(t)}for(const t of s)if(n.has(t)){const e=n.get(t);this.callObjectGrabbing(e,t)}}}updateTouchState(){if(this.hands)for(let e=0;e<this.numHands;e++){const i=this.hands.getIndexTip(e);if(!i)continue;const s=new t.Vector3;i.getWorldPosition(s);const n=[];this.scene.traverse((e=>{if(e.isMesh&&e.visible){(new t.Box3).setFromObject(e).containsPoint(s)&&n.push(e)}}));const r=this.touchedObjects.get(e)||new Set,o=new Set(n),a=n.filter((t=>!r.has(t))),h=[...r].filter((t=>!o.has(t))),l={handIndex:e,touchPosition:s};if(a.length>0)for(const t of a)this.callObjectTouchStart(l,t);if(h.length>0)for(const t of h)this.callObjectTouchEnd(l,t);for(const t of o)this.callObjectTouching(l,t);o.size>0?this.touchedObjects.set(e,o):this.touchedObjects.delete(e)}}updateForController(t){const e=this.input.intersectionsForController.get(t),i=e.length>0?e[0].object:null,s=this.hoveredObjectsForController.get(t);s!==i?(this.callHoverExit(t,s||null),this.hoveredObjectsForController.set(t,i),this.callHoverEnter(t,i)):s&&this.callOnHovering(t,s)}callHoverExit(t,e){null!=e&&(e.isXRScript&&e.onHoverExit(t),this.callHoverExit(t,e.parent))}callHoverEnter(t,e){null!=e&&(e.isXRScript&&e.onHoverEnter(t),this.callHoverEnter(t,e.parent))}callOnHovering(t,e){null!=e&&(e.isXRScript&&e.onHovering(t),this.callOnHovering(t,e.parent))}callObjectSelectStart(t,e){null!=e&&(e.isXRScript&&e.onObjectSelectStart(t)||this.callObjectSelectStart(t,e.parent))}callObjectSelectEnd(t,e){null!=e&&(e.isXRScript&&e.onObjectSelectEnd(t)||this.callObjectSelectEnd(t,e.parent))}callObjectTouchStart(t,e){null!=e&&(e.isXRScript&&e.onObjectTouchStart(t),this.callObjectTouchStart(t,e.parent))}callObjectTouching(t,e){null!=e&&(e.isXRScript&&e.onObjectTouching(t),this.callObjectTouching(t,e.parent))}callObjectTouchEnd(t,e){null!=e&&(e.isXRScript&&e.onObjectTouchEnd(t),this.callObjectTouchEnd(t,e.parent))}callObjectGrabStart(t,e){null!=e&&(e.isXRScript&&e.onObjectGrabStart(t),this.callObjectGrabStart(t,e.parent))}callObjectGrabbing(t,e){null!=e&&(e.isXRScript&&e.onObjectGrabbing(t),this.callObjectGrabbing(t,e.parent))}callObjectGrabEnd(t,e){null!=e&&(e.isXRScript&&e.onObjectGrabEnd(t),this.callObjectGrabEnd(t,e.parent))}select(t,e){const i=this.input.intersectionsForController.get(e);return i&&i.length>0&&ts(i[0].object,t)?i[0]:null}}const ss=Object.freeze(new t.Vector3(0,-1,0)),ns=Object.freeze(new t.Vector3(0,1,0)),rs=Object.freeze(new t.Vector3(0,0,-1)),os=Object.freeze(new t.Vector3(0,0,1)),as=Object.freeze(new t.Vector3(-1,0,0)),hs=Object.freeze(new t.Vector3(1,0,0)),ls=Object.freeze(new t.Vector3(0,0,0)),cs=new t.Quaternion,ds=new t.Euler,us=new t.Vector3;var ps;!function(t){t.TRANSLATING="TRANSLATING",t.ROTATING="ROTATING",t.SCALING="SCALING",t.DO_NOT_DRAG="DO_NOT_DRAG"}(ps||(ps={}));class gs extends S{constructor(){super(...arguments),this.mode=gs.IDLE,this.originalObjectPosition=new t.Vector3,this.originalObjectRotation=new t.Quaternion,this.originalObjectScale=new t.Vector3,this.originalController1Position=new t.Vector3,this.originalController1RotationInverse=new t.Quaternion,this.originalController1MatrixInverse=new t.Matrix4,this.originalScalingControllerDistance=0,this.originalScalingObjectScale=new t.Vector3}static{this.dependencies={input:ce,camera:t.Camera}}static{this.IDLE="IDLE"}static{this.TRANSLATING=ps.TRANSLATING}static{this.ROTATING=ps.ROTATING}static{this.SCALING=ps.SCALING}static{this.DO_NOT_DRAG=ps.DO_NOT_DRAG}init({input:t,camera:e}){this.input=t,this.camera=e}onSelectStart(t){const e=t.target,i=this.input.intersectionsForController.get(e);i&&i.length>0&&this.beginDragging(i[0],e)}onSelectEnd(){this.mode=gs.IDLE,this.intersection=void 0,this.draggableObject=void 0}update(){for(const t of this.input.controllers)this.updateDragging(t)}beginDragging(t,e){const[i,s]=this.findDraggableObjectAndDraggingMode(t.object);return null!=i&&null!=s&&s!=gs.DO_NOT_DRAG&&(this.mode!=gs.IDLE?this.beginScaling(e):(this.draggableObject=i,this.mode=s==gs.ROTATING?gs.ROTATING:gs.TRANSLATING,this.originalController1Position.copy(e.position),this.originalController1MatrixInverse.compose(e.position,e.quaternion,e.scale).invert(),this.originalController1RotationInverse.copy(e.quaternion).invert(),this.intersection=t,this.controller1=e,this.originalObjectRotation.copy(i.quaternion),this.originalObjectPosition.copy(i.position),this.originalObjectScale.copy(i.scale),!0))}beginScaling(t){return this.controller2=t,this.originalScalingControllerDistance=us.subVectors(this.controller1.position,this.controller2.position).length(),this.originalScalingObjectScale.copy(this.intersection.object.scale),this.mode=gs.SCALING,!0}updateDragging(t){return this.mode==gs.TRANSLATING?this.updateTranslating():this.mode==gs.ROTATING?this.updateRotating(t):this.mode==gs.SCALING&&this.updateScaling()}updateTranslating(){const t=this.draggableObject;return t.position.copy(this.originalObjectPosition),t.quaternion.copy(this.originalObjectRotation),t.scale.copy(this.originalObjectScale),t.updateMatrix(),this.controller1.updateMatrix(),t.matrix.premultiply(this.originalController1MatrixInverse).premultiply(this.controller1.matrix),t.position.setFromMatrixPosition(t.matrix),t.dragFacingCamera&&this.turnPanelToFaceTheCamera(),!0}updateRotating(e){if(e!=this.controller1)return;if(e instanceof ae)return this.updateRotatingFromMouseController(e);const i=this.draggableObject,s=(new t.Vector3).subVectors(e.position,this.originalController1Position);s.applyQuaternion(this.originalController1RotationInverse);const n=cs.setFromAxisAngle(ns,10*s.x);return i.quaternion.multiplyQuaternions(n,this.originalObjectRotation),!0}updateRotatingFromMouseController(t){const e=this.draggableObject,i=cs.multiplyQuaternions(t.quaternion,this.originalController1RotationInverse),s=ds.setFromQuaternion(i,"YXZ"),n=cs.setFromAxisAngle(ns,-10*s.y);return e.quaternion.multiplyQuaternions(n,this.originalObjectRotation),!0}updateScaling(){const t=us.subVectors(this.controller1.position,this.controller2.position).length()/this.originalScalingControllerDistance;return this.draggableObject.scale.copy(this.originalScalingObjectScale).multiplyScalar(t),!0}turnPanelToFaceTheCamera(){const t=this.draggableObject;us.subVectors(t.position,this.camera.position),t.quaternion.setFromAxisAngle(ns,3*Math.PI/2-Math.atan2(us.z,us.x))}findDraggableObjectAndDraggingMode(t){let e,i,s=t;for(;s&&!e;)e=s.draggable?s:void 0,i=i??s.draggingMode,s=s.parent;return[e,i]}}class ms extends Xi{static{this.dependencies={renderer:t.WebGLRenderer}}constructor(t={}){super({text:"close",...t}),this.fontSize=.8,this.defaultOpacity=.2,this.hoverOpacity=.8,this.backgroundColor=16777215}async init({renderer:t}){await super.init(),this.renderer=t}onTriggered(){console.log("ExitButton triggered: Shutting down XR session.");const t=this.renderer.xr.getSession();t&&t.end()}}class fs extends ji{constructor(){super(...arguments),this.rowWeight=0,this.colWeight=0,this.leftWeight=0,this.topWeight=0,this.cols=0,this.rows=0}static init(t,e,i,s){fs.RowClass=t,fs.ColClass=e,fs.PanelClass=i,fs.OrbiterClass=s}addImage(t){const e=new $i(t);return this.add(e),e}addVideo(t){const e=new Zi(t);return this.add(e),e}addIconButton(t={}){const e=new Xi(t);return this.add(e),e}addTextButton(t={}){const e=new Ji(t);return this.add(e),e}addIcon(t={}){const e=new Ki(t);return this.add(e),e}addText(t={}){const e=new qi(t);return this.add(e),e}addLabel(t){const e=new Qi(t);return this.add(e),e}addOrbiter(t={}){const e=new fs.OrbiterClass(t);return this.add(e),e}addExitButton(t={}){const e=new ms(t);return this.add(e),e}addPanel(t={}){t.isRoot=!1;const e=new fs.PanelClass(t);return this.add(e),e}addRow(t={}){const e=new fs.RowClass(t);return e.topWeight=this.rowWeight,e.height=e.weight,this.rowWeight+=e.weight,this.add(e),this.rows++,e}addCol(t={}){const e=new fs.ColClass(t);return e.leftWeight=this.colWeight,e.width=e.weight,this.colWeight+=e.weight,this.add(e),this.cols++,e}updateLayout(){this.x=-.5+(this.leftWeight+this.width/2),this.y=.5-(this.topWeight+this.height/2),super.updateLayout()}resetLayout(){this.rows=0,this.cols=0,this.colWeight=0,this.rowWeight=0;for(const t of this.children)t instanceof fs.RowClass?(t.topWeight=this.rowWeight,t.height=t.weight,this.rowWeight+=t.weight,this.rows++):t instanceof fs.ColClass&&(t.leftWeight=this.colWeight,t.width=t.weight,this.colWeight+=t.weight,this.cols++)}}const vs={uniforms:{uMainTex:{value:null},uUseImage:{value:0},uBackgroundColor:{value:new t.Vector4(.4,.8,1,1)},uBoxSize:{value:new t.Vector2(.5,.5)},uRadius:{value:.05},uReticleUVs:{value:new t.Vector4(.5,.5,.5,.5)},uSelected:{value:new t.Vector2(0,0)},uBorderWidth:{value:.1},uHighlightRadius:{value:.2},uOutlineWidth:{value:.01},uOpacity:{value:1}},vertexShader:"\n    varying vec2 vTexCoord;\n\n    void main() {\n      vTexCoord = uv;\n      gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n    }\n  ",fragmentShader:"\n    precision mediump float;\n\n    uniform sampler2D uMainTex;\n    uniform vec4 uBackgroundColor;\n    uniform vec2 uBoxSize;\n    uniform float uRadius;\n    uniform float uUseImage;\n\n    uniform vec4 uReticleUVs;\n    uniform vec2 uSelected;\n    uniform float uBorderWidth;\n    uniform float uHighlightRadius;\n    uniform float uOutlineWidth;\n    uniform float uOpacity;\n\n    varying vec2 vTexCoord;\n\n    // Distance function for rounded box.\n    float distRoundBox(vec2 p, vec2 b, highp float r) {\n      return length(max(abs(p) - b + r, 0.0)) - r;\n    }\n\n    vec4 highlight(in vec4 baseColor, in vec4 colorOutside,\n                   in float distOuterUV, in float aa, in vec2 mouse, in float selected) {\n\n      vec4 highlightColor = vec4(0.0);\n      float normDist = 1.0; // Initialize outside the highlight range\n      bool mousePressed = selected > 0.0;\n      bool mouseHovering = selected <= 0.0 && length(uReticleUVs.xy) > 0.0;\n      bool mouseNearBorder = (mouseHovering || mousePressed);\n      vec4 finalColor = baseColor;\n\n      if (mouseNearBorder) {\n        // Scale mouse and fragment coordinates by the inverse of uBoxSize\n\n        vec2 fragAspect = vTexCoord;\n        fragAspect.x *= uBoxSize.x / uBoxSize.y;\n        vec2 mouseAspect = mouse;\n        mouseAspect.x *= uBoxSize.x / uBoxSize.y;\n\n        // Calculate vector from mouse to fragment in aspect-corrected space\n        vec2 diffAspect = fragAspect - mouseAspect;\n\n        // Calculate the distance in the aspect-corrected space\n        float distToMouseAspect = length(diffAspect);\n\n        // Normalized distance from mouse within the highlight radius\n        normDist = distToMouseAspect / uHighlightRadius;\n\n        // Define highlight color\n        float innerWhite = mousePressed ? 0.9 : 0.8;\n\n        // Radial gradient calculation\n        float radialFactor = smoothstep(1.0, 0.0, normDist); // 1 at center, 0 at edge\n        highlightColor = vec4(vec3(innerWhite), 1.0) * vec4(vec3(1.0), radialFactor);\n\n        // Calculate distance to the inner edge of the border in UV space\n        float distInnerUV = distRoundBox(\n          (vTexCoord - 0.5) * uBoxSize,\n          (uBoxSize - uBorderWidth) * 0.5, 0.5 * uRadius);\n\n        float highlightEdgeSharpness = 200.0;\n        float innerHighlightAmount = clamp(highlightEdgeSharpness * -distOuterUV, 0.0, 1.0);\n        float outerHighlightAmount = clamp(highlightEdgeSharpness * distInnerUV, 0.0, 1.0);\n        float highlightAmount = min(innerHighlightAmount, outerHighlightAmount);\n        vec4 highlightColor = mix(finalColor, finalColor + highlightColor, highlightColor.a);\n        finalColor = mix(finalColor, highlightColor, highlightAmount);\n      }\n      return finalColor;\n    }\n\n    void main(void) {\n      vec2 size = uBoxSize * 1000.0;\n      float radius = min(size.x, size.y) * (0.05 + uRadius);\n      vec2 half_size = 0.5 * size;\n\n      // Distance to the outer edge of the round box in UV space (0-1)\n      float distOuterUV = distRoundBox(vTexCoord * uBoxSize - uBoxSize * 0.5, uBoxSize * 0.5, uRadius);\n\n      // Antialiasing delta\n      float aa = fwidth(distOuterUV) * 0.8;\n\n      // Base color: opaque inside, transparent outside\n      vec4 colorInside = uBackgroundColor;\n      if (uUseImage > 0.5) {\n          colorInside = texture2D(uMainTex, vTexCoord);\n          colorInside.a = 1.0;\n      }\n      vec4 colorOutside = vec4(0.0, 0.0, 0.0, 0.0);\n      vec4 baseColor = mix(colorInside, colorOutside, smoothstep(0.0, aa, distOuterUV));\n\n      vec4 finalColor1 = highlight(baseColor, colorOutside, distOuterUV, aa, uReticleUVs.xy, uSelected.x);\n      vec4 finalColor2 = highlight(baseColor, colorOutside, distOuterUV, aa, uReticleUVs.zw, uSelected.y);\n\n      gl_FragColor = uOpacity * max(finalColor1, finalColor2);\n    }\n  "};class ys extends t.Mesh{get uniforms(){return this.material.uniforms}constructor(e,i,s=1){const n=t.UniformsUtils.clone(e.uniforms),r=new t.ShaderMaterial({uniforms:n,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,transparent:!0,depthWrite:!1,side:t.DoubleSide});super(new t.PlaneGeometry(s,s),r),this.name="PanelMesh",i&&(n.uBackgroundColor.value=A(i))}setWidthHeight(t,e){this.uniforms.uBoxSize.value.set(t,e)}setAspectRatio(t){this.scale.set(Math.max(t,1),Math.max(1/t,1),1)}}const ws=888.832*.001,xs=624.96*.001;class Ss extends ji{static{this.dependencies={user:is,timer:t.Timer}}constructor(t={}){super(t),this.keepFacingCamera=!0,this.name="Panel",this.isPanel=!0,this.draggable=!1,this.touchable=!1,this.useDefaultPosition=!0,this.useBorderlessShader=!1,this.showHighlights=!1,this.backgroundColor="#c2c2c255",this._fadeState="idle",this._fadeDuration=.2,this._fadeTimer=0,this._currentOpacity=1,this._startOpacity=1,this._targetOpacity=1;const e=t.draggable??this.draggable,i=t.useBorderlessShader??!e,s=i?1:1.3,n=i?Yi:vs;t.useBorderlessShader=i,this.showHighlights=!i,this.backgroundColor=t.backgroundColor??this.backgroundColor,this.draggable=e,this.draggingMode=t.draggingMode??this.draggable?ps.TRANSLATING:ps.DO_NOT_DRAG,this.touchable=t.touchable??this.touchable,this.isRoot=t.isRoot??!0,this.width=t.width??(this.isRoot?ws:1),this.height=t.height??(this.isRoot?xs:1),this.showHighlights=t.showHighlights??this.showHighlights,this.useDefaultPosition=t.useDefaultPosition??this.useDefaultPosition,this.useBorderlessShader=t.useBorderlessShader??this.useBorderlessShader,this.mesh=new ys(n,this.backgroundColor,s),this.add(this.mesh),this.updateLayout()}init({user:t,timer:e}){super.init(),this.selectable=!0,this.timer=e,0===this.position.x&&0===this.position.y&&0===this.position.z||(this.useDefaultPosition=!1),this.isRoot&&this.useDefaultPosition?this.position.set(this.x,t.height+this.y,-t.panelDistance+this.z):this.position.set(this.position.x+this.x,this.position.y+this.y,this.position.z+this.z)}fadeIn(t,e){"fading-in"!==this._fadeState&&(this._startFade(1,t,e),this._fadeState="fading-in")}fadeOut(t,e){"fading-out"!==this._fadeState&&(this._startFade(0,t,e),this._fadeState="fading-out")}_startFade(t,e,i){this._fadeDuration=e??.2,this.onFadeComplete=i,this._fadeTimer=0,this._startOpacity=this._currentOpacity,this._targetOpacity=t,this._fadeDuration<=0?this._completeFade():this._prepareMaterialsForFade()}_prepareMaterialsForFade(){this.traverse((e=>{if(e instanceof t.Mesh&&e.material){(Array.isArray(e.material)?e.material:[e.material]).forEach((t=>{t.transparent=!0}))}}))}_applyOpacity(e){this.traverse((i=>{if(i instanceof ji&&(i.opacity=e),i instanceof t.Mesh&&i.material){(Array.isArray(i.material)?i.material:[i.material]).forEach((i=>{i instanceof t.ShaderMaterial?i.uniforms.uOpacity.value=e:i.opacity=e}))}}))}_completeFade(){this._currentOpacity=this._targetOpacity,this._applyOpacity(this._currentOpacity),this._fadeState="idle",0===this._currentOpacity?this.hide():this.show(),this.onFadeComplete?.()}update(){if("idle"!==this._fadeState){this._fadeTimer+=this.timer.getDelta();const e=Math.min(this._fadeTimer/this._fadeDuration,1);this._currentOpacity=t.MathUtils.lerp(this._startOpacity,this._targetOpacity,e),this._applyOpacity(this._currentOpacity),e>=1&&this._completeFade()}}addGrid(){const t=new fs;return this.add(t),t}updateLayout(){super.updateLayout(),this.mesh.setAspectRatio(this.aspectRatio);const t=this.isRoot||!this.parent?1:this.parent.aspectRatio;this.mesh.setWidthHeight(this.width*Math.max(t,1),this.height*Math.max(1/t,1))}getWidth(){return this.width}getHeight(){return this.height}}class bs extends fs{constructor(t={}){void 0===t.weight&&(t.weight=.5),super(t)}}class Cs extends fs{init(){super.init(),this.position.set(-.45*this.rangeX,.7*this.rangeY,this.position.z),this.scale.set(.2,.2,1)}}class Ts extends fs{constructor(t={}){void 0===t.weight&&(t.weight=.5),super(t)}}class Rs extends Ss{constructor(t={}){t.draggable=t.draggable??!0,t.dragFacingCamera=t.dragFacingCamera??!0,super(t),this.dragFacingCamera=!0,this.draggable=t.draggable??this.draggable,this.dragFacingCamera=t.dragFacingCamera??this.dragFacingCamera,this.mesh.material.visible=!1!==t.showEdge}update(){super.update(),this._updateInteractionFeedback()}_updateInteractionFeedback(){if(this.useBorderlessShader||!this.showHighlights)return;const[t,e]=this.ux.getPrimaryTwoControllerIds(),i=null!==t&&this.ux.selected[t],s=null!==e&&this.ux.selected[e];this.mesh.material.uniforms.uSelected.value.set(i?1:0,s?1:0);const n=null!==t?this.ux.uvs[t].x:-1,r=null!==t?this.ux.uvs[t].y:-1,o=null!==e?this.ux.uvs[e].x:-1,a=null!==e?this.ux.uvs[e].y:-1;this.mesh.material.uniforms.uReticleUVs.value.set(n,r,o,a)}}fs.init(Ts,bs,Ss,Cs);class Ms extends S{constructor(){super(...arguments),this.views=[]}static{this.ComponentRegistry=new Map}static registerComponent(t,e){Ms.ComponentRegistry.has(t)&&console.warn(`UI: Component type "${t}" is being overwritten.`),Ms.ComponentRegistry.set(t,e)}compose(t){const e=this._composeNode(t);return e&&(this.add(e),e.traverse((t=>{t instanceof ji&&this.views.push(t)}))),e}_composeNode(t){const{type:e,options:i={},position:s={x:0,y:0,z:0},rotation:n={x:0,y:0,z:0},children:r=[]}=t,o=Ms.ComponentRegistry.get(e);if(!o)return console.error(`UI Error: Unknown component type "${e}". Make sure it's registered.`),null;const a=new o(i);return a.position.set(s.x,s.y,s.z),a.rotation.set(n.x,n.y,n.z),r.forEach((t=>{const e=this._composeNode(t);e&&a.add(e)})),a instanceof fs&&a.resetLayouts(),a}}Ms.registerComponent("Panel",Ss),Ms.registerComponent("Grid",fs),Ms.registerComponent("Row",Ts),Ms.registerComponent("Col",bs),Ms.registerComponent("Orbiter",Cs),Ms.registerComponent("Text",qi),Ms.registerComponent("TextView",qi),Ms.registerComponent("Label",Qi),Ms.registerComponent("LabelView",Qi),Ms.registerComponent("VideoView",Zi),Ms.registerComponent("TextButton",Ji),Ms.registerComponent("IconButton",Xi),Ms.registerComponent("IconView",Ki),Ms.registerComponent("Image",$i),Ms.registerComponent("ImageView",$i),Ms.registerComponent("SpatialPanel",Rs);class Ds extends HTMLElement{static{this.style="\n    /* Styles for the wrapper that covers the screen */\n    .wrapper {\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background-color: rgba(0, 0, 0, 0.1);\n      display: flex;\n      justify-content: center;\n      align-items: center;\n      z-index: 9999;\n      transition: visibility 0s, opacity 0.2s linear;\n    }\n\n    /* The spinning circle */\n    .spinner {\n      border: 8px solid rgba(255, 255, 255, 0.3);\n      border-left-color: #ffffff;\n      border-radius: 50%;\n      width: 60px;\n      height: 60px;\n      animation: spin 1s linear infinite;\n    }\n\n    /* The animation is safely scoped inside the shadow DOM */\n    @keyframes spin {\n      to {\n        transform: rotate(360deg);\n      }\n    }"}static{this.innerHTML=`\n    <style>\n      ${Ds.style}\n    </style>\n    <div class="wrapper">\n      <div class="spinner"></div>\n    </div>\n  `}connectedCallback(){this.attachShadow({mode:"open"}).innerHTML=Ds.innerHTML}}customElements.define("xb-blocks-loading-spinner",Ds);class Es{constructor(){this.isLoading=!1,this.setupCallbacks()}showSpinner(){this.spinnerElement||(this.spinnerElement=document.body.appendChild(document.createElement("xb-blocks-loading-spinner")))}hideSpinner(){this.spinnerElement&&(this.spinnerElement.remove(),this.spinnerElement=void 0)}setupCallbacks(){t.DefaultLoadingManager.onStart=(t,e,i)=>{this.isLoading=!0,window.parent.postMessage({type:"XR_LOADING_PROGRESS",payload:{progress:e/i,message:"Loading assets..."}},"*")},t.DefaultLoadingManager.onProgress=(t,e,i)=>{window.parent.postMessage({type:"XR_LOADING_PROGRESS",payload:{progress:e/i,message:`Loading ${Math.round(e/i*100)}%`}},"*")},t.DefaultLoadingManager.onLoad=()=>{this.isLoading=!1,this.hideSpinner(),window.parent.postMessage({type:"XR_LOADING_COMPLETE"},"*")},t.DefaultLoadingManager.onError=t=>{this.isLoading=!1,console.warn("XRBlocks: Error loading: "+t),this.hideSpinner(),window.parent.postMessage({type:"XR_LOADING_ERROR",payload:{url:t,message:"Failed to load assets."}},"*")}}}const _s=new Es,Ps=new t.Vector3,Os=new t.Vector3,As=new t.Vector3,Is=new t.Matrix4;function Ls(t,e,i){t.position.copy(e.point),e.object.updateWorldMatrix(!0,!1);const s=As.copy(e.normal).transformDirection(e.object.matrixWorld),n=i.getWorldPosition(Ps).sub(t.position).cross(s).cross(s).multiplyScalar(-1).normalize(),r=Os.crossVectors(s,n);return Is.makeBasis(r,s,n),t.quaternion.setFromRotationMatrix(Is),t}class Vs extends t.Object3D{constructor(t,e,i,s={}){super(),this.label=t,this.image=e,this.detection2DBoundingBox=i,Object.assign(this,s)}}class Bs extends S{constructor(){super(...arguments),this._detectedObjects=new Map}static{this.dependencies={options:Te,ai:$,aiOptions:F,deviceCamera:kt,depth:At,camera:t.Camera}}init({options:e,ai:i,aiOptions:s,deviceCamera:n,depth:r,camera:o}){this.options=e,this.ai=i,this.aiOptions=s,this.deviceCamera=n,this.depth=r,this.camera=o,this._geminiConfig=this._buildGeminiConfig(),this.options.objects.showDebugVisualizations&&(this._debugVisualsGroup=new t.Group,this._debugVisualsGroup.raycast=()=>{},this.add(this._debugVisualsGroup))}async runDetection(){return this.clear(),"gemini"===this.options.objects.backendConfig.activeBackend?this._runGeminiDetection():(console.warn(`ObjectDetector backend '${this.options.objects.backendConfig.activeBackend}' is not supported.`),[])}async _runGeminiDetection(){if(!this.ai.isAvailable())return console.error("Gemini is unavailable for object detection."),[];const e=this.deviceCamera.getSnapshot({outputFormat:"base64"});if(!e)return console.warn("Could not get device camera snapshot."),[];const{mimeType:i,strippedBase64:s}=L(e),n=this.depth.depthArray[0].slice(0),r=this.camera.matrixWorld.clone(),o=this.aiOptions.gemini.config;this.aiOptions.gemini.config=this._geminiConfig;try{const o=await this.ai.model.query({type:"multiPart",parts:[{inlineData:{mimeType:i||void 0,data:s}},{text:"What do you see in this image?"}]});let a;try{if(!o||!o.text)return console.error("AI response is missing text field:",o,"Raw response was:",o),[];a=JSON.parse(o.text)}catch(t){return console.error("Failed to parse AI response JSON:",t,"Raw response was:",o),[]}if(!Array.isArray(a))return console.error("Parsed AI response is not an array:",a),[];this.options.objects.showDebugVisualizations&&this._visualizeBoundingBoxesOnImage(e,a);const h=a.map((async i=>{const{ymin:s,xmin:o,ymax:a,xmax:h,objectName:l,...c}=i||{};if([s,o,a,h].some((t=>"number"!=typeof t)))return null;const d=new t.Box2(new t.Vector2(o/1e3,s/1e3),new t.Vector2(h/1e3,a/1e3)),u=new t.Vector2;d.getCenter(u);const p={u:u.x,v:u.y},g=this.deviceCamera.simulatorCamera?this.camera.projectionMatrix:(new t.Matrix4).fromArray(this.depth.view[0].projectionMatrix),m=Bt(p,n,g,r,this.deviceCamera,this.depth);if(m){const t=this.options.objects.objectImageMargin,i=d.clone();i.min.subScalar(t),i.max.addScalar(t);const s=await Ft(e,i),n=new Vs(l,s,d,c);return n.position.copy(m),this.add(n),this._detectedObjects.set(n.uuid,n),this._debugVisualsGroup&&this._createDebugVisual(n),n}}));return(await Promise.all(h)).filter(Boolean)}catch(t){return console.error("AI query for object detection failed:",t),[]}finally{this.aiOptions.gemini.config=o}}get(t=null){const e=Array.from(this._detectedObjects.values());return t?e.filter((e=>e.label===t)):e}clear(){for(const t of this._detectedObjects.values())this.remove(t);return this._detectedObjects.clear(),this._debugVisualsGroup&&this._debugVisualsGroup.clear(),this}showDebugVisualizations(t=!0){this._debugVisualsGroup&&(this._debugVisualsGroup.visible=t)}_visualizeBoundingBoxesOnImage(t,e){const i=new Image;i.onload=()=>{const t=document.createElement("canvas");t.width=i.naturalWidth,t.height=i.naturalHeight;const s=t.getContext("2d");s.drawImage(i,0,0),e.forEach((e=>{const{ymin:i,xmin:n,ymax:r,xmax:o,objectName:a}=e||{};if([i,n,r,o].some((t=>"number"!=typeof t)))return;const h=n/1e3*t.width,l=i/1e3*t.height,c=(o-n)/1e3*t.width,d=(r-i)/1e3*t.height;s.strokeStyle="#FF0000",s.lineWidth=Math.max(2,t.width/400),s.strokeRect(h,l,c,d);const u=a||"unknown",p=Math.max(16,t.width/80);s.font=`bold ${p}px sans-serif`,s.textBaseline="bottom";const g=s.measureText(u);s.fillStyle="rgba(0, 0, 0, 0.6)",s.fillRect(h,l-p,g.width+8,p+4),s.fillStyle="#FFFFFF",s.fillText(u,h+4,l+2)}));const n=(new Date).toISOString().slice(0,19).replace("T","_").replace(/:/g,"-"),r=document.createElement("a");r.download=`detection_debug_${n}.png`,r.href=t.toDataURL("image/png"),r.click()},i.src=t}async _createDebugVisual(e){const i=new t.Mesh(new t.SphereGeometry(.03,16,16),new t.MeshBasicMaterial({color:4282549748}));i.position.copy(e.position);const{Text:s}=await import("troika-three-text"),n=new s;n.text=e.label,n.fontSize=.07,n.color=16777215,n.anchorX="center",n.anchorY="bottom",n.position.copy(i.position),n.position.y+=.04,this._debugVisualsGroup.add(i,n),n.sync()}_buildGeminiConfig(){const t=this.options.objects.backendConfig.gemini;return{thinkingConfig:{thinkingBudget:0},responseMimeType:"application/json",responseSchema:t.responseSchema,systemInstruction:[{text:t.systemInstruction}]}}}class Fs extends t.Mesh{constructor(e,i){const s=e.polygon,n=[];for(const e of s)n.push(new t.Vector2(e.x,e.z));const r=new t.Shape(n),o=new t.ShapeGeometry(r);o.rotateX(Math.PI/2),super(o,i),this.xrPlane=e,this.label=e.semanticLabel||"unknown",this.orientation=e.orientation}}class zs extends S{constructor(){super(...arguments),this._detectedPlanes=new Map}static{this.dependencies={options:Te,renderer:t.WebGLRenderer}}init({options:e,renderer:i}){this.renderer=i,e.planes.showDebugVisualizations&&(this._debugMaterial=new t.MeshBasicMaterial({color:16776960,wireframe:!0,side:t.DoubleSide}))}update(t,e){if(!e||!e.detectedPlanes)return;if(this._xrRefSpace=this._xrRefSpace||this.renderer.xr.getReferenceSpace()||void 0,!this._xrRefSpace)return;const i=e.detectedPlanes,s=new Set(this._detectedPlanes.keys());for(const t of i){s.delete(t);const i=this._detectedPlanes.get(t);i?t.lastChangedTime>(i.xrPlane.lastChangedTime||0)&&this._updatePlaneMesh(e,i,t):this._addPlaneMesh(e,t)}for(const t of s)this._removePlaneMesh(t)}_addPlaneMesh(e,i){const s=this._debugMaterial||new t.MeshBasicMaterial({visible:!1}),n=new Fs(i,s);this._updatePlanePose(e,n,i),this._detectedPlanes.set(i,n),this.add(n)}_updatePlaneMesh(e,i,s){const n=s.polygon.map((e=>new t.Vector2(e.x,e.z))),r=new t.Shape(n),o=new t.ShapeGeometry(r);i.geometry.dispose(),i.geometry=o,i.xrPlane=s,this._updatePlanePose(e,i,s)}_removePlaneMesh(t){const e=this._detectedPlanes.get(t);e&&(e.geometry.dispose(),this.remove(e),this._detectedPlanes.delete(t))}_updatePlanePose(t,e,i){const s=t.getPose(i.planeSpace,this._xrRefSpace);s&&(e.position.copy(s.transform.position),e.quaternion.copy(s.transform.orientation))}get(t){const e=Array.from(this._detectedPlanes.values());return t?e.filter((e=>e.label===t)):e}showDebugVisualizations(t=!0){this._debugMaterial&&(this.visible=t)}}class js extends S{constructor(){super(...arguments),this.raycaster=new t.Raycaster}static{this.dependencies={options:Te,camera:t.Camera}}async init({options:t,camera:e}){this.options=t,this.camera=e,this.options&&this.options.enabled&&(this.options.planes.enabled&&(this.planes=new zs,this.add(this.planes)),this.options.objects.enabled&&(this.objects=new Bs,this.add(this.objects)))}anchorObjectAtReticle(t,e){throw new Error("Method not implemented")}update(t,e){this.options}placeOnSurface(t,e){if(!this.planes)return console.warn("Cannot placeOnSurface: PlaneDetector is not enabled."),!1;const i=this.planes.get();if(0===i.length)return!1;this.raycaster.setFromXRController(e);const s=this.raycaster.intersectObjects(i);if(s.length>0){return Ls(t,s[0],this.camera),!0}return!1}showDebugVisualizations(t=!0){this.planes?.showDebugVisualizations(t),this.objects?.showDebugVisualizations(t)}}class ks extends C{static{this.dependencies={renderer:t.WebGLRenderer,camera:t.Camera,timer:t.Timer,scene:t.Scene,options:Ee}}constructor(){super(new t.SphereGeometry(1,64,32),new t.MeshBasicMaterial({color:16777215,transparent:!0,opacity:0,depthTest:!1,side:t.BackSide})),this.ignoreReticleRaycast=!0,this.currentMode="AR",this.transitionTime=1.5,this.targetAlpha=0,this.defaultBackgroundColor=new t.Color(16777215),this.ignoreReticleRaycast=!0,this.renderOrder=-1/0}init({renderer:t,camera:e,timer:i,scene:s,options:n}){this.renderer=t,this.sceneCamera=e,this.timer=i,this.scene=s,this.transitionTime=n.transition.transitionTime,this.defaultBackgroundColor.set(n.transition.defaultBackgroundColor),this.material.color.copy(this.defaultBackgroundColor),this.scene.add(this)}toVR({targetAlpha:e=1,color:i}={}){this.targetAlpha=t.MathUtils.clamp(e,0,1),this.material.color.set(i??this.defaultBackgroundColor),this.currentMode="VR"}toAR(){this.targetAlpha=0,this.currentMode="AR"}update(){this.renderer.xr.isPresenting?this.renderer.xr.getCamera().getWorldPosition(this.position):this.sceneCamera.getWorldPosition(this.position);const e=this.material.opacity;if(e!==this.targetAlpha){const i=this.timer.getDelta()/this.transitionTime;this.material.opacity=t.MathUtils.lerp(e,this.targetAlpha,i),Math.abs(this.material.opacity-this.targetAlpha)<.01&&(this.material.opacity=this.targetAlpha)}}dispose(){this.parent&&this.parent.remove(this),this.material.dispose(),this.geometry.dispose()}}class Us{constructor(){if(this.screenshotSynthesizer=new Ht,this.waitFrame=new qt,this.registry=new Ut,this.timer=new t.Timer,this.input=new ce,this.scene=new t.Scene,this.user=new is,this.ui=new Ms,this.sound=new Bi,this.simulator=new Si(this.renderScene.bind(this)),this.dragManager=new gs,this.world=new js,this.textureLoader=new t.TextureLoader,this.webXRSettings={},this.simulatorRunning=!1,this.depth=new At,this.ai=new $,this.scriptsManager=new Wt((async t=>{await wi(t,this.registry,this),this.physics&&await t.initPhysics(this.physics)})),Us.instance)return Us.instance;Us.instance=this,this.scene.name="XR Blocks Scene",this.scene.add(this.user),this.scene.add(this.dragManager),this.scene.add(this.ui),this.scene.add(this.sound),this.scene.add(this.world),this.registry.register(this.registry),this.registry.register(this.waitFrame),this.registry.register(this.scene),this.registry.register(this.timer),this.registry.register(this.input),this.registry.register(this.user),this.registry.register(this.ui),this.registry.register(this.sound),this.registry.register(this.dragManager),this.registry.register(this.user),this.registry.register(this.simulator),this.registry.register(this.scriptsManager),this.registry.register(this.depth)}async init(e=new Ee){if(_s.showSpinner(),this.registry.register(e,Ee),this.registry.register(e.depth,xt),this.registry.register(e.simulator,ye),this.registry.register(e.world,Te),this.registry.register(e.ai,F),this.registry.register(e.sound,Se),e.transition.enabled&&(this.transition=new ks,this.user.add(this.transition),this.registry.register(this.transition)),this.camera=new t.PerspectiveCamera(90,window.innerWidth/window.innerHeight,e.camera.near,e.camera.far),this.registry.register(this.camera,t.Camera),this.registry.register(this.camera,t.PerspectiveCamera),this.renderer=new t.WebGLRenderer({canvas:e.canvas,antialias:e.antialias,stencil:e.stencil,alpha:!0,logarithmicDepthBuffer:e.logarithmicDepthBuffer}),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.xr.enabled=!0,this.registry.register(this.renderer),this.renderer.xr.setReferenceSpaceType(e.referenceSpaceType),!e.canvas){const t=document.createElement("div");document.body.appendChild(t),t.appendChild(this.renderer.domElement)}this.options=e,e.controllers.enabled&&(this.input.init({scene:this.scene,options:e,renderer:this.renderer}),this.input.bindSelectStart(this.scriptsManager.callSelectStartBound),this.input.bindSelectEnd(this.scriptsManager.callSelectEndBound),this.input.bindSelect(this.scriptsManager.callSelectBound),this.input.bindSqueezeStart(this.scriptsManager.callSqueezeStartBound),this.input.bindSqueezeEnd(this.scriptsManager.callSqueezeEndBound),this.input.bindSqueeze(this.scriptsManager.callSqueezeBound),this.input.bindKeyDown(this.scriptsManager.callKeyDownBound),this.input.bindKeyUp(this.scriptsManager.callKeyUpBound)),e.deviceCamera?.enabled&&(this.deviceCamera=new kt(e.deviceCamera),await this.deviceCamera.init(),this.registry.register(this.deviceCamera));const i=e.webxrRequiredFeatures;this.webXRSettings.requiredFeatures=i,e.depth.enabled&&(i.push("depth-sensing"),i.push("local-floor"),this.webXRSettings.depthSensing={usagePreference:["cpu-optimized"],dataFormatPreference:[this.options.depth.useFloat32?"float32":"luminance-alpha"]},this.depth.init(this.camera,e.depth,this.renderer,this.registry,this.scene)),e.hands.enabled&&(i.push("hand-tracking"),this.user.hands=new ee(this.input.hands)),e.world.planes.enabled&&i.push("plane-detection"),e.lighting.enabled&&(i.push("light-estimation"),this.lighting=new de,this.lighting.init(e.lighting,this.renderer,this.scene,this.depth)),e.physics&&e.physics.RAPIER&&(this.physics=new ue,this.registry.register(this.physics),await this.physics.init({physicsOptions:e.physics}),e.depth.enabled&&this.depth.depthMesh?.initRapierPhysics(this.physics.RAPIER,this.physics.blendedWorld)),this.webXRSessionManager=new Kt(this.renderer,this.webXRSettings,"immersive-ar"),this.webXRSessionManager.addEventListener(Xt.SESSION_START,(t=>this.onXRSessionStarted(t.session))),this.webXRSessionManager.addEventListener(Xt.SESSION_END,this.onXRSessionEnded.bind(this));const s=this.options.xrButton.autostartSimulator||this.options.xrButton.autostartSimulatorOnDesktop&&this.options.xrButton.enableSimulator&&ft();!s&&e.xrButton.enabled&&(this.xrButton=new Qt(this.webXRSessionManager,e.xrButton?.startText,e.xrButton?.endText,e.xrButton?.invalidText,e.xrButton?.startSimulatorText,e.xrButton?.enableSimulator,e.xrButton?.showSimulatorButtonOnMobile,this.startSimulator.bind(this)),document.body.appendChild(this.xrButton.domElement)),await this.webXRSessionManager.initialize(),e.usePostprocessing&&(this.effects=new Jt(this.renderer,this.scene,this.timer),this.simulator.effects=this.effects),e.ai.enabled&&(this.registry.register(this.ai),this.scene.add(this.ai),await this.scriptsManager.initScript(this.ai)),await this.scriptsManager.syncScriptsWithScene(this.scene),window.addEventListener("resize",this.onWindowResize.bind(this)),this.renderer.setAnimationLoop(this.update.bind(this)),this.physics&&setInterval(this.physicsStep.bind(this),1e3*this.physics.timestep),this.options.reticles.enabled&&this.input.addReticles(),s&&this.startSimulator(),_s.isLoading||_s.hideSpinner()}update(t,e){this.currentFrame=e,this.timer.update(t),this.simulatorRunning&&this.simulator.simulatorUpdate(),this.depth.update(e),this.lighting&&this.lighting.update(),this.scriptsManager.syncScriptsWithScene(this.scene);for(const t of this.scriptsManager.scripts)t.ux.reset();this.input.update();for(const t of this.input.controllers)if(t.userData.selected)for(const e of this.scriptsManager.scripts)e.onSelecting({target:t});for(const t of this.input.controllers)if(t.userData.squeezing)for(const e of this.scriptsManager.scripts)e.onSqueezing({target:t});this.waitFrame.onFrame();for(const i of this.scriptsManager.scripts)i.update(t,e);this.renderSimulatorAndScene(),this.screenshotSynthesizer.onAfterRender(this.renderer,this.deviceCamera),this.simulatorRunning&&this.simulator.renderSimulatorScene()}physicsStep(){this.physics.physicsStep();for(const t of this.scriptsManager.scripts)t.physicsStep()}onXRSessionStarted(t){this.scriptsManager.onXRSessionStarted(t)}async startSimulator(){this.xrButton?.domElement.remove(),this.scene.add(this.simulator),await this.scriptsManager.initScript(this.simulator),this.onSimulatorStarted()}onXRSessionEnded(){this.startSimulator(),this.scriptsManager.onXRSessionEnded()}onSimulatorStarted(){this.simulatorRunning=!0,this.scriptsManager.onSimulatorStarted(),this.lighting&&(this.lighting.simulatorRunning=!0)}onWindowResize(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight)}renderSimulatorAndScene(){this.simulatorRunning?this.simulator.renderScene():this.renderScene()}renderScene(t){if(this.renderSceneOverride)this.renderSceneOverride(this.renderer,this.scene,t??this.camera);else if(this.effects)this.effects.render();else if(this.renderer.render(this.scene,t??this.camera),es(this.scene,(t=>t.layers.isEnabled(4)))){const t=this.camera.layers.mask;this.camera.layers.set(4),this.renderer.render(this.scene,this.camera),this.camera.layers.mask=t}}}class Ns{static createOcclusionMapOverrideMaterial(){return new t.MeshBasicMaterial}static addOcclusionToShader(e){e.uniforms.occlusionEnabled={value:!0},e.uniforms.tOcclusionMap={value:null},e.uniforms.uOcclusionClipFromWorld={value:new t.Matrix4},e.defines={USE_UV:!0,DISTANCE:!0},e.vertexShader=e.vertexShader.replace("#include <common>",["uniform mat4 uOcclusionClipFromWorld;","varying vec4 vOcclusionScreenCoord;","#include <common>"].join("\n")).replace("#include <fog_vertex>",["#include <fog_vertex>","vOcclusionScreenCoord = uOcclusionClipFromWorld * worldPosition;"].join("\n")),e.fragmentShader=e.fragmentShader.replace("uniform vec3 diffuse;",["uniform vec3 diffuse;","uniform bool occlusionEnabled;","uniform sampler2D tOcclusionMap;","varying vec4 vOcclusionScreenCoord;"].join("\n")).replace("vec4 diffuseColor = vec4( diffuse, opacity );",["vec4 diffuseColor = vec4( diffuse, opacity );","vec2 occlusion_coordinates = 0.5 + 0.5 * vOcclusionScreenCoord.xy / vOcclusionScreenCoord.w;","vec2 occlusion_sample = texture2D(tOcclusionMap, occlusion_coordinates.xy).rg;","occlusion_sample = occlusion_sample / max(0.0001, occlusion_sample.g);","float occlusion_value = clamp(occlusion_sample.r, 0.0, 1.0);","diffuseColor.a *= occlusionEnabled ? occlusion_value : 1.0;"].join("\n"))}}const Gs=new t.Euler,Hs=new t.Matrix4,Ws=new t.Vector3;function qs(e,i=new t.Quaternion){return Gs.setFromQuaternion(e,"YXZ"),i.setFromAxisAngle(ns,Gs.y)}function Xs(e,i=ns,s=new t.Quaternion){return Hs.lookAt(ls,e,i),s.setFromRotationMatrix(Hs)}function Ks(t,e){let i=2*Math.acos(t.w);if(i=(i+Math.PI)%(2*Math.PI)-Math.PI,Math.abs(i)<=e)return;const s=Ws.set(t.x,t.y,t.z).multiplyScalar(1/Math.sqrt(1-t.w*t.w));s.normalize(),t.setFromAxisAngle(s,e*Math.sign(i))}class $s{static{this.dependencies={}}async init(t={}){}async play(t={}){}}const Qs=3*Math.PI/180,Ys=new t.Vector3,Js=new t.Vector3,Zs=new t.Vector3,tn=new t.Quaternion,en=new t.Quaternion,sn=new t.Quaternion;class nn extends $s{static{this.dependencies={simulator:Si,camera:t.Camera,timer:t.Timer,input:ce}}constructor(t){super(),this.target=t}async init({simulator:t,camera:e,timer:i,input:s}){this.simulator=t,this.camera=e,this.timer=i,this.input=s}controllerIsPointingAtButton(t,e){const i=t.simulatorControllerState,s=i.currentControllerIndex,n=i.localControllerPositions[s],r=i.localControllerOrientations[s];this.target.getWorldPosition(Js),Zs.copy(Js).applyMatrix4(e.matrixWorldInverse),tn.copy(r).invert(),Ys.copy(Zs).sub(n),Xs(Ys,ns,en);return(en.angleTo(r)+Math.PI)%(2*Math.PI)-Math.PI<Qs}rotateControllerTowardsButton(t,e,i){const s=t.simulatorControllerState,n=s.currentControllerIndex,r=s.localControllerPositions[n],o=s.localControllerOrientations[n];this.target.getWorldPosition(Js),Zs.copy(Js).applyMatrix4(e.matrixWorldInverse),tn.copy(o).invert(),Ys.copy(Zs).sub(r),Xs(Ys,ns,en),sn.copy(en).multiply(tn),Ks(sn,1*i),o.premultiply(sn)}pinchController(){const t=this.simulator,e=t.controls.simulatorControllerState,i=!0;this.input.dispatchEvent({type:"selectstart",target:this.input.controllers[e.currentControllerIndex]}),0==e.currentControllerIndex?t.hands.setLeftHandPinching(i):t.hands.setRightHandPinching(i)}async play({simulatorUser:t,journeyId:e,waitFrame:i}){let s=!1;for(;t.isOnJourneyId(e)&&!s;){const t=this.timer.getDelta();this.controllerIsPointingAtButton(this.simulator.controls,this.camera)?(this.pinchController(),s=!0):this.rotateControllerTowardsButton(this.simulator.controls,this.camera,t),await i.waitFrame()}}}class rn extends $s{static{this.dependencies={simulator:Si}}async init({simulator:t}){this.simulator=t}async play(){this.simulator.hands&&this.simulator.hands.showHands()}}const on=3*Math.PI/180,an=new t.Vector3,hn=new t.Vector3,ln=new t.Vector3,cn=new t.Quaternion,dn=new t.Quaternion,un=new t.Quaternion;class pn extends $s{static{this.dependencies={camera:t.Camera,timer:t.Timer}}constructor(t){super(),this.target=t}async init({camera:t,timer:e}){this.camera=t,this.timer=e}isLookingAtTarget(){const t=this.camera;this.target.getWorldPosition(an),hn.copy(an).sub(t.position),Xs(hn,ns,dn);return(dn.angleTo(t.quaternion)+Math.PI)%(2*Math.PI)-Math.PI<on}isNearTarget(){const t=this.camera;return this.target.getWorldPosition(an),hn.copy(an).sub(t.position),Math.abs(hn.length()-.5)<.1}lookAtTarget(){const t=this.camera;un.copy(t.quaternion).invert(),this.target.getWorldPosition(an),hn.copy(an).sub(t.position),Xs(hn,ns,dn),t.quaternion.copy(dn)}lookTowardsTarget(){const t=this.camera;un.copy(t.quaternion).invert();const e=this.timer.getDelta();this.target.getWorldPosition(an),hn.copy(an).sub(t.position),Xs(hn,ns,dn),cn.copy(dn).multiply(un),Ks(cn,1*e),t.quaternion.premultiply(cn)}moveTowardsTarget(){const t=this.camera,e=this.timer.getDelta();this.target.getWorldPosition(an),hn.copy(an).sub(t.position),ln.copy(an).addScaledVector(hn,-.1);const i=ln.sub(t.position),s=T(i.length(),0,1*e);t.position.addScaledVector(i,s/i.length())}async play({simulatorUser:t,journeyId:e,waitFrame:i}){let s=this.isLookingAtTarget(),n=this.isNearTarget(),r=t.isOnJourneyId(e);for(;r&&(!s||!n);)s?(this.lookAtTarget(),this.moveTowardsTarget()):this.lookTowardsTarget(),await i.waitFrame(),s=this.isLookingAtTarget(),n=this.isNearTarget(),r=t.isOnJourneyId(e)}}const gn=new Us,mn=gn.scene,fn=gn.user,vn=gn.world,yn=gn.ai;function wn(...t){return mn.add(...t)}function xn(t=new Ee){return gn.init(t)}function Sn(t){return gn.scriptsManager.initScript(t)}function bn(t){return gn.scriptsManager.uninitScript(t)}function Cn(){return gn.timer.getDelta()}function Tn(t){gn.depth.depthMesh&&(gn.depth.depthMesh.ignoreReticleRaycast=!t)}function Rn(){return gn.renderer.xr.getCamera().cameras[0]}function Mn(){return gn.renderer.xr.getCamera().cameras[1]}function Dn(t){return t.layers.set(1),t.children.forEach((t=>{Dn(t)})),t}function En(t){return t.layers.set(2),t.children.forEach((t=>{En(t)})),t}async function _n(e){const i=await new Promise(((i,s)=>{(new t.ImageLoader).load(e,i,void 0,s)})),s=new t.Texture;s.image=i,s.repeat.x=.5,s.needsUpdate=!0;const n=s.clone();return n.offset.x=.5,n.needsUpdate=!0,[s,n]}class Pn extends ji{#t;get icon(){return this.#t}set icon(t){this.#t!=t&&(this.#t=t,this.updateIcon())}#e;get iconWeight(){return this.#e}set iconWeight(t){this.#e!=t&&(this.#e=t,this.updateIcon())}#i;get iconStyle(){return this.#i}set iconStyle(t){this.#i!=t&&(this.#i=t,this.updateIcon())}#s;get iconColor(){return this.#s}set iconColor(e){this.#s!=e&&(this.#s=e,this.group?.traverse?.((i=>{i instanceof t.Mesh&&i.material?.color?.set?.(e)})))}constructor({icon:t="sunny",iconWeight:e=400,iconStyle:i="outlined",iconScale:s=1,iconColor:n="#FFFFFF"}){super({}),this.#t="",this.#e=400,this.#i="",this.#s="",this.iconScale=1,this.icon=t,this.iconWeight=e,this.iconStyle=i,this.iconScale=s,this.iconColor=n}async init(){null==this.group&&await this.updateIcon()}async updateIcon(){if(!this.icon||!this.iconWeight||!this.iconStyle)return;const e="https://cdn.jsdelivr.net/gh/marella/material-symbols@v0.33.0/svg/{{weight}}/{{style}}/{{icon}}.svg".replace("{{style}}",this.iconStyle).replace("{{icon}}",this.icon).replace("{{weight}}",String(this.iconWeight));if(e==this.loadedSvgPath||e==this.loadingSvgPath)return;this.loadingSvgPath=e;const i=await new Promise(((t,i)=>{(new a).load(e,t,void 0,i)}));this.loadingSvgPath=void 0,this.loadedSvgPath=e;const[s,n,r,o]=i.xml.attributes.viewBox.value.split(" "),h=i.paths,l=new t.Group,c=1/Math.max(r,o),d=new t.MeshBasicMaterial({color:this.iconColor,transparent:!0,side:t.DoubleSide,depthWrite:!1});for(let e=0;e<h.length;e++){const i=h[e],r=a.createShapes(i);for(let e=0;e<r.length;e++){const i=r[e],o=new t.ShapeGeometry(i),a=new t.Mesh(o,d);a.scale.set(c,-c,c),a.position.x=-.5-s*c,a.position.y=.5+n*c,l.add(a)}}this.group&&(this.remove(this.group),this.group?.traverse?.((e=>{"dispose"in e&&"function"==typeof e.dispose&&e.dispose?.(),e instanceof t.Mesh&&(e.geometry?.dispose?.(),e.material?.dispose?.())}))),this.group=l,l.scale.setScalar(this.iconScale),this.add(l)}}class On extends S{constructor(){super(...arguments),this.scrollSpeedLinesPerSecond=3,this.lines=1,this.currentLine=0,this.targetLine=0,this.shouldUpdate=!0,this.lineCount=0}static{this.dependencies={timer:t.Timer}}init({timer:t}){this.timer=t}update(){if(super.update(),!this.shouldUpdate)return!1;const t=this.timer.getDelta(),e=this.scrollSpeedLinesPerSecond*t,i=this.targetLine-this.currentLine;this.currentLine+=T(i,-e,e)}}const An=new t.Vector3;class In extends ji{constructor(t={}){super(t)}updateLayout(){An.copy(this.position),super.updateLayout(),this.position.copy(An)}}class Ln extends S{static{this.dependencies={timer:t.Timer}}constructor({pages:t=1}){super(),this.currentPage=0,this.shouldUpdate=!0,this.pages=1,this.pages=t}init({timer:t}){this.timer=t}update(){if(super.update(),!this.shouldUpdate)return!1;const t=Math.sin(Math.PI*(this.currentPage%1)),e=(this.currentPage%1>=.5?1:-1)*Number(Math.abs(t)>.01),i=T(this.currentPage+e,0,this.pages-1),s=Math.abs(i-this.currentPage);this.currentPage+=e*T(t*this.timer.getDelta(),0,s)}addPage(){return this.pages++}}const Vn=new t.Vector3,Bn=new t.Matrix4;class Fn extends ji{static{this.dependencies={renderer:t.WebGLRenderer,input:ce}}constructor(e={}){super(e),this.localClippingPlanes=[new t.Plane(new t.Vector3(1,0,0),.5),new t.Plane(new t.Vector3(-1,0,0),.5)],this.raycastMesh=new t.Mesh(new t.PlaneGeometry,new t.MeshBasicMaterial({visible:!1})),this.clippingPlanes=[],this.selecting=!1,this.selectStartPositionLocal=new t.Vector3,this.selectStartPage=0,this.raycastPlane=new t.Plane,this.selectingRay=new t.Ray,this.selectingRayTarget=new t.Vector3;const{state:i=new Ln({pages:1}),enableRaycastOnChildren:s=!0,continuousScrolling:n=!0}=e;this.state=i,this.enableRaycastOnChildren=s,this.continuousScrolling=n;for(let t=0;t<this.state.pages;t++)this.add(new In);for(let t=0;t<this.localClippingPlanes.length;t++)this.clippingPlanes.push(this.localClippingPlanes[t].clone())}init({renderer:t,input:e}){t.localClippingEnabled=!0,this.input=e}updatePageCount(){this.remove(this.raycastMesh);for(let t=this.children.length;t<this.state.pages;t++)this.add(new In);for(let t=this.state.pages;t<this.children.length;)this.children[t].dispose?.(),this.remove(this.children[t]);this.add(this.raycastMesh)}updatePagePositions(){const t=Math.floor(this.state.pages/2);for(let e=0;e<this.state.pages;e++){const i=this.continuousScrolling&&this.state.pages>1?(e-this.state.currentPage+t+this.state.pages)%this.state.pages-t:e-this.state.currentPage;this.children[e].position.x=i*this.rangeX}}resetClippingPlanesToLocalSpace(){for(let t=0;t<this.localClippingPlanes.length&&t<this.clippingPlanes.length;t++)this.clippingPlanes[t].copy(this.localClippingPlanes[t])}updateClippingPlanes(){this.resetClippingPlanesToLocalSpace(),this.updateWorldMatrix(!0,!1);for(const t of this.clippingPlanes)t.applyMatrix4(this.matrixWorld);this.traverse((e=>{e instanceof t.Mesh&&(e.material.clippingPlanes=this.clippingPlanes)}))}update(){this.updatePageCount(),this.updatePagePositions(),this.updateClippingPlanes()}updateLayout(){super.updateLayout(),this.raycastMesh.scale.set(this.rangeX,this.rangeY,1)}onObjectSelectStart(t){const e=t.target,i=this.input.intersectionsForController.get(e),s=i.findIndex((t=>t.object==this));if(-1==s)return!1;const n=i[s];return this.selecting=!0,this.selectingController=e,this.updateMatrixWorld(),this.selectStartPositionLocal.copy(n.point).applyMatrix4(Bn.copy(this.matrixWorld).invert()),this.raycastPlane.normal.set(0,0,1),this.raycastPlane.constant=0,this.raycastPlane.applyMatrix4(this.matrixWorld),this.selectStartPage=this.state.currentPage,!0}computeSelectingDelta(t,e){return(t.x-e.x)/this.rangeX}onSelecting(){if(this.selecting){this.selectingRay.origin.set(0,0,0),this.selectingRay.direction.set(0,0,-1),this.selectingController.updateMatrixWorld(),this.selectingRay.applyMatrix4(this.selectingController.matrixWorld),this.selectingRay.intersectPlane(this.raycastPlane,this.selectingRayTarget),this.updateMatrixWorld(),this.selectingRayTarget.applyMatrix4(Bn.copy(this.matrixWorld).invert());const t=this.computeSelectingDelta(this.selectingRayTarget,this.selectStartPositionLocal);this.state.currentPage=this.continuousScrolling&&this.state.pages>1?(this.selectStartPage-t+this.state.pages)%this.state.pages:T(this.selectStartPage-t,0,this.state.pages-1)}}onObjectSelectEnd(t){return t.target==this.selectingController&&(this.selecting=!1),!0}raycast(t,e){const i=[];if(this.raycastMesh.raycast(t,i),i.forEach((t=>{t.object=this,e.push(t)})),this.enableRaycastOnChildren){const i=[];for(const e of this.children)t.intersectObject(e,!0,i);this.updateMatrixWorld(),Bn.copy(this.matrixWorld).invert();for(const t of i){const i=Vn.copy(t.point).applyMatrix4(Bn);Math.abs(i.x)<.5&&e.push(t)}}return!1}}class zn extends Fn{constructor(){super(...arguments),this.localClippingPlanes=[new t.Plane(new t.Vector3(0,1,0),.5),new t.Plane(new t.Vector3(0,-1,0),.5)]}updateLayout(){super.updateLayout(),this.localClippingPlanes[0].constant=.5*this.rangeY,this.localClippingPlanes[1].constant=.5*this.rangeY}computeSelectingDelta(t,e){return(t.y-e.y)/this.rangeY}}class jn extends ji{constructor({text:t="ScrollingTroikaTextView",textAlign:e="left",scrollerState:i=new On,fontSize:s=.06}={}){super(),this.onTextSyncCompleteBound=this.onTextSyncComplete.bind(this),this.currentText="",this.scrollerState=i||new On,this.pager=new zn,this.textViewWrapper=new ji,this.pager.children[0].add(this.textViewWrapper),this.textView=new qi({text:t,textAlign:e,fontSize:s,anchorX:0,anchorY:0}),this.textView.x=-.5,this.textView.addEventListener("synccomplete",this.onTextSyncCompleteBound),this.textViewWrapper.add(this.textView),this.add(this.scrollerState),this.add(this.pager)}update(){this.textViewWrapper.y=this.textView.lineHeight*this.textView.aspectRatio*this.scrollerState.currentLine,this.textViewWrapper.updateLayout()}addText(t){this.setText(this.currentText+t)}setText(t){this.currentText=t,this.textView.setText(this.currentText)}onTextSyncComplete(){this.textView.lineCount>0&&(this.textView.y=this.textView.lineHeight*this.textView.aspectRatio-.5,this.textView.updateLayout(),this.scrollerState.lineCount=this.textView.lineCount,this.scrollerState.targetLine=this.textView.lineCount-1,this.clipToLineHeight())}clipToLineHeight(){const t=this.textView.lineHeight*this.textView.aspectRatio,e=Math.floor(1/t)*t;this.pager.localClippingPlanes[1].constant=e-.5}}const kn=new t.Vector3,Un=new t.Quaternion,Nn=new t.Euler;class Gn{constructor(e=0,i=0,s=1,n=1,r){this.startingValue=e,this.minValue=i,this.maxValue=s,this.scale=n,this.initialPosition=new t.Vector3,this.initialRotationInverse=new t.Quaternion,this.rotationScale=null!=r?r:-this.scale}setInitialPose(t,e){this.initialPosition.copy(t),this.initialRotationInverse.copy(e).invert()}setInitialPoseFromController(t){this.setInitialPose(t.position,t.quaternion)}getValue(t){return kn.copy(t).sub(this.initialPosition).applyQuaternion(this.initialRotationInverse),T(this.startingValue+this.scale*kn.x,this.minValue,this.maxValue)}getValueFromRotation(t){return Un.copy(t).multiply(this.initialRotationInverse),Nn.setFromQuaternion(Un,"YXZ"),T(this.startingValue+this.rotationScale*Nn.y,this.minValue,this.maxValue)}getValueFromController(t){return t instanceof ae?this.getValueFromRotation(t.quaternion):this.getValue(t.position)}updateValue(t){this.startingValue=t}}const Hn=`https://cdn.jsdelivr.net/npm/three@0.${t.REVISION}.0/examples/jsm/`;let Wn;class qn{constructor(e=t.DefaultLoadingManager){this.manager=e}async load({path:t,url:e="",renderer:i,onProgress:s}){s&&console.warn("ModelLoader: An onProgress callback was provided to load(), but a LoadingManager is in use. Progress will be reported via the LoadingManager's onProgress callback. The provided callback will be ignored.");const n=e.split(".").pop()?.toLowerCase()||"";return["gltf","glb"].includes(n)?await this.loadGLTF({path:t,url:e,renderer:i}):["ply","spz","splat","ksplat"].includes(n)?await this.loadSplat({url:e}):(console.error("Unsupported file type: "+n),null)}async loadSplat({url:t=""}){const{SplatMesh:e}=await import("@sparkjsdev/spark"),i=new e({url:t});return await i.initialized,i}async loadGLTF({path:t,url:e="",renderer:i}){const s=function(t,e){if(Wn)return Wn;const i=new h(e);i.setDecoderPath(Hn+"libs/draco/"),i.setDecoderConfig({type:"js"});const s=new l(e);return s.setTranscoderPath(Hn+"libs/basis/"),t&&s.detectSupport(t),Wn=new o(e),Wn.setDRACOLoader(i),Wn.setKTX2Loader(s),Wn}(i,this.manager);return t&&s.setPath(t),new Promise(((t,i)=>{s.load(e,(e=>t(e)),void 0,(t=>i(t)))}))}}class Xn extends t.BufferGeometry{constructor(e=1,i=.4,s=12,n=48){super();const r=[],o=[],a=[],h=[],l=new t.Vector3,c=new t.Vector3,d=new t.Vector3;for(let t=0;t<=s;t++)for(let r=0;r<=n;r++){const u=r/n*Math.PI/2,p=t/s*Math.PI+3*Math.PI/2;c.x=(e+i*Math.cos(p))*Math.cos(u),c.y=(e+i*Math.cos(p))*Math.sin(u),c.z=i*Math.sin(p),o.push(c.x,c.y,c.z),l.x=e*Math.cos(u),l.y=e*Math.sin(u),d.subVectors(c,l).normalize(),a.push(d.x,d.y,d.z),h.push(r/n),h.push(t/s)}for(let t=1;t<=s;t++)for(let e=1;e<=n;e++){const i=(n+1)*t+e-1,s=(n+1)*(t-1)+e-1,o=(n+1)*(t-1)+e,a=(n+1)*t+e;r.push(i,s,a),r.push(s,o,a)}this.setIndex(r),this.setAttribute("position",new t.Float32BufferAttribute(o,3)),this.setAttribute("normal",new t.Float32BufferAttribute(a,3)),this.setAttribute("uv",new t.Float32BufferAttribute(h,2))}}function Kn(e=1,i=1,s=.02,n=.03,r=5,o=5){const a=function(e=1,i=1,s=.01,n=.03,r=5,o=5){const a=new Xn(n,s/2,o,r).rotateX(Math.PI/2),h=a.clone().rotateY(2*Math.PI/2).translate(-(e/2-n),0,-(i/2-n)),l=a.clone().rotateY(3*Math.PI/2).translate(-(e/2-n),0,i/2-n),c=a.clone().rotateY(4*Math.PI/2).translate(e/2-n,0,i/2-n),d=a.rotateY(5*Math.PI/2).translate(e/2-n,0,-(i/2-n)),u=[h,l,c,d],p=new t.CylinderGeometry(s/2,s/2,e-2*n,o,1,!0,0,Math.PI).rotateZ(Math.PI/2),g=p.clone().rotateX(-Math.PI/2).translate(0,0,-i/2),m=p.rotateX(Math.PI/2).translate(0,0,i/2),f=new t.CylinderGeometry(s/2,s/2,i-2*n,o,1,!0,0,Math.PI).rotateX(-Math.PI/2),v=f.clone().rotateY(Math.PI).translate(-e/2,0,0),y=f.translate(e/2,0,0);return[...u,g,m,v,y]}(e,i,s,n,r,o),h=a.reduce(((t,e)=>t+e.index.count),0),l=function(e=1,i=1,s=.01,n=.03,r=5){const o=e-2*n,a=i-2*n,h=new t.PlaneGeometry(e,a).rotateX(-Math.PI/2),l=new t.PlaneGeometry(o,n).rotateX(-Math.PI/2),c=a/2+n/2,d=l.clone().translate(0,0,c),u=l.translate(0,0,-c),p=[h,d,u],g=new t.CircleGeometry(n,r,0,Math.PI/2).rotateX(-Math.PI/2),m=a/2,f=o/2,v=g.clone().rotateY(3*Math.PI/2).translate(f,0,m),y=g.clone().rotateY(0*Math.PI/2).translate(f,0,-m),w=g.clone().rotateY(1*Math.PI/2).translate(-f,0,-m),x=g.clone().rotateY(2*Math.PI/2).translate(-f,0,m),S=[...p,v,y,w,x],b=S.map((t=>t.clone().rotateX(Math.PI).translate(0,-s/2,0)));return S.forEach((t=>t.translate(0,s/2,0))),[...S,...b]}(e,i,s,n,r),d=l.reduce(((t,e)=>t+e.index.count),0),u=[...a,...l],p=c.mergeGeometries(u);return u.forEach((t=>t.dispose())),p.addGroup(0,h,0),p.addGroup(h,d,1),p.computeBoundingBox(),p}class $n extends t.Mesh{constructor(e,i,s){super(Kn(e,i,s),[new t.MeshLambertMaterial({color:16777215,transparent:!0,opacity:0}),new t.MeshLambertMaterial({color:16777215,transparent:!0,opacity:0})]),this.draggingMode=gs.TRANSLATING,this.opacity=new re(0,0,.5,0)}update(t){this.opacity.update(t),this.material[0].opacity=this.opacity.value,this.material[1].opacity=.5*this.opacity.value,this.visible=this.opacity.value>.001}}const Qn=new t.Vector2(.2,.2),Yn=new t.Vector3,Jn=new t.Quaternion,Zn=new t.Quaternion;class tr extends t.Object3D{constructor(){super(...arguments),this.draggingMode=ps.ROTATING}}class er extends t.Mesh{constructor(t,e){super(t,e),this.draggingMode=ps.ROTATING}}class ir extends S{static{this.dependencies={camera:t.Camera,depth:At,scene:t.Scene,renderer:t.WebGLRenderer}}constructor({castShadow:e=!0,receiveShadow:i=!0,raycastToChildren:s=!1}){super(),this.draggable=!0,this.rotatable=!0,this.scalable=!0,this.platformAnimationSpeed=2,this.platformThickness=.02,this.isOneOneScale=!1,this.initialScale=(new t.Vector3).setScalar(1),this.startAnimationOnLoad=!0,this.clipActions=[],this.clock=new t.Clock,this.hoveringControllers=new Set,this.occludableShaders=new Set,this.bbox=new t.Box3,this.castShadow=e,this.receiveShadow=i,this.raycastToChildren=s}async init({camera:t,depth:e,scene:i,renderer:s}){this.camera=t,this.depth=e,this.scene=i,this.renderer=s;for(const t of this.occludableShaders)this.depth.occludableShaders.add(t);this.splatMesh&&(await this.createSparkRendererIfNeeded(),this.scene.add(this.splatMesh))}async loadSplatModel({data:e,onSceneLoaded:i=t=>{},platformMargin:s=Qn,setupRaycastCylinder:n=!0,setupRaycastBox:r=!1,setupPlatform:o=!0}){this.data=e,e.scale&&this.initialScale.copy(e.scale);const a=await(new qn).loadSplat({url:e.model});return this.splatMesh=a,a.raycast=()=>{},this.splatAnchor=new tr,e.scale&&this.splatAnchor.scale.copy(e.scale),e.rotation&&this.splatAnchor.rotation.set(t.MathUtils.degToRad(e.rotation.x),t.MathUtils.degToRad(e.rotation.y),t.MathUtils.degToRad(e.rotation.z)),e.position&&this.splatAnchor.position.copy(e.position),this.add(this.splatAnchor),this.scene&&(await this.createSparkRendererIfNeeded(),this.scene.add(this.splatMesh)),await this.setupBoundingBox(!1!==e.verticallyAlignObject,!1!==e.horizontallyAlignObject),n?this.setupRaycastCylinder():r&&this.setupRaycastBox(),o&&this.setupPlatform(s),this.setCastShadow(this.castShadow),this.setReceiveShadow(this.receiveShadow),i?i(this.splatAnchor):this.splatAnchor}async loadGLTFModel({data:e,onSceneLoaded:i=()=>{},platformMargin:s=Qn,setupRaycastCylinder:n=!0,setupRaycastBox:r=!1,setupPlatform:o=!0,renderer:a,addOcclusionToShader:h=!1}){this.data=e,e.scale&&this.initialScale.copy(e.scale);const l=await(new qn).loadGLTF({path:e.path,url:e.model,renderer:a}),c=new t.AnimationMixer(l.scene);if(l.animations.forEach((t=>{this.startAnimationOnLoad?c.clipAction(t).play():this.clipActions.push(c.clipAction(t))})),l.scene.draggingMode=gs.ROTATING,this.gltfMesh=l,this.animationMixer=c,e.scale&&this.gltfMesh.scene.scale.copy(e.scale),e.rotation&&l.scene.rotation.set(t.MathUtils.degToRad(e.rotation.x),t.MathUtils.degToRad(e.rotation.y),t.MathUtils.degToRad(e.rotation.z)),e.position&&l.scene.position.copy(e.position),l.scene.draggingMode=gs.ROTATING,this.add(l.scene),await this.setupBoundingBox(!1!==e.verticallyAlignObject,!1!==e.horizontallyAlignObject),n?this.setupRaycastCylinder():r&&this.setupRaycastBox(),o&&this.setupPlatform(s),this.setCastShadow(this.castShadow),this.setReceiveShadow(this.receiveShadow),h){for(const t of this.platform?.material||[])t.onBeforeCompile=e=>{Ns.addOcclusionToShader(e),e.uniforms.occlusionEnabled.value=!0,t.userData.shader=e,this.occludableShaders.add(e),this.depth?.occludableShaders.add(e)};this.platform?.layers.enable(3),l.scene.traverse((t=>{if(t.isMesh){const e=t;(e.material instanceof Array?e.material:[e.material]).forEach((t=>{t.transparent=!0,t.onBeforeCompile=t=>{Ns.addOcclusionToShader(t),t.uniforms.occlusionEnabled.value=!0,this.occludableShaders.add(t),this.depth?.occludableShaders.add(t)}})),t.layers.enable(3)}}))}return i?i(l.scene):l.scene}async setupBoundingBox(e=!0,i=!0){if(this.splatMesh){const s=await this.splatMesh.getBoundingBox(!1);if(s.isEmpty())return void(this.bbox=s);this.splatAnchor.updateMatrix();const n=s.clone().applyMatrix4(this.splatAnchor.matrix),r=new t.Vector3;n.getCenter(r).multiplyScalar(-1),r.y=e?-n.min.y:0,i||(r.x=0,r.z=0),this.splatAnchor.position.add(r),this.bbox=n.translate(r)}else{const s=this.children.filter((t=>t!==this.platform&&t!==this.rotationRaycastMesh&&t!==this.controlBar));if(this.bbox=function(e){const i=new t.Box3;if(0===e.length)return i;const s=new Map;for(const t of e)t.parent&&(s.set(t,t.parent),t.removeFromParent()),i.expandByObject(t,!0);for(const[t,e]of s.entries())e.add(t);return i}(s),this.bbox.isEmpty())return;const n=new t.Vector3;this.bbox.getCenter(n).multiplyScalar(-1),n.y=e?-this.bbox.min.y:0,i||(n.x=0,n.z=0);for(const t of s)t.position.add(n);this.bbox.translate(n)}}setupRaycastCylinder(){const e=new t.Vector3;this.bbox.getSize(e);const i=.05+.5*Math.min(e.x,e.z),s=new er(new t.CylinderGeometry(i,i,e.y),new t.MeshBasicMaterial({color:10027008,wireframe:!0}));this.bbox.getCenter(s.position),this.rotationRaycastMesh=s,this.rotationRaycastMesh.visible=!1,this.add(this.rotationRaycastMesh)}setupRaycastBox(){this.rotationRaycastMesh&&(this.rotationRaycastMesh.removeFromParent(),this.rotationRaycastMesh.geometry.dispose(),this.rotationRaycastMesh.material.dispose());const e=new t.Vector3;this.bbox.getSize(e);const i=new er(new t.BoxGeometry(e.x,e.y,e.z),new t.MeshBasicMaterial({color:10027008,wireframe:!0}));this.bbox.getCenter(i.position),this.rotationRaycastMesh=i,this.rotationRaycastMesh.visible=!1,this.add(this.rotationRaycastMesh)}setupPlatform(e=Qn){const i=new t.Vector3;this.bbox.getSize(i);const s=i.x+e.x,n=i.z+e.y;this.platform=new $n(s,n,this.platformThickness);const r=new t.Vector3;this.bbox.getCenter(r),this.platform.position.set(r.x,-this.platformThickness/2,r.z),this.add(this.platform)}update(){this.splatMesh&&this.splatAnchor&&(this.updateMatrixWorld(!0),this.splatAnchor.matrixWorld.decompose(this.splatMesh.position,this.splatMesh.quaternion,this.splatMesh.scale));const t=this.clock.getDelta();this.animationMixer&&this.animationMixer.update(t),this.platform&&this.platform.update(t);const e=this.camera;if(null!=this.controlBar&&this.controlBar.parent==this&&null!=e){const t=Yn.copy(e.position).sub(this.position),i=t.length(),s=Math.asin(t.normalize().y);t.y=0,t.normalize(),Jn.copy(this.quaternion).invert(),this.controlBar.quaternion.setFromAxisAngle(as,s).premultiply(Zn.setFromUnitVectors(os,t)).premultiply(Jn),this.controlBar.position.setScalar(0).addScaledVector(t,.5).applyQuaternion(Jn),this.controlBar.position.y=0,this.controlBar.scale.set(i/this.scale.x,i/this.scale.y,i/this.scale.z)}}onObjectSelectStart(){return this.draggable||this.rotatable||this.scalable}onObjectSelectEnd(){return this.draggable||this.rotatable||this.scalable}onHoverEnter(t){this.hoveringControllers.add(t),this.platform&&(this.platform.opacity.speed=this.platformAnimationSpeed)}onHoverExit(t){this.hoveringControllers.delete(t),this.platform&&0==this.hoveringControllers.size&&(this.platform.opacity.speed=-this.platformAnimationSpeed)}raycast(t,e){const i=this.gltfMesh?.scene??this.splatMesh;if(this.raycastToChildren&&i){const i=[];for(const e of this.children)e!=this.rotationRaycastMesh&&e!=this.platform&&e!=this.controlBar&&t.intersectObject(e,!0,i);e.push(...i)}if(this.rotationRaycastMesh){const i=[];this.rotationRaycastMesh.raycast(t,i);for(const t of i)e.push(t)}if(this.platform){const i=[];this.platform.raycast(t,i);for(const t of i)e.push(t)}if(null!=this.controlBar&&this.controlBar.parent==this){const i=[];this.controlBar.raycast(t,i);for(const t of i)e.push(t)}return!1}onScaleButtonClick(){this.scale.setScalar(1)}setCastShadow(t){this.castShadow=t,this.gltfMesh&&this.gltfMesh.scene.traverse((function(e){e.castShadow=t})),this.platform&&(this.platform.castShadow=!1)}setReceiveShadow(t){this.receiveShadow=t,this.gltfMesh&&this.gltfMesh.scene.traverse((function(e){e.receiveShadow=t})),this.platform&&(this.platform.receiveShadow=t)}getOcclusionEnabled(){for(const t of this.occludableShaders)return t.uniforms.occlusionEnabled.value;return!1}setOcclusionEnabled(t){for(const e of this.occludableShaders)e.uniforms.occlusionEnabled.value=t}playClipAnimationOnce(){this.startAnimationOnLoad||0===this.clipActions.length||this.clipActions.forEach((e=>{e.reset(),e.clampWhenFinished=!0,e.loop=t.LoopOnce,e.play()}))}async createSparkRendererIfNeeded(){const{SparkRenderer:t}=await import("@sparkjsdev/spark");let e=!1;this.scene.traverse((i=>{e||=i instanceof t})),e||this.scene.add(new t({renderer:this.renderer,maxStdDev:Math.sqrt(5)}))}}class sr extends ji{static{this.dependencies={user:is}}constructor(){const e=document.createElement("canvas");e.width=1024,e.height=1024;const i=e.getContext("2d"),s=new t.CanvasTexture(e),n=new t.PlaneGeometry(.001*e.width,.001*e.height),r=new t.MeshBasicMaterial({map:s,toneMapped:!1,alphaTest:.01});super({},n,r),this.activeHand=-1,this.activeLine=[],this.activeLines=[],this.removedLines=[],this.isDrawing=!1,this.canvas=e,this.ctx=i,this.material=r,this.width=.001*e.width,this.height=.001*e.height,this.scale.set(this.width,this.height,1)}init({user:t}){super.init(),this.user=t,this.clearCanvas()}getContext(){return this.ctx}triggerUpdate(){this.material.map.needsUpdate=!0}onSelectStart(t){-1===this.activeHand&&(this.activeHand=t?.target?.userData?.id??-1,0!==this.activeHand&&1!==this.activeHand||(this.activeLine=[],this.ctx.beginPath()))}onSelectEnd(t){(t?.target?.userData?.id??-1)===this.activeHand&&(this.activeHand>=0&&this.activeLine.length>1&&(this.activeLines.push(this.activeLine),this.removedLines=[]),this.isDrawing=!1,this.activeLine=[],this.activeHand=-1)}onSelecting(t){const e=t.target.userData.id;if(e!==this.activeHand)return;const i=this.user.getReticleIntersection(e);if(i)if(i.object instanceof sr&&i.uv){const t=Math.round(1024*i.uv.x),e=Math.round(1024-1024*i.uv.y),s=this.ctx;this.isDrawing?(s.lineTo(t,e),s.strokeStyle="black",s.lineWidth=6,s.stroke(),this.triggerUpdate(),this.activeLine.push({x:t,y:e})):(this.activeLine.push({x:t,y:e,b:!0}),s.moveTo(t,e),this.isDrawing=!0)}else this.isDrawing=!1;else this.isDrawing=!1}clearCanvas(t=!0){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="#FFFFFF",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),t&&this.triggerUpdate()}removeAll(){this.activeLines=[],this.removedLines=[],this.clearCanvas()}undo(){if(0===this.activeLines.length)return;this.ctx=this.canvas.getContext("2d");const t=this.activeLines.pop();this.removedLines.push(t),this.clearCanvas(!1),this.activeLines.forEach((t=>{this.#n(t)})),this.triggerUpdate()}redo(){if(0===this.removedLines.length)return;const t=this.removedLines.pop();this.activeLines.push(t),this.#n(t),this.triggerUpdate()}#n(t){this.ctx.beginPath(),this.ctx.strokeStyle="black",this.ctx.lineWidth=6,t.forEach((t=>{t.b?this.ctx.moveTo(t.x,t.y):(this.ctx.lineTo(t.x,t.y),this.ctx.stroke())}))}update(){}}class nr extends Fn{constructor(){super(...arguments),this.localClippingPlanes=[new t.Plane(new t.Vector3(1,0,0),.5),new t.Plane(new t.Vector3(-1,0,0),.5)]}updateLayout(){super.updateLayout(),this.localClippingPlanes[0].constant=.5*this.rangeX,this.localClippingPlanes[1].constant=.5*this.rangeX}}class rr extends qi{constructor({pagerState:t}){super({text:""}),this.emptyPageIndicator="◦",this.currentPageIndicator="•",this.numberOfPages=0,this.previousPage=0,this.pagerState=t,this.previousPage=Math.round(t.currentPage),this.numberOfPages=t.pages,this.updateText()}update(){super.update();const t=Math.round(this.pagerState.currentPage);this.previousPage===t&&this.numberOfPages===this.pagerState.pages||this.updateText()}updateText(){const t=Math.round(this.pagerState.currentPage)%this.pagerState.pages,e=new Array(this.pagerState.pages).fill(this.emptyPageIndicator);e[t]=this.currentPageIndicator,this.setText(e.join("")),this.previousPage=t}}class or extends jt{constructor({videoFile:t,willCaptureFrequently:e=!1}={}){super({willCaptureFrequently:e}),this.videoFile_=t}async init(){await super.init(),this.videoFile_?(this.setState_(zt.INITIALIZING),await this.initStream_()):(console.warn("VideoFileStream initialized without a video file."),this.setState_(zt.IDLE))}async initStream_(){if(!this.videoFile_)throw new Error("No video file has been provided.");this.stop_(),this.video_.srcObject=null,this.video_.src="string"==typeof this.videoFile_?this.videoFile_:URL.createObjectURL(this.videoFile_),this.video_.loop=!0,this.video_.muted=!0,await new Promise(((t,e)=>{this.video_.onloadedmetadata=()=>{this.handleVideoStreamLoadedMetadata(t,e)},this.video_.onerror=()=>{const t=new Error("Error occurred while loading the video file.");this.setState_(zt.ERROR,{error:t}),e(t)},this.video_.play()})),this.setState_(zt.STREAMING,{width:this.width,height:this.height,aspectRatio:this.aspectRatio,videoFile:this.videoFile_})}async setSource(t){if(!t)return console.warn("setSource called with no file. Stopping stream."),this.stop_(),void(this.videoFile_=void 0);this.setState_(zt.INITIALIZING),this.videoFile_=t,await this.initStream_()}}export{$ as AI,F as AIOptions,Ae as AVERAGE_IPD_METERS,he as ActiveControllers,p as Agent,re as AnimatableNumber,bi as AudioListener,Ci as AudioPlayer,os as BACK,Mi as BackgroundMusic,Ei as CategoryVolumes,bs as Col,Us as Core,Bi as CoreSound,ot as DEFAULT_DEVICE_CAMERA_HEIGHT,rt as DEFAULT_DEVICE_CAMERA_WIDTH,ss as DOWN,At as Depth,yt as DepthMesh,wt as DepthMeshOptions,xt as DepthOptions,Tt as DepthTextures,Vs as DetectedObject,Fs as DetectedPlane,ct as DeviceCameraOptions,gs as DragManager,ps as DragMode,ms as ExitButton,rs as FORWARD,Gn as FreestandingSlider,oe as GazeController,W as Gemini,V as GeminiOptions,m as GenerateSkyboxTool,v as GetWeatherTool,fs as Grid,Z as HAND_BONE_IDX_CONNECTION_MAP,Y as HAND_JOINT_COUNT,J as HAND_JOINT_IDX_CONNECTION_MAP,Zt as HAND_JOINT_NAMES,te as Handedness,ee as Hands,pe as HandsOptions,nr as HorizontalPager,Xi as IconButton,Ki as IconView,$i as ImageView,ce as Input,Re as InputOptions,Le as Keycodes,as as LEFT,et as LEFT_VIEW_ONLY_LAYER,Qi as LabelView,de as Lighting,ge as LightingOptions,Es as LoadingSpinnerManager,Pn as MaterialSymbolsView,C as MeshScript,qn as ModelLoader,ir as ModelViewer,ae as MouseController,ve as NEXT_SIMULATOR_MODE,Q as NUM_HANDS,st as OCCLUDABLE_ITEMS_LAYER,Bs as ObjectDetector,be as ObjectsOptions,Pt as OcclusionPass,Ns as OcclusionUtils,X as OpenAI,B as OpenAIOptions,Ee as Options,rr as PageIndicator,Fn as Pager,Ln as PagerState,Ss as Panel,ys as PanelMesh,ue as Physics,me as PhysicsOptions,nn as PinchOnButtonAction,zs as PlaneDetector,Ce as PlanesOptions,hs as RIGHT,it as RIGHT_VIEW_ONLY_LAYER,Ut as Registry,se as Reticle,Me as ReticleOptions,er as RotationRaycastMesh,Ts as Row,ui as SIMULATOR_HAND_POSE_NAMES,ci as SIMULATOR_HAND_POSE_TO_JOINTS_LEFT,di as SIMULATOR_HAND_POSE_TO_JOINTS_RIGHT,_i as SOUND_PRESETS,Ht as ScreenshotSynthesizer,S as Script,w as ScriptMixin,Wt as ScriptsManager,jn as ScrollingTroikaTextView,si as SetSimulatorModeEvent,rn as ShowHandsAction,Si as Simulator,Oe as SimulatorCamera,He as SimulatorControlMode,Ve as SimulatorControllerState,ri as SimulatorControls,ai as SimulatorDepth,oi as SimulatorDepthMaterial,li as SimulatorHandPose,hi as SimulatorHandPoseChangeRequestEvent,fi as SimulatorHands,vi as SimulatorInterface,_e as SimulatorMediaDeviceInfo,fe as SimulatorMode,ye as SimulatorOptions,Ie as SimulatorRenderMode,yi as SimulatorScene,xi as SimulatorUser,$s as SimulatorUserAction,sr as SketchPanel,f as SkyboxAgent,Se as SoundOptions,Pi as SoundSynthesizer,Ii as SpatialAudio,Rs as SpatialPanel,Li as SpeechRecognizer,xe as SpeechRecognizerOptions,Vi as SpeechSynthesizer,we as SpeechSynthesizerOptions,tr as SplatAnchor,zt as StreamState,Ji as TextButton,On as TextScrollerState,qi as TextView,g as Tool,Ms as UI,nt as UI_OVERLAY_LAYER,ns as UP,y as UX,is as User,tt as VIEW_DEPTH_GAP,zn as VerticalPager,or as VideoFileStream,jt as VideoStream,Zi as VideoView,ji as View,Di as VolumeCategory,qt as WaitFrame,pn as WalkTowardsPanelAction,js as World,Te as WorldOptions,Qt as XRButton,kt as XRDeviceCamera,Jt as XREffects,Yt as XRPass,De as XRTransitionOptions,at as XR_BLOCKS_ASSETS_PATH,ls as ZERO_VECTOR3,wn as add,yn as ai,It as aspectRatios,wi as callInitWithDependencyInjection,T as clamp,Ks as clampRotationToAngle,gn as core,Ft as cropImage,qs as extractYaw,I as getColorHex,Cn as getDeltaTime,_ as getUrlParamBool,O as getUrlParamFloat,P as getUrlParamInt,E as getUrlParameter,A as getVec4ByColorString,Rn as getXrCameraLeft,Mn as getXrCameraRight,xn as init,Sn as initScript,R as lerp,_n as loadStereoImageAsTextures,_s as loadingSpinnerManager,Xs as lookAtRotation,ts as objectIsDescendantOf,ft as onDesktopUserAgent,L as parseBase64DataURL,Ls as placeObjectAtIntersectionFacingTarget,M as print,Lt as rgbToDepthParams,mn as scene,Dn as showOnlyInLeftEye,En as showOnlyInRightEye,Tn as showReticleOnDepthMesh,Vt as transformRgbToDepthUv,Bt as transformRgbUvToWorld,es as traverseUtil,bn as uninitScript,D as urlParams,fn as user,vn as world,St as xrDepthMeshOptions,Ct as xrDepthMeshPhysicsOptions,bt as xrDepthMeshVisualizationOptions,gt as xrDeviceCameraEnvironmentContinuousOptions,ut as xrDeviceCameraEnvironmentOptions,mt as xrDeviceCameraUserContinuousOptions,pt as xrDeviceCameraUserOptions};
//# sourceMappingURL=xrblocks.min.js.map
